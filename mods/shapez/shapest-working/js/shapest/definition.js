import { BasicSerializableObject, COLOR_ITEM_SINGLETONS, globalConfig, LogicGateSystem, makeOffscreenBuffer, ShapeDefinition, smoothenDpi, THEME, types } from "../shapez.js";
import { SzInfo, SzLayer } from "./layer.js";
import { SzContext2D } from "./SzContext2D.js";
export class SzDefinition extends BasicSerializableObject {
    static getId() {
        return "sz-definition";
    }
    static createTest() {
        return new SzDefinition({
            layers: [SzLayer.createTest()],
        });
    }
    constructor(data, clone = false) {
        super();
        if (typeof data == 'string')
            return SzDefinition.fromShortKey(data);
        if (data?.layers)
            this.layers = data.layers.map((e, i) => new SzLayer(e, i));
        if (!this.layers.every(e => e.isNormalized())) {
            this.layers = SzDefinition.createTest().layers;
        }
        // console.log(this.getHash())
        if (clone)
            return;
        if (SzDefinition.definitionCache.has(this.getHash())) {
            return SzDefinition.definitionCache.get(this.getHash());
        }
        console.log(this.getHash());
    }
    layers = [];
    cachedHash = '';
    bufferGenerator;
    getClonedLayers() {
        throw new Error("Method not implemented.");
    }
    isEntirelyEmpty() {
        return this.layers.every(e => e.isEmpty());
    }
    getHash() {
        if (this.cachedHash)
            return this.cachedHash;
        if (!this.layers.length)
            debugger;
        return this.cachedHash = this.layers.map(e => e.getHash()).join(':');
    }
    drawFullSizeOnCanvas(context, size) {
        this.internalGenerateShapeBuffer(null, context, size, size, 1);
    }
    generateAsCanvas(size = 120) {
        const [canvas, context] = makeOffscreenBuffer(size, size, {
            smooth: true,
            label: "definition-canvas-cache-" + this.getHash(),
            reusable: false,
        });
        this.internalGenerateShapeBuffer(canvas, context, size, size, 1);
        return canvas;
    }
    cloneFilteredByQuadrants(includeQuadrants) {
        let layers = this.layers.map(e => e.cloneFilteredByQuadrants(includeQuadrants)).filter(e => !e.isEmpty());
        return new SzDefinition({ layers });
    }
    cloneRotateCW() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(6))
        });
    }
    cloneRotate24(n) {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(n))
        });
    }
    cloneRotateCCW() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(24 - 6))
        });
    }
    cloneRotate180() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(12))
        });
    }
    cloneAndStackWith(upper) {
        let bottom = this.clone(e => e.removeCover()).layers;
        let top = upper.clone().layers;
        let dh = 0;
        while (!bottom.every((l, i) => {
            return l.canStackWith(top[i - dh]);
        }))
            dh++;
        let overlap = bottom.length - dh;
        let newLayers = bottom.map((l, i) => {
            return l.stackWith(top[i + dh]);
        }).concat(top.slice(overlap));
        return new SzDefinition({ layers: newLayers.slice(0, 4) });
    }
    cloneAndPaintWith(color) {
        let rawPaints = Array(24).fill(color);
        return this.clone((l, i, a) => {
            let paints = a.slice(i).reduceRight((v, e) => e.filterPaint(v), rawPaints);
            return l.removeCover().paint(paints);
        });
    }
    cloneAndPaintWith4Colors(colors) {
        let rawPaints = Array.from({ length: 24 }, (e, i) => {
            return colors[i % 6];
        });
        return this.clone((l, i, a) => {
            let paints = a.slice(i).reduceRight((v, e) => e.filterPaint(v), rawPaints);
            return l.removeCover().paint(paints);
        });
    }
    cloneAndMakeCover() {
        return new SzDefinition({ layers: this.layers.map(e => e.cloneAsCover()) });
    }
    clone(layerMapper) {
        if (layerMapper) {
            return new SzDefinition({
                layers: this.layers.map(e => e.clone()).flatMap((e, i, a) => {
                    return layerMapper(e, i, a) || [];
                }).filter(e => !e.isEmpty())
            });
        }
        return new SzDefinition(this, true);
    }
    static getSchema() {
        return types.string;
    }
    serialize() {
        return this.getHash();
    }
    deserialize(data, root) {
        console.log('deser', this);
    }
    // inherited
    drawCentered(x, y, parameters, diameter) {
        const dpi = smoothenDpi(globalConfig.shapesSharpness * parameters.zoomLevel);
        if (!this.bufferGenerator) {
            this.bufferGenerator = this.internalGenerateShapeBuffer.bind(this);
        }
        const key = diameter + "/" + dpi + "/" + this.cachedHash;
        const canvas = parameters.root.buffers.getForKey({
            key: "shapedef",
            subKey: key,
            w: diameter,
            h: diameter,
            dpi,
            redrawMethod: this.bufferGenerator,
        });
        parameters.context.drawImage(canvas, x - diameter / 2, y - diameter / 2, diameter, diameter);
    }
    internalGenerateShapeBuffer(canvas, ctx, w, h, dpi) {
        // prepare context
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 0.05;
        ctx.translate((w * dpi) / 2, (h * dpi) / 2);
        ctx.scale((dpi * w) / 2.3, (dpi * h) / 2.3);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = THEME.items.outline;
        ctx.lineWidth = THEME.items.outlineWidth / 10;
        ctx.rotate(-Math.PI / 2);
        ctx.fillStyle = THEME.items.circleBackground;
        ctx.beginPath();
        ctx.arc(0, 0, 1.15, 0, 2 * Math.PI);
        ctx.fill();
        let sCtx = new SzContext2D(ctx);
        this.layers.forEach((l, i) => l.drawCenteredLayerScaled(sCtx, i));
    }
    static rawHashMap = new Map();
    static getHashfromRawHash(hash) {
        if (!this.rawHashMap.has(hash)) {
            this.rawHashMap.set(hash, hash.startsWith('sz!') ? SzDefinition.fromShortKey(hash).getHash() :
                SzDefinition.fromRawShape(hash).getHash());
        }
        return this.rawHashMap.get(hash);
    }
    static fromRawShape(shapeDefinition) {
        if (typeof shapeDefinition != 'string')
            shapeDefinition = shapeDefinition.getHash();
        return new SzDefinition({
            layers: shapeDefinition.split(':').map(e => SzLayer.fromShortKey(e))
        });
    }
    static definitionCache = new Map();
    static fromShortKey(key) {
        if (!this.definitionCache.has(key)) {
            this.definitionCache.set(key, new SzDefinition({
                layers: key.split(':').map(e => SzLayer.fromShortKey(e))
            }));
        }
        return this.definitionCache.get(key);
    }
    compute_ANALYZE(root) {
        let firstQuad = this.layers[0].quads[0];
        if (firstQuad.from != 0)
            return [null, null];
        let definition = new SzDefinition({ layers: [SzInfo.quad.exampleLayer(firstQuad.shape)] });
        // @ts-expect-error
        let color = enumShortcodeToColor[SzInfo.color.byName[firstQuad.color].code];
        return [
            COLOR_ITEM_SINGLETONS[color],
            root.shapeDefinitionMgr.getShapeItemFromDefinition(definition),
        ];
    }
    static install(mod) {
        mod.modInterface.extendObject(ShapeDefinition, ({ $old }) => ({
            fromShortKey: SzDefinition.fromShortKey.bind(SzDefinition)
        }));
        mod.modInterface.extendClass(LogicGateSystem, ({ $old }) => ({
            compute_ANALYZE(parameters) {
                let item = parameters[0];
                if (!item || item.getItemType() !== "shape") {
                    // Not a shape
                    return [null, null];
                }
                let def = item.definition;
                if (def instanceof SzDefinition) {
                    return def.compute_ANALYZE(this.root);
                }
                return $old.compute_ANALYZE.call(this, parameters);
            }
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmaW5pdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zaGFwZXN0L2RlZmluaXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFZLHVCQUF1QixFQUFFLHFCQUFxQixFQUE0QixZQUFZLEVBQUUsZUFBZSxFQUFFLG1CQUFtQixFQUFPLGVBQWUsRUFBeUIsV0FBVyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDOU8sT0FBTyxFQUFTLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDcEQsT0FBTyxFQUFxQixXQUFXLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUdsRSxNQUFNLE9BQU8sWUFBYSxTQUFRLHVCQUF1QjtJQUN4RCxNQUFNLENBQUMsS0FBSztRQUNYLE9BQU8sZUFBZSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxNQUFNLENBQUMsVUFBVTtRQUNoQixPQUFPLElBQUksWUFBWSxDQUFDO1lBQ3ZCLE1BQU0sRUFBRSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUM5QixDQUFDLENBQUM7SUFDSixDQUFDO0lBSUQsWUFBWSxJQUFvRCxFQUFFLEtBQUssR0FBRyxLQUFLO1FBQzlFLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxPQUFPLElBQUksSUFBSSxRQUFRO1lBQUUsT0FBTyxZQUFZLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BFLElBQUksSUFBSSxFQUFFLE1BQU07WUFBRSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFF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a0JBQWtCLENBQUMsMEJBQTBCLENBQUMsVUFBVSxDQUFDO1NBQzlELENBQUM7SUFDSCxDQUFDO0lBSUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFRO1FBQ3RCLEdBQUcsQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLGVBQWUsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDN0QsWUFBWSxFQUFFLFlBQVksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQztTQUMxRCxDQUFDLENBQUMsQ0FBQztRQUVKLEdBQUcsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLGVBQWUsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDNUQsZUFBZSxDQUFDLFVBQWU7Z0JBQzlCLElBQUksSUFBSSxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekIsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssT0FBTyxFQUFFO29CQUM1QyxjQUFjO29CQUNkLE9BQU8sQ0FBQyxJQUF1QixFQUFFLElBQXVCLENBQUMsQ0FBQztpQkFDMUQ7Z0JBQ0QsSUFBSSxHQUFHLEdBQUksSUFBa0IsQ0FBQyxVQUFVLENBQUM7Z0JBQ3pDLElBQUksR0FBRyxZQUFZLFlBQVksRUFBRTtvQkFDaEMsT0FBTyxHQUFHLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFLLENBQVEsQ0FBQztpQkFDOUM7Z0JBQ0QsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDcEQsQ0FBQztTQUNELENBQUMsQ0FBQyxDQUFBO0lBRUosQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgeyBvdmVycmlkZSwgc3RyVG9IIH0gZnJvbSBcIi4uL3R5cGVzL2NvbW1vbi5qc1wiO1xyXG5pbXBvcnQgeyBCYXNlSXRlbSwgQmFzaWNTZXJpYWxpemFibGVPYmplY3QsIENPTE9SX0lURU1fU0lOR0xFVE9OUywgRHJhd1BhcmFtZXRlcnMsIEdhbWVSb290LCBnbG9iYWxDb25maWcsIExvZ2ljR2F0ZVN5c3RlbSwgbWFrZU9mZnNjcmVlbkJ1ZmZlciwgTW9kLCBTaGFwZURlZmluaXRpb24sIFNoYXBlSXRlbSwgU2hhcGVMYXllciwgc21vb3RoZW5EcGksIFRIRU1FLCB0eXBlcyB9IGZyb20gXCIuLi9zaGFwZXouanNcIjtcclxuaW1wb3J0IHsgY29sb3IsIFN6SW5mbywgU3pMYXllciB9IGZyb20gXCIuL2xheWVyLmpzXCI7XHJcbmltcG9ydCB7IHJtb2RlLCByb3RhdGlvbjI0LCBTekNvbnRleHQyRCB9IGZyb20gXCIuL1N6Q29udGV4dDJELmpzXCI7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFN6RGVmaW5pdGlvbiBleHRlbmRzIEJhc2ljU2VyaWFsaXphYmxlT2JqZWN0IGltcGxlbWVudHMgU2hhcGVEZWZpbml0aW9uIHtcclxuXHRzdGF0aWMgZ2V0SWQoKSB7XHJcblx0XHRyZXR1cm4gXCJzei1kZWZpbml0aW9uXCI7XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgY3JlYXRlVGVzdCgpIHtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0bGF5ZXJzOiBbU3pMYXllci5jcmVhdGVUZXN0KCldLFxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHJcblxyXG5cdGNvbnN0cnVjdG9yKGRhdGE/OiB7IGxheWVyczogU3pMYXllcltdIH0gfCBTekRlZmluaXRpb24gfCBzdHJpbmcsIGNsb25lID0gZmFsc2UpIHtcclxuXHRcdHN1cGVyKCk7XHJcblx0XHRpZiAodHlwZW9mIGRhdGEgPT0gJ3N0cmluZycpIHJldHVybiBTekRlZmluaXRpb24uZnJvbVNob3J0S2V5KGRhdGEpO1xyXG5cdFx0aWYgKGRhdGE/LmxheWVycykgdGhpcy5sYXllcnMgPSBkYXRhLmxheWVycy5tYXAoKGUsIGkpID0+IG5ldyBTekxheWVyKGUsIGkpKTtcclxuXHRcdGlmICghdGhpcy5sYXllcnMuZXZlcnkoZSA9PiBlLmlzTm9ybWFsaXplZCgpKSkge1xyXG5cdFx0XHR0aGlzLmxheWVycyA9IFN6RGVmaW5pdGlvbi5jcmVhdGVUZXN0KCkubGF5ZXJzO1xyXG5cdFx0fVxyXG5cdFx0Ly8gY29uc29sZS5sb2codGhpcy5nZXRIYXNoKCkpXHJcblx0XHRpZiAoY2xvbmUpIHJldHVybjtcclxuXHRcdGlmIChTekRlZmluaXRpb24uZGVmaW5pdGlvbkNhY2hlLmhhcyh0aGlzLmdldEhhc2goKSkpIHtcclxuXHRcdFx0cmV0dXJuIFN6RGVmaW5pdGlvbi5kZWZpbml0aW9uQ2FjaGUuZ2V0KHRoaXMuZ2V0SGFzaCgpKSE7XHJcblx0XHR9XHJcblx0XHRjb25zb2xlLmxvZyh0aGlzLmdldEhhc2goKSk7XHJcblx0fVxyXG5cclxuXHJcblxyXG5cdGxheWVyczogU3pMYXllcltdID0gW107XHJcblx0Y2FjaGVkSGFzaDogc3RyaW5nID0gJyc7XHJcblx0YnVmZmVyR2VuZXJhdG9yOiBhbnk7XHJcblx0Z2V0Q2xvbmVkTGF5ZXJzKCk6IFNoYXBlTGF5ZXJbXSB7XHJcblx0XHR0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcclxuXHR9XHJcblx0aXNFbnRpcmVseUVtcHR5KCk6IGJvb2xlYW4ge1xyXG5cdFx0cmV0dXJuIHRoaXMubGF5ZXJzLmV2ZXJ5KGUgPT4gZS5pc0VtcHR5KCkpO1xyXG5cdH1cclxuXHRnZXRIYXNoKCk6IHN0cmluZyB7XHJcblx0XHRpZiAodGhpcy5jYWNoZWRIYXNoKSByZXR1cm4gdGhpcy5jYWNoZWRIYXNoO1xyXG5cdFx0aWYgKCF0aGlzLmxheWVycy5sZW5ndGgpIGRlYnVnZ2VyO1xyXG5cdFx0cmV0dXJuIHRoaXMuY2FjaGVkSGFzaCA9IHRoaXMubGF5ZXJzLm1hcChlID0+IGUuZ2V0SGFzaCgpKS5qb2luKCc6Jyk7XHJcblx0fVxyXG5cdGRyYXdGdWxsU2l6ZU9uQ2FudmFzKGNvbnRleHQ6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgc2l6ZTogbnVtYmVyKTogdm9pZCB7XHJcblx0XHR0aGlzLmludGVybmFsR2VuZXJhdGVTaGFwZUJ1ZmZlcihudWxsIGFzIGFueSwgY29udGV4dCwgc2l6ZSwgc2l6ZSwgMSk7XHJcblx0fVxyXG5cdGdlbmVyYXRlQXNDYW52YXMoc2l6ZSA9IDEyMCkge1xyXG5cdFx0Y29uc3QgW2NhbnZhcywgY29udGV4dF0gPSBtYWtlT2Zmc2NyZWVuQnVmZmVyKHNpemUsIHNpemUsIHtcclxuXHRcdFx0c21vb3RoOiB0cnVlLFxyXG5cdFx0XHRsYWJlbDogXCJkZWZpbml0aW9uLWNhbnZhcy1jYWNoZS1cIiArIHRoaXMuZ2V0SGFzaCgpLFxyXG5cdFx0XHRyZXVzYWJsZTogZmFsc2UsXHJcblx0XHR9KTtcclxuXHJcblx0XHR0aGlzLmludGVybmFsR2VuZXJhdGVTaGFwZUJ1ZmZlcihjYW52YXMsIGNvbnRleHQsIHNpemUsIHNpemUsIDEpO1xyXG5cdFx0cmV0dXJuIGNhbnZhcztcclxuXHR9XHJcblx0Y2xvbmVGaWx0ZXJlZEJ5UXVhZHJhbnRzKGluY2x1ZGVRdWFkcmFudHM6IG51bWJlcltdKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdGxldCBsYXllcnMgPSB0aGlzLmxheWVycy5tYXAoZSA9PiBlLmNsb25lRmlsdGVyZWRCeVF1YWRyYW50cyhpbmNsdWRlUXVhZHJhbnRzKSkuZmlsdGVyKGUgPT4gIWUuaXNFbXB0eSgpKTtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHsgbGF5ZXJzIH0pO1xyXG5cdH1cclxuXHRjbG9uZVJvdGF0ZUNXKCk6IFNoYXBlRGVmaW5pdGlvbiB7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7XHJcblx0XHRcdGxheWVyczogdGhpcy5sYXllcnMubWFwKGwgPT4gbC5jbG9uZSgpLnJvdGF0ZSg2KSlcclxuXHRcdH0pO1xyXG5cdH1cclxuXHRjbG9uZVJvdGF0ZTI0KG46IHJvdGF0aW9uMjQpOiBTekRlZmluaXRpb24ge1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRsYXllcnM6IHRoaXMubGF5ZXJzLm1hcChsID0+IGwuY2xvbmUoKS5yb3RhdGUobikpXHJcblx0XHR9KTtcclxuXHR9XHJcblx0Y2xvbmVSb3RhdGVDQ1coKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0bGF5ZXJzOiB0aGlzLmxheWVycy5tYXAobCA9PiBsLmNsb25lKCkucm90YXRlKDI0IC0gNikpXHJcblx0XHR9KTtcclxuXHR9XHJcblx0Y2xvbmVSb3RhdGUxODAoKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0bGF5ZXJzOiB0aGlzLmxheWVycy5tYXAobCA9PiBsLmNsb25lKCkucm90YXRlKDEyKSlcclxuXHRcdH0pO1xyXG5cdH1cclxuXHRjbG9uZUFuZFN0YWNrV2l0aCh1cHBlcjogU3pEZWZpbml0aW9uKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdGxldCBib3R0b20gPSB0aGlzLmNsb25lKGUgPT4gZS5yZW1vdmVDb3ZlcigpKS5sYXllcnM7XHJcblx0XHRsZXQgdG9wID0gdXBwZXIuY2xvbmUoKS5sYXllcnM7XHJcblx0XHRsZXQgZGggPSAwO1xyXG5cdFx0d2hpbGUgKCFib3R0b20uZXZlcnkoKGwsIGkpID0+IHtcclxuXHRcdFx0cmV0dXJuIGwuY2FuU3RhY2tXaXRoKHRvcFtpIC0gZGhdKTtcclxuXHRcdH0pKSBkaCsrO1xyXG5cdFx0bGV0IG92ZXJsYXAgPSBib3R0b20ubGVuZ3RoIC0gZGg7XHJcblx0XHRsZXQgbmV3TGF5ZXJzID0gYm90dG9tLm1hcCgobCwgaSkgPT4ge1xyXG5cdFx0XHRyZXR1cm4gbC5zdGFja1dpdGgodG9wW2kgKyBkaF0pO1xyXG5cdFx0fSkuY29uY2F0KHRvcC5zbGljZShcclxuXHRcdFx0b3ZlcmxhcFxyXG5cdFx0KSk7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7IGxheWVyczogbmV3TGF5ZXJzLnNsaWNlKDAsIDQpIH0pO1xyXG5cdH1cclxuXHJcblx0Y2xvbmVBbmRQYWludFdpdGgoY29sb3I6IGNvbG9yKTogU3pEZWZpbml0aW9uIHtcclxuXHRcdGxldCByYXdQYWludHMgPSBBcnJheTxjb2xvciB8IG51bGw+KDI0KS5maWxsKGNvbG9yKTtcclxuXHRcdHJldHVybiB0aGlzLmNsb25lKChsLCBpLCBhKSA9PiB7XHJcblx0XHRcdGxldCBwYWludHMgPSBhLnNsaWNlKGkpLnJlZHVjZVJpZ2h0KCh2LCBlKSA9PiBlLmZpbHRlclBhaW50KHYpLCByYXdQYWludHMpO1xyXG5cdFx0XHRyZXR1cm4gbC5yZW1vdmVDb3ZlcigpLnBhaW50KHBhaW50cyk7XHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdGNsb25lQW5kUGFpbnRXaXRoNENvbG9ycyhjb2xvcnM6IFtzdHJpbmcsIHN0cmluZywgc3RyaW5nLCBzdHJpbmddKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdGxldCByYXdQYWludHM6IChjb2xvciB8IG51bGwpW10gPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiAyNCB9LCAoZSwgaSkgPT4ge1xyXG5cdFx0XHRyZXR1cm4gY29sb3JzW2kgJSA2XSBhcyBhbnk7XHJcblx0XHR9KVxyXG5cdFx0cmV0dXJuIHRoaXMuY2xvbmUoKGwsIGksIGEpID0+IHtcclxuXHRcdFx0bGV0IHBhaW50cyA9IGEuc2xpY2UoaSkucmVkdWNlUmlnaHQoKHYsIGUpID0+IGUuZmlsdGVyUGFpbnQodiksIHJhd1BhaW50cyk7XHJcblx0XHRcdHJldHVybiBsLnJlbW92ZUNvdmVyKCkucGFpbnQocGFpbnRzKTtcclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblx0Y2xvbmVBbmRNYWtlQ292ZXIoKSB7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7IGxheWVyczogdGhpcy5sYXllcnMubWFwKGUgPT4gZS5jbG9uZUFzQ292ZXIoKSkgfSlcclxuXHR9XHJcblxyXG5cclxuXHRjbG9uZShsYXllck1hcHBlcj86IChsYXllcjogU3pMYXllciwgaTogbnVtYmVyLCBhOiBTekxheWVyW10pID0+IFN6TGF5ZXIgfCBTekxheWVyW10gfCBudWxsKSB7XHJcblx0XHRpZiAobGF5ZXJNYXBwZXIpIHtcclxuXHRcdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRcdGxheWVyczogdGhpcy5sYXllcnMubWFwKGUgPT4gZS5jbG9uZSgpKS5mbGF0TWFwKChlLCBpLCBhKSA9PiB7XHJcblx0XHRcdFx0XHRyZXR1cm4gbGF5ZXJNYXBwZXIoZSwgaSwgYSkgfHwgW107XHJcblx0XHRcdFx0fSkuZmlsdGVyKGUgPT4gIWUuaXNFbXB0eSgpKVxyXG5cdFx0XHR9KTtcclxuXHRcdH1cclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHRoaXMsIHRydWUpO1xyXG5cdH1cclxuXHJcblx0c3RhdGljIGdldFNjaGVtYSgpIHtcclxuXHRcdHJldHVybiB0eXBlcy5zdHJpbmc7XHJcblx0fVxyXG5cdHNlcmlhbGl6ZSgpIHtcclxuXHRcdHJldHVybiB0aGlzLmdldEhhc2goKTtcclxuXHR9XHJcblx0ZGVzZXJpYWxpemUoZGF0YTogYW55LCByb290PzogR2FtZVJvb3QpOiBzdHJpbmcgfCB2b2lkIHtcclxuXHRcdGNvbnNvbGUubG9nKCdkZXNlcicsIHRoaXMpO1xyXG5cdH1cclxuXHJcblxyXG5cclxuXHJcblx0Ly8gaW5oZXJpdGVkXHJcblx0ZHJhd0NlbnRlcmVkKHg6IG51bWJlciwgeTogbnVtYmVyLCBwYXJhbWV0ZXJzOiBEcmF3UGFyYW1ldGVycywgZGlhbWV0ZXI6IG51bWJlcik6IHZvaWQge1xyXG5cdFx0Y29uc3QgZHBpID0gc21vb3RoZW5EcGkoZ2xvYmFsQ29uZmlnLnNoYXBlc1NoYXJwbmVzcyAqIHBhcmFtZXRlcnMuem9vbUxldmVsKTtcclxuXHRcdGlmICghdGhpcy5idWZmZXJHZW5lcmF0b3IpIHtcclxuXHRcdFx0dGhpcy5idWZmZXJHZW5lcmF0b3IgPSB0aGlzLmludGVybmFsR2VuZXJhdGVTaGFwZUJ1ZmZlci5iaW5kKHRoaXMpO1xyXG5cdFx0fVxyXG5cdFx0Y29uc3Qga2V5ID0gZGlhbWV0ZXIgKyBcIi9cIiArIGRwaSArIFwiL1wiICsgdGhpcy5jYWNoZWRIYXNoO1xyXG5cdFx0Y29uc3QgY2FudmFzID0gcGFyYW1ldGVycy5yb290LmJ1ZmZlcnMuZ2V0Rm9yS2V5KHtcclxuXHRcdFx0a2V5OiBcInNoYXBlZGVmXCIsXHJcblx0XHRcdHN1YktleToga2V5LFxyXG5cdFx0XHR3OiBkaWFtZXRlcixcclxuXHRcdFx0aDogZGlhbWV0ZXIsXHJcblx0XHRcdGRwaSxcclxuXHRcdFx0cmVkcmF3TWV0aG9kOiB0aGlzLmJ1ZmZlckdlbmVyYXRvcixcclxuXHRcdH0pO1xyXG5cdFx0cGFyYW1ldGVycy5jb250ZXh0LmRyYXdJbWFnZShjYW52YXMsIHggLSBkaWFtZXRlciAvIDIsIHkgLSBkaWFtZXRlciAvIDIsIGRpYW1ldGVyLCBkaWFtZXRlcik7XHJcblx0fVxyXG5cclxuXHJcblx0aW50ZXJuYWxHZW5lcmF0ZVNoYXBlQnVmZmVyKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQsIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCB3OiBudW1iZXIsIGg6IG51bWJlciwgZHBpOiBudW1iZXIpOiB2b2lkIHtcclxuXHRcdC8vIHByZXBhcmUgY29udGV4dFxyXG5cdFx0Y3R4LmxpbmVDYXAgPSAncm91bmQnO1xyXG5cdFx0Y3R4LmxpbmVKb2luID0gJ3JvdW5kJztcclxuXHRcdGN0eC5saW5lV2lkdGggPSAwLjA1O1xyXG5cclxuXHRcdGN0eC50cmFuc2xhdGUoKHcgKiBkcGkpIC8gMiwgKGggKiBkcGkpIC8gMik7XHJcblx0XHRjdHguc2NhbGUoKGRwaSAqIHcpIC8gMi4zLCAoZHBpICogaCkgLyAyLjMpO1xyXG5cdFx0Y3R4LmxpbmVDYXAgPSAncm91bmQnO1xyXG5cdFx0Y3R4LmxpbmVKb2luID0gJ3JvdW5kJztcclxuXHRcdGN0eC5zdHJva2VTdHlsZSA9IFRIRU1FLml0ZW1zLm91dGxpbmU7XHJcblx0XHRjdHgubGluZVdpZHRoID0gVEhFTUUuaXRlbXMub3V0bGluZVdpZHRoIC8gMTA7XHJcblxyXG5cdFx0Y3R4LnJvdGF0ZSgtTWF0aC5QSSAvIDIpO1xyXG5cclxuXHRcdGN0eC5maWxsU3R5bGUgPSBUSEVNRS5pdGVtcy5jaXJjbGVCYWNrZ3JvdW5kO1xyXG5cdFx0Y3R4LmJlZ2luUGF0aCgpO1xyXG5cdFx0Y3R4LmFyYygwLCAwLCAxLjE1LCAwLCAyICogTWF0aC5QSSk7XHJcblx0XHRjdHguZmlsbCgpO1xyXG5cclxuXHRcdGxldCBzQ3R4ID0gbmV3IFN6Q29udGV4dDJEKGN0eCk7XHJcblx0XHR0aGlzLmxheWVycy5mb3JFYWNoKChsLCBpKSA9PiBsLmRyYXdDZW50ZXJlZExheWVyU2NhbGVkKHNDdHgsIGkpKTtcclxuXHJcblx0fVxyXG5cclxuXHRzdGF0aWMgcmF3SGFzaE1hcDogTWFwPHN0cmluZywgc3RyaW5nPiA9IG5ldyBNYXAoKTtcclxuXHRzdGF0aWMgZ2V0SGFzaGZyb21SYXdIYXNoKGhhc2g6IHN0cmluZykge1xyXG5cdFx0aWYgKCF0aGlzLnJhd0hhc2hNYXAuaGFzKGhhc2gpKSB7XHJcblx0XHRcdHRoaXMucmF3SGFzaE1hcC5zZXQoaGFzaCxcclxuXHRcdFx0XHRoYXNoLnN0YXJ0c1dpdGgoJ3N6IScpID8gU3pEZWZpbml0aW9uLmZyb21TaG9ydEtleShoYXNoKS5nZXRIYXNoKCkgOlxyXG5cdFx0XHRcdFx0U3pEZWZpbml0aW9uLmZyb21SYXdTaGFwZShoYXNoKS5nZXRIYXNoKClcclxuXHRcdFx0KVxyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIHRoaXMucmF3SGFzaE1hcC5nZXQoaGFzaCkhO1xyXG5cdH1cclxuXHJcblx0c3RhdGljIGZyb21SYXdTaGFwZShzaGFwZURlZmluaXRpb246IFNoYXBlRGVmaW5pdGlvbiB8IHN0cmluZykge1xyXG5cdFx0aWYgKHR5cGVvZiBzaGFwZURlZmluaXRpb24gIT0gJ3N0cmluZycpXHJcblx0XHRcdHNoYXBlRGVmaW5pdGlvbiA9IHNoYXBlRGVmaW5pdGlvbi5nZXRIYXNoKCk7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7XHJcblx0XHRcdGxheWVyczogc2hhcGVEZWZpbml0aW9uLnNwbGl0KCc6JykubWFwKGUgPT4gU3pMYXllci5mcm9tU2hvcnRLZXkoZSkpXHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdHN0YXRpYyBkZWZpbml0aW9uQ2FjaGU6IE1hcDxzdHJpbmcsIFN6RGVmaW5pdGlvbj4gPSBuZXcgTWFwKCk7XHJcblx0c3RhdGljIGZyb21TaG9ydEtleShrZXk6IHN0cmluZyk6IFN6RGVmaW5pdGlvbiB7XHJcblx0XHRpZiAoIXRoaXMuZGVmaW5pdGlvbkNhY2hlLmhhcyhrZXkpKSB7XHJcblx0XHRcdHRoaXMuZGVmaW5pdGlvbkNhY2hlLnNldChrZXksIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRcdGxheWVyczoga2V5LnNwbGl0KCc6JykubWFwKGUgPT4gU3pMYXllci5mcm9tU2hvcnRLZXkoZSkpXHJcblx0XHRcdH0pKTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB0aGlzLmRlZmluaXRpb25DYWNoZS5nZXQoa2V5KSE7XHJcblx0fVxyXG5cclxuXHRjb21wdXRlX0FOQUxZWkUocm9vdDogR2FtZVJvb3QpOiBbQmFzZUl0ZW0gfCBudWxsLCBCYXNlSXRlbSB8IG51bGxdIHtcclxuXHRcdGxldCBmaXJzdFF1YWQgPSB0aGlzLmxheWVyc1swXS5xdWFkc1swXTtcclxuXHRcdGlmIChmaXJzdFF1YWQuZnJvbSAhPSAwKSByZXR1cm4gW251bGwsIG51bGxdO1xyXG5cdFx0bGV0IGRlZmluaXRpb24gPSBuZXcgU3pEZWZpbml0aW9uKHsgbGF5ZXJzOiBbU3pJbmZvLnF1YWQuZXhhbXBsZUxheWVyKGZpcnN0UXVhZC5zaGFwZSldIH0pO1xyXG5cdFx0Ly8gQHRzLWV4cGVjdC1lcnJvclxyXG5cdFx0bGV0IGNvbG9yID0gZW51bVNob3J0Y29kZVRvQ29sb3JbU3pJbmZvLmNvbG9yLmJ5TmFtZVtmaXJzdFF1YWQuY29sb3JdLmNvZGVdO1xyXG5cdFx0cmV0dXJuIFtcclxuXHRcdFx0Q09MT1JfSVRFTV9TSU5HTEVUT05TW2NvbG9yXSxcclxuXHRcdFx0cm9vdC5zaGFwZURlZmluaXRpb25NZ3IuZ2V0U2hhcGVJdGVtRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbiksXHJcblx0XHRdO1xyXG5cdH1cclxuXHJcblxyXG5cclxuXHRzdGF0aWMgaW5zdGFsbChtb2Q6IE1vZCkge1xyXG5cdFx0bW9kLm1vZEludGVyZmFjZS5leHRlbmRPYmplY3QoU2hhcGVEZWZpbml0aW9uLCAoeyAkb2xkIH0pID0+ICh7XHJcblx0XHRcdGZyb21TaG9ydEtleTogU3pEZWZpbml0aW9uLmZyb21TaG9ydEtleS5iaW5kKFN6RGVmaW5pdGlvbilcclxuXHRcdH0pKTtcclxuXHJcblx0XHRtb2QubW9kSW50ZXJmYWNlLmV4dGVuZENsYXNzKExvZ2ljR2F0ZVN5c3RlbSwgKHsgJG9sZCB9KSA9PiAoe1xyXG5cdFx0XHRjb21wdXRlX0FOQUxZWkUocGFyYW1ldGVyczogYW55KSB7XHJcblx0XHRcdFx0bGV0IGl0ZW0gPSBwYXJhbWV0ZXJzWzBdO1xyXG5cdFx0XHRcdGlmICghaXRlbSB8fCBpdGVtLmdldEl0ZW1UeXBlKCkgIT09IFwic2hhcGVcIikge1xyXG5cdFx0XHRcdFx0Ly8gTm90IGEgc2hhcGVcclxuXHRcdFx0XHRcdHJldHVybiBbbnVsbCBhcyBhbnkgYXMgQmFzZUl0ZW0sIG51bGwgYXMgYW55IGFzIEJhc2VJdGVtXTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0bGV0IGRlZiA9IChpdGVtIGFzIFNoYXBlSXRlbSkuZGVmaW5pdGlvbjtcclxuXHRcdFx0XHRpZiAoZGVmIGluc3RhbmNlb2YgU3pEZWZpbml0aW9uKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gZGVmLmNvbXB1dGVfQU5BTFlaRSh0aGlzLnJvb3QhKSBhcyBhbnk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdHJldHVybiAkb2xkLmNvbXB1dGVfQU5BTFlaRS5jYWxsKHRoaXMsIHBhcmFtZXRlcnMpO1xyXG5cdFx0XHR9XHJcblx0XHR9KSlcclxuXHJcblx0fVxyXG59XHJcblxyXG4iXX0=