import { BaseItem, enumColorToShortcode, globalConfig, smoothenDpi, THEME, types } from "../shapez.js";
import { SzInfo } from "./layer.js";
import { SzContext2D } from "./SzContext2D.js";
const colorCharList = ['r', 'g', 'b', '-'];
const colorStringList = colorCharList.flatMap(a => colorCharList.flatMap(b => colorCharList.map(c => `${a}${b}${c}`)));
const colorStringEnum = Object.fromEntries(colorStringList.map(e => [e, e]));
export class SzColorItem extends BaseItem {
    color;
    static getId() {
        return "sz-color";
    }
    static getSchema() {
        return types.enum(colorStringEnum);
    }
    serialize() {
        return this.color;
    }
    deserialize(data) {
        this.color = data;
    }
    getItemType() {
        return "color";
    }
    getAsCopyableKey() {
        return this.color;
    }
    equalsImpl(other) {
        return this.color === other.color;
    }
    constructor(color) {
        super();
        this.color = color;
    }
    cachedSprite;
    getBackgroundColorAsResource() {
        return THEME.map.resources[SzInfo.color.byChar[this.color[0]].name];
    }
    drawFullSizeOnCanvas(context, size) {
        // if (!this.cachedSprite) {
        // 	this.cachedSprite = Loader.getSprite("sprites/colors/" + this.color + ".png");
        // }
        // this.cachedSprite.drawCentered(context, size / 2, size / 2, size);
    }
    drawItemCenteredImpl(x, y, parameters, diameter) {
        const dpi = smoothenDpi(globalConfig.shapesSharpness * parameters.zoomLevel);
        const key = diameter + "/" + dpi + "/" + this.color;
        const canvas = parameters.root.buffers.getForKey({
            key: "shapedef",
            subKey: key,
            w: diameter,
            h: diameter,
            dpi,
            redrawMethod: this.internalGenerateShapeBuffer.bind(this),
        });
        parameters.context.drawImage(canvas, x - diameter / 2, y - diameter / 2, diameter, diameter);
    }
    internalGenerateShapeBuffer(canvas, ctx, w, h, dpi) {
        // prepare context
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 0.05;
        ctx.translate((w * dpi) / 2, (h * dpi) / 2);
        ctx.scale((dpi * w) / 2.3, (dpi * h) / 2.3);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = THEME.items.outline;
        ctx.lineWidth = THEME.items.outlineWidth / 10;
        ctx.rotate(-Math.PI / 2);
        ctx.fillStyle = THEME.items.circleBackground;
        ctx.beginPath();
        ctx.arc(0, 0, 1.15, 0, 2 * Math.PI);
        ctx.fill();
        new SzContext2D(ctx).saved(ctx => {
            ctx.fillStyle = '#00000022';
            for (let c of this.color) {
                ctx.fillStyle = { r: 'red', g: 'green', b: 'blue', '-': '#eeeeee44' }[c];
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 0.05;
                ctx.beginPath().arc(0, 0.5, 0.3, 0, 24).fill().stroke();
                ctx.rotate(8);
            }
        });
    }
    static fromColor(color) {
        let c = enumColorToShortcode[color];
        return new SzColorItem(c + c + c);
    }
    splitColor() {
        let c = '-';
        let s = this.color.replace(/[^-]/, C => (c = C, '-'));
        const color = { r: 'red', g: 'green', b: 'blue', '-': '-' }[c];
        let item = s == '---' ? null : new SzColorItem(s);
        return [color, item];
    }
    fillFromColor(other) {
        let s1 = this.color, s2 = other.color;
        while (s1.includes('-') && s2 != '---') {
            let l1 = s1.lastIndexOf('-');
            let c = '-';
            s2 = s2.replace(/[^-]/, C => (c = C, '-'));
            s1 = s1.replace(/-(?!.*-)/, c);
        }
        return [new SzColorItem(s1), s2 == '---' ? null : new SzColorItem(s2)];
    }
    splitIntoColors() {
        const toc = (c) => SzInfo.color.byChar[c].name;
        let s = this.color.split('').filter(e => e != '-');
        if (s.length == 0)
            return ['grey', null];
        if (s.length == 1)
            return [toc(s[0]), null];
        if (s.length == 2)
            return [toc(s[0]), toc(s[1])];
        s = s.sort();
        let c = SzInfo.color.byCombo[s.sort().join('')].name;
        return [c, c];
    }
    static install(mod) {
        mod.modInterface.registerItem(SzColorItem, data => new SzColorItem(data));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sb3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2hhcGVzdC9jb2xvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQWUsUUFBUSxFQUF5QyxvQkFBb0IsRUFBRSxZQUFZLEVBQU8sV0FBVyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDaEssT0FBTyxFQUFpQyxNQUFNLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDbkUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRS9DLE1BQU0sYUFBYSxHQUFnQixDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ3hELE1BQU0sZUFBZSxHQUNwQixhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ3pCLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FDekIsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUNyQixHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3JDLE1BQU0sZUFBZSxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUc3RSxNQUFNLE9BQU8sV0FBWSxTQUFRLFFBQVE7SUFDeEMsS0FBSyxDQUFlO0lBQ3BCLE1BQU0sQ0FBQyxLQUFLO1FBQ1gsT0FBTyxVQUFVLENBQUM7SUFDbkIsQ0FBQztJQUNELE1BQU0sQ0FBQyxTQUFTO1FBQ2YsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFDRCxTQUFTO1FBQ1IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDO0lB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QUUsQ0FBQyxDQUFDLENBQUM7SUFDZixDQUFDO0lBRUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFRO1FBQ3RCLEdBQUcsQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDM0UsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IEF0bGFzU3ByaXRlLCBCYXNlSXRlbSwgQ29sb3JJdGVtLCBEcmF3UGFyYW1ldGVycywgZW51bUNvbG9ycywgZW51bUNvbG9yVG9TaG9ydGNvZGUsIGdsb2JhbENvbmZpZywgTW9kLCBzbW9vdGhlbkRwaSwgVEhFTUUsIHR5cGVzIH0gZnJvbSBcIi4uL3NoYXBlei5qc1wiO1xyXG5pbXBvcnQgeyBjb2xvciwgY29sb3JDaGFyLCBjb2xvclN0cmluZywgU3pJbmZvIH0gZnJvbSBcIi4vbGF5ZXIuanNcIjtcclxuaW1wb3J0IHsgU3pDb250ZXh0MkQgfSBmcm9tIFwiLi9TekNvbnRleHQyRC5qc1wiO1xyXG5cclxuY29uc3QgY29sb3JDaGFyTGlzdDogY29sb3JDaGFyW10gPSBbJ3InLCAnZycsICdiJywgJy0nXTtcclxuY29uc3QgY29sb3JTdHJpbmdMaXN0ID1cclxuXHRjb2xvckNoYXJMaXN0LmZsYXRNYXAoYSA9PlxyXG5cdFx0Y29sb3JDaGFyTGlzdC5mbGF0TWFwKGIgPT5cclxuXHRcdFx0Y29sb3JDaGFyTGlzdC5tYXAoYyA9PlxyXG5cdFx0XHRcdGAke2F9JHtifSR7Y31gIGFzIGNvbG9yU3RyaW5nKSkpO1xyXG5jb25zdCBjb2xvclN0cmluZ0VudW0gPSBPYmplY3QuZnJvbUVudHJpZXMoY29sb3JTdHJpbmdMaXN0Lm1hcChlID0+IFtlLCBlXSkpO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBTekNvbG9ySXRlbSBleHRlbmRzIEJhc2VJdGVtIGltcGxlbWVudHMgQ29sb3JJdGVtIHtcclxuXHRjb2xvciE6IGNvbG9yU3RyaW5nO1xyXG5cdHN0YXRpYyBnZXRJZCgpIHtcclxuXHRcdHJldHVybiBcInN6LWNvbG9yXCI7XHJcblx0fVxyXG5cdHN0YXRpYyBnZXRTY2hlbWEoKSB7XHJcblx0XHRyZXR1cm4gdHlwZXMuZW51bShjb2xvclN0cmluZ0VudW0pO1xyXG5cdH1cclxuXHRzZXJpYWxpemUoKSB7XHJcblx0XHRyZXR1cm4gdGhpcy5jb2xvcjtcclxuXHR9XHJcblx0ZGVzZXJpYWxpemUoZGF0YTogYW55KSB7XHJcblx0XHR0aGlzLmNvbG9yID0gZGF0YTtcclxuXHR9XHJcblx0Z2V0SXRlbVR5cGUoKSB7XHJcblx0XHRyZXR1cm4gXCJjb2xvclwiIGFzIGNvbnN0O1xyXG5cdH1cclxuXHRnZXRBc0NvcHlhYmxlS2V5KCkge1xyXG5cdFx0cmV0dXJuIHRoaXMuY29sb3I7XHJcblx0fVxyXG5cdGVxdWFsc0ltcGwob3RoZXI6IEJhc2VJdGVtKSB7XHJcblx0XHRyZXR1cm4gdGhpcy5jb2xvciA9PT0gKG90aGVyIGFzIGFueSBhcyBTekNvbG9ySXRlbSkuY29sb3I7XHJcblx0fVxyXG5cdGNvbnN0cnVjdG9yKGNvbG9yOiBjb2xvclN0cmluZykge1xyXG5cdFx0c3VwZXIoKTtcclxuXHRcdHRoaXMuY29sb3IgPSBjb2xvcjtcclxuXHR9XHJcblx0Y2FjaGVkU3ByaXRlITogQXRsYXNTcHJpdGU7XHJcblx0Z2V0QmFja2dyb3VuZENvbG9yQXNSZXNvdXJjZSgpIHtcclxuXHRcdHJldHVybiBUSEVNRS5tYXAucmVzb3VyY2VzW1xyXG5cdFx0XHRTekluZm8uY29sb3IuYnlDaGFyW3RoaXMuY29sb3JbMF1dLm5hbWVcclxuXHRcdF07XHJcblx0fVxyXG5cdGRyYXdGdWxsU2l6ZU9uQ2FudmFzKGNvbnRleHQ6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgc2l6ZTogbnVtYmVyKSB7XHJcblx0XHQvLyBpZiAoIXRoaXMuY2FjaGVkU3ByaXRlKSB7XHJcblx0XHQvLyBcdHRoaXMuY2FjaGVkU3ByaXRlID0gTG9hZGVyLmdldFNwcml0ZShcInNwcml0ZXMvY29sb3JzL1wiICsgdGhpcy5jb2xvciArIFwiLnBuZ1wiKTtcclxuXHRcdC8vIH1cclxuXHRcdC8vIHRoaXMuY2FjaGVkU3ByaXRlLmRyYXdDZW50ZXJlZChjb250ZXh0LCBzaXplIC8gMiwgc2l6ZSAvIDIsIHNpemUpO1xyXG5cdH1cclxuXHRkcmF3SXRlbUNlbnRlcmVkSW1wbCh4OiBudW1iZXIsIHk6IG51bWJlciwgcGFyYW1ldGVyczogRHJhd1BhcmFtZXRlcnMsIGRpYW1ldGVyOiBudW1iZXIpOiB2b2lkIHtcclxuXHRcdGNvbnN0IGRwaSA9IHNtb290aGVuRHBpKGdsb2JhbENvbmZpZy5zaGFwZXNTaGFycG5lc3MgKiBwYXJhbWV0ZXJzLnpvb21MZXZlbCk7XHJcblx0XHRjb25zdCBrZXkgPSBkaWFtZXRlciArIFwiL1wiICsgZHBpICsgXCIvXCIgKyB0aGlzLmNvbG9yO1xyXG5cdFx0Y29uc3QgY2FudmFzID0gcGFyYW1ldGVycy5yb290LmJ1ZmZlcnMuZ2V0Rm9yS2V5KHtcclxuXHRcdFx0a2V5OiBcInNoYXBlZGVmXCIsXHJcblx0XHRcdHN1YktleToga2V5LFxyXG5cdFx0XHR3OiBkaWFtZXRlcixcclxuXHRcdFx0aDogZGlhbWV0ZXIsXHJcblx0XHRcdGRwaSxcclxuXHRcdFx0cmVkcmF3TWV0aG9kOiB0aGlzLmludGVybmFsR2VuZXJhdGVTaGFwZUJ1ZmZlci5iaW5kKHRoaXMpLFxyXG5cdFx0fSk7XHJcblx0XHRwYXJhbWV0ZXJzLmNvbnRleHQuZHJhd0ltYWdlKGNhbnZhcywgeCAtIGRpYW1ldGVyIC8gMiwgeSAtIGRpYW1ldGVyIC8gMiwgZGlhbWV0ZXIsIGRpYW1ldGVyKTtcclxuXHJcblx0fVxyXG5cclxuXHJcblx0aW50ZXJuYWxHZW5lcmF0ZVNoYXBlQnVmZmVyKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQsIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCB3OiBudW1iZXIsIGg6IG51bWJlciwgZHBpOiBudW1iZXIpOiB2b2lkIHtcclxuXHRcdC8vIHByZXBhcmUgY29udGV4dFxyXG5cdFx0Y3R4LmxpbmVDYXAgPSAncm91bmQnO1xyXG5cdFx0Y3R4LmxpbmVKb2luID0gJ3JvdW5kJztcclxuXHRcdGN0eC5saW5lV2lkdGggPSAwLjA1O1xyXG5cclxuXHRcdGN0eC50cmFuc2xhdGUoKHcgKiBkcGkpIC8gMiwgKGggKiBkcGkpIC8gMik7XHJcblx0XHRjdHguc2NhbGUoKGRwaSAqIHcpIC8gMi4zLCAoZHBpICogaCkgLyAyLjMpO1xyXG5cdFx0Y3R4LmxpbmVDYXAgPSAncm91bmQnO1xyXG5cdFx0Y3R4LmxpbmVKb2luID0gJ3JvdW5kJztcclxuXHRcdGN0eC5zdHJva2VTdHlsZSA9IFRIRU1FLml0ZW1zLm91dGxpbmU7XHJcblx0XHRjdHgubGluZVdpZHRoID0gVEhFTUUuaXRlbXMub3V0bGluZVdpZHRoIC8gMTA7XHJcblxyXG5cdFx0Y3R4LnJvdGF0ZSgtTWF0aC5QSSAvIDIpO1xyXG5cclxuXHRcdGN0eC5maWxsU3R5bGUgPSBUSEVNRS5pdGVtcy5jaXJjbGVCYWNrZ3JvdW5kO1xyXG5cdFx0Y3R4LmJlZ2luUGF0aCgpO1xyXG5cdFx0Y3R4LmFyYygwLCAwLCAxLjE1LCAwLCAyICogTWF0aC5QSSk7XHJcblx0XHRjdHguZmlsbCgpO1xyXG5cclxuXHRcdG5ldyBTekNvbnRleHQyRChjdHgpLnNhdmVkKGN0eCA9PiB7XHJcblx0XHRcdGN0eC5maWxsU3R5bGUgPSAnIzAwMDAwMDIyJztcclxuXHRcdFx0Zm9yIChsZXQgYyBvZiB0aGlzLmNvbG9yKSB7XHJcblx0XHRcdFx0Y3R4LmZpbGxTdHlsZSA9IHsgcjogJ3JlZCcsIGc6ICdncmVlbicsIGI6ICdibHVlJywgJy0nOiAnI2VlZWVlZTQ0JyB9W2NdITtcclxuXHRcdFx0XHRjdHguc3Ryb2tlU3R5bGUgPSAnYmxhY2snO1xyXG5cdFx0XHRcdGN0eC5saW5lV2lkdGggPSAwLjA1O1xyXG5cdFx0XHRcdGN0eC5iZWdpblBhdGgoKS5hcmMoMCwgMC41LCAwLjMsIDAsIDI0KS5maWxsKCkuc3Ryb2tlKCk7XHJcblx0XHRcdFx0Y3R4LnJvdGF0ZSg4KTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgZnJvbUNvbG9yKGNvbG9yOiBlbnVtQ29sb3JzKSB7XHJcblx0XHRsZXQgYyA9IGVudW1Db2xvclRvU2hvcnRjb2RlW2NvbG9yXTtcclxuXHRcdHJldHVybiBuZXcgU3pDb2xvckl0ZW0oYyArIGMgKyBjIGFzIGFueSk7XHJcblx0fVxyXG5cclxuXHRzcGxpdENvbG9yKCk6IFtlbnVtQ29sb3JzLCBTekNvbG9ySXRlbSB8IG51bGxdIHtcclxuXHRcdGxldCBjID0gJy0nO1xyXG5cdFx0bGV0IHMgPSB0aGlzLmNvbG9yLnJlcGxhY2UoL1teLV0vLCBDID0+IChjID0gQywgJy0nKSk7XHJcblx0XHRjb25zdCBjb2xvciA9IHsgcjogJ3JlZCcsIGc6ICdncmVlbicsIGI6ICdibHVlJywgJy0nOiAnLScgfVtjXSE7XHJcblx0XHRsZXQgaXRlbSA9IHMgPT0gJy0tLScgPyBudWxsIDogbmV3IFN6Q29sb3JJdGVtKHMgYXMgYW55KTtcclxuXHRcdHJldHVybiBbY29sb3IsIGl0ZW1dO1xyXG5cdH1cclxuXHJcblx0ZmlsbEZyb21Db2xvcihvdGhlcjogU3pDb2xvckl0ZW0pOiBbU3pDb2xvckl0ZW0sIFN6Q29sb3JJdGVtIHwgbnVsbF0ge1xyXG5cdFx0bGV0IHMxOiBzdHJpbmcgPSB0aGlzLmNvbG9yLCBzMjogc3RyaW5nID0gb3RoZXIuY29sb3I7XHJcblx0XHR3aGlsZSAoczEuaW5jbHVkZXMoJy0nKSAmJiBzMiAhPSAnLS0tJykge1xyXG5cdFx0XHRsZXQgbDEgPSBzMS5sYXN0SW5kZXhPZignLScpO1xyXG5cdFx0XHRsZXQgYyA9ICctJztcclxuXHRcdFx0czIgPSBzMi5yZXBsYWNlKC9bXi1dLywgQyA9PiAoYyA9IEMsICctJykpO1xyXG5cdFx0XHRzMSA9IHMxLnJlcGxhY2UoLy0oPyEuKi0pLywgYyk7XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gW25ldyBTekNvbG9ySXRlbShzMSBhcyBhbnkpLCBzMiA9PSAnLS0tJyA/IG51bGwgOiBuZXcgU3pDb2xvckl0ZW0oczIgYXMgYW55KV07XHJcblx0fVxyXG5cclxuXHRzcGxpdEludG9Db2xvcnMoKTogW2NvbG9yLCBjb2xvciB8IG51bGxdIHtcclxuXHRcdGNvbnN0IHRvYyA9IChjOiBzdHJpbmcpID0+IFN6SW5mby5jb2xvci5ieUNoYXJbY10ubmFtZVxyXG5cdFx0bGV0IHMgPSB0aGlzLmNvbG9yLnNwbGl0KCcnKS5maWx0ZXIoZSA9PiBlICE9ICctJyk7XHJcblx0XHRpZiAocy5sZW5ndGggPT0gMCkgcmV0dXJuIFsnZ3JleScsIG51bGxdO1xyXG5cdFx0aWYgKHMubGVuZ3RoID09IDEpIHJldHVybiBbdG9jKHNbMF0pLCBudWxsXTtcclxuXHRcdGlmIChzLmxlbmd0aCA9PSAyKSByZXR1cm4gW3RvYyhzWzBdKSwgdG9jKHNbMV0pXTtcclxuXHRcdHMgPSBzLnNvcnQoKTtcclxuXHRcdGxldCBjID0gU3pJbmZvLmNvbG9yLmJ5Q29tYm9bcy5zb3J0KCkuam9pbignJykgYXMgY29sb3JTdHJpbmddLm5hbWU7XHJcblx0XHRyZXR1cm4gW2MsIGNdO1xyXG5cdH1cclxuXHJcblx0c3RhdGljIGluc3RhbGwobW9kOiBNb2QpIHtcclxuXHRcdG1vZC5tb2RJbnRlcmZhY2UucmVnaXN0ZXJJdGVtKFN6Q29sb3JJdGVtLCBkYXRhID0+IG5ldyBTekNvbG9ySXRlbShkYXRhKSk7XHJcblx0fVxyXG59Il19