import { ExtendSuperclass } from "./common.js";
import { SzDefinition } from "./shapest/definition.js";
import { SzInfo } from "./shapest/layer.js";
import { BaseItem, clamp, COLOR_ITEM_SINGLETONS, globalConfig, MapChunk, ShapeDefinition } from "./types/shapez.js";
export const shapePatchChances = {
    circleSpawn: { base: 50, growth: 3, cap: 100 },
    squareSpawn: { base: 100, growth: 2, cap: 100 },
    starSpawn: { base: 20, growth: 1, cap: 100 },
    windmillSpawn: { base: 6, growth: 0.5, cap: 100 },
};
export const predefinedPatches = [
    {
        x: 0, y: 0, item: 
        // SzColorItem.fromColor('red')
        COLOR_ITEM_SINGLETONS.red,
        dx: 7, dy: 7
    },
    { x: -1, y: 0, item: SzInfo.quad.named.circleSpawn, dx: -9, dy: 7 },
    { x: 0, y: -1, item: SzInfo.quad.named.squareSpawn, dx: 5, dy: -7 },
    {
        x: -1, y: -1, item: 
        // SzColorItem.fromColor('green')
        COLOR_ITEM_SINGLETONS.green
    },
    { x: 5, y: -2, item: SzInfo.quad.named.starSpawn, dx: 5, dy: -7 },
];
export class SpawnOwerride extends MapChunk {
    // internalGenerateColorPatch(rng: RandomNumberGenerator, colorPatchSize: number, distanceToOriginInChunks: number) {
    // 	console.log(this)
    // 	let available = ['red', 'green'];
    // 	if (distanceToOriginInChunks > 2) available.push('blue');
    // 	this.internalGeneratePatch(rng, colorPatchSize, SzColorItem.fromColor(rng.choice(available)));
    // }
    internalGenerateShapePatch(rng, shapePatchSize, distanceToOriginInChunks) {
        let dToChance = (base, grow, maxTotal) => Math.round(base + clamp(distanceToOriginInChunks * grow, 0, maxTotal - base));
        let weights = Object.fromEntries(Object.entries(shapePatchChances).map(([k, { base, growth, cap }]) => [k, dToChance(base, growth, cap)]));
        if (distanceToOriginInChunks < 7) {
            // Initial chunks can not spawn the good stuff
            weights.starSpawn = 0;
            weights.windmillSpawn = 0;
        }
        let quadNames = [];
        let next = this.internalGenerateRandomSubShape(rng, weights);
        quadNames.push(next);
        if (distanceToOriginInChunks >= 10) {
            let next = this.internalGenerateRandomSubShape(rng, weights);
            while (quadNames.concat(next).filter(e => e == 'windmillSpawn').length > 1)
                next = this.internalGenerateRandomSubShape(rng, weights);
            quadNames.push(next);
        }
        if (distanceToOriginInChunks >= 15) {
            let next = this.internalGenerateRandomSubShape(rng, weights);
            while (quadNames.concat(next).filter(e => e == 'windmillSpawn').length > 1)
                next = this.internalGenerateRandomSubShape(rng, weights);
            quadNames.push(next);
        }
        let quadHashes = quadNames.map(e => SzInfo.quad.named[e]);
        let hash = '6' + quadHashes.map((e, i, a) => {
            let l = 12 / a.length;
            return e.slice(1 + l * i, 1 + l * (i + 1));
        }).join('');
        const definition = SzDefinition.fromShortKey(hash);
        this.internalGeneratePatch(rng, shapePatchSize, this.root.shapeDefinitionMgr.getShapeItemFromDefinition(definition));
    }
    generatePredefined(rng) {
        let def = predefinedPatches.find(p => p.x == this.x && p.y == this.y);
        if (!def)
            return false;
        let item = def.item instanceof BaseItem ? def.item
            : this.root.shapeDefinitionMgr.getShapeItemFromDefinition(ShapeDefinition.fromShortKey(def.item));
        let dx = def.dx == null ? null : def.dx + (def.dx > 0 ? 0 : globalConfig.mapChunkSize);
        let dy = def.dy == null ? null : def.dy + (def.dy > 0 ? 0 : globalConfig.mapChunkSize);
        this.internalGeneratePatch(rng, 2, item, dx, dy);
        return true;
    }
    static install(mod) {
        ExtendSuperclass(mod, MapChunk, () => SpawnOwerride);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3Bhd25PdmVycmlkZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3RzL1NwYXduT3ZlcnJpZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQy9DLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFNUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUscUJBQXFCLEVBQUUsWUFBWSxFQUFFLFFBQVEsRUFBOEIsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFHaEosTUFBTSxDQUFDLE1BQU0saUJBQWlCLEdBR3pCO0lBQ0osV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7SUFDOUMsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7SUFDL0MsU0FBUyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7SUFDNUMsYUFBYSxFQUFFLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7Q0FDakQsQ0FBQTtBQUVELE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUV4QjtJQUNKO1FBQ0MsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUk7UUFDZiwrQkFBK0I7UUFDL0IscUJBQXFCLENBQUMsR0FBRztRQUN4QixFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDO0tBQ2Q7SUFDRCxFQUFFLENBQUMsRUFBRSxDQUFD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YSxDQUFDLENBQUM7SUFFdEQsQ0FBQztDQUVEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXh0ZW5kU3VwZXJjbGFzcyB9IGZyb20gXCIuL2NvbW1vbi5qc1wiO1xyXG5pbXBvcnQgeyBTekRlZmluaXRpb24gfSBmcm9tIFwiLi9zaGFwZXN0L2RlZmluaXRpb24uanNcIjtcclxuaW1wb3J0IHsgU3pJbmZvIH0gZnJvbSBcIi4vc2hhcGVzdC9sYXllci5qc1wiO1xyXG5pbXBvcnQgeyBzelNoYXBlSGFzaDYgfSBmcm9tIFwiLi9zaGFwZXN0L1N6Q29udGV4dDJELmpzXCI7XHJcbmltcG9ydCB7IEJhc2VJdGVtLCBjbGFtcCwgQ09MT1JfSVRFTV9TSU5HTEVUT05TLCBnbG9iYWxDb25maWcsIE1hcENodW5rLCBNb2QsIFJhbmRvbU51bWJlckdlbmVyYXRvciwgU2hhcGVEZWZpbml0aW9uIH0gZnJvbSBcIi4vdHlwZXMvc2hhcGV6LmpzXCI7XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IHNoYXBlUGF0Y2hDaGFuY2VzXHJcblx0OiBQYXJ0aWFsPFJlY29yZDxTekluZm8ucXVhZC5uYW1lZCxcclxuXHRcdHsgYmFzZTogbnVtYmVyLCBncm93dGg6IG51bWJlciwgY2FwOiBudW1iZXIgfT5cclxuXHQ+ID0ge1xyXG5cdGNpcmNsZVNwYXduOiB7IGJhc2U6IDUwLCBncm93dGg6IDMsIGNhcDogMTAwIH0sXHJcblx0c3F1YXJlU3Bhd246IHsgYmFzZTogMTAwLCBncm93dGg6IDIsIGNhcDogMTAwIH0sXHJcblx0c3RhclNwYXduOiB7IGJhc2U6IDIwLCBncm93dGg6IDEsIGNhcDogMTAwIH0sXHJcblx0d2luZG1pbGxTcGF3bjogeyBiYXNlOiA2LCBncm93dGg6IDAuNSwgY2FwOiAxMDAgfSxcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHByZWRlZmluZWRQYXRjaGVzOiB7XHJcblx0eDogbnVtYmVyLCB5OiBudW1iZXIsIGl0ZW06IEJhc2VJdGVtIHwgc3pTaGFwZUhhc2g2LCBkeD86IG51bWJlciwgZHk/OiBudW1iZXIsXHJcbn1bXSA9IFtcclxuXHRcdHtcclxuXHRcdFx0eDogMCwgeTogMCwgaXRlbTpcclxuXHRcdFx0XHQvLyBTekNvbG9ySXRlbS5mcm9tQ29sb3IoJ3JlZCcpXHJcblx0XHRcdFx0Q09MT1JfSVRFTV9TSU5HTEVUT05TLnJlZFxyXG5cdFx0XHQsIGR4OiA3LCBkeTogN1xyXG5cdFx0fSxcclxuXHRcdHsgeDogLTEsIHk6IDAsIGl0ZW06IFN6SW5mby5xdWFkLm5hbWVkLmNpcmNsZVNwYXduLCBkeDogLTksIGR5OiA3IH0sXHJcblx0XHR7IHg6IDAsIHk6IC0xLCBpdGVtOiBTekluZm8ucXVhZC5uYW1lZC5zcXVhcmVTcGF3biwgZHg6IDUsIGR5OiAtNyB9LFxyXG5cdFx0e1xyXG5cdFx0XHR4OiAtMSwgeTogLTEsIGl0ZW06XHJcblx0XHRcdFx0Ly8gU3pDb2xvckl0ZW0uZnJvbUNvbG9yKCdncmVlbicpXHJcblx0XHRcdFx0Q09MT1JfSVRFTV9TSU5HTEVUT05TLmdyZWVuXHJcblx0XHR9LFxyXG5cdFx0eyB4OiA1LCB5OiAtMiwgaXRlbTogU3pJbmZvLnF1YWQubmFtZWQuc3RhclNwYXduLCBkeDogNSwgZHk6IC03IH0sXHJcblx0XTtcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgU3Bhd25Pd2VycmlkZSBleHRlbmRzIE1hcENodW5rIHtcclxuXHQvLyBpbnRlcm5hbEdlbmVyYXRlQ29sb3JQYXRjaChybmc6IFJhbmRvbU51bWJlckdlbmVyYXRvciwgY29sb3JQYXRjaFNpemU6IG51bWJlciwgZGlzdGFuY2VUb09yaWdpbkluQ2h1bmtzOiBudW1iZXIpIHtcclxuXHQvLyBcdGNvbnNvbGUubG9nKHRoaXMpXHJcblx0Ly8gXHRsZXQgYXZhaWxhYmxlID0gWydyZWQnLCAnZ3JlZW4nXTtcclxuXHQvLyBcdGlmIChkaXN0YW5jZVRvT3JpZ2luSW5DaHVua3MgPiAyKSBhdmFpbGFibGUucHVzaCgnYmx1ZScpO1xyXG5cdC8vIFx0dGhpcy5pbnRlcm5hbEdlbmVyYXRlUGF0Y2gocm5nLCBjb2xvclBhdGNoU2l6ZSwgU3pDb2xvckl0ZW0uZnJvbUNvbG9yKHJuZy5jaG9pY2UoYXZhaWxhYmxlKSkpO1xyXG5cdC8vIH1cclxuXHRpbnRlcm5hbEdlbmVyYXRlU2hhcGVQYXRjaChybmc6IFJhbmRvbU51bWJlckdlbmVyYXRvciwgc2hhcGVQYXRjaFNpemU6IG51bWJlciwgZGlzdGFuY2VUb09yaWdpbkluQ2h1bmtzOiBudW1iZXIpIHtcclxuXHRcdGxldCBkVG9DaGFuY2UgPSAoYmFzZTogbnVtYmVyLCBncm93OiBudW1iZXIsIG1heFRvdGFsOiBudW1iZXIpID0+XHJcblx0XHRcdE1hdGgucm91bmQoYmFzZSArIGNsYW1wKGRpc3RhbmNlVG9PcmlnaW5JbkNodW5rcyAqIGdyb3csIDAsIG1heFRvdGFsIC0gYmFzZSkpO1xyXG5cclxuXHRcdGxldCB3ZWlnaHRzID0gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKHNoYXBlUGF0Y2hDaGFuY2VzKS5tYXAoKFtrLCB7IGJhc2UsIGdyb3d0aCwgY2FwIH1dKSA9PlxyXG5cdFx0XHRbayBhcyBTekluZm8ucXVhZC5uYW1lZCwgZFRvQ2hhbmNlKGJhc2UsIGdyb3d0aCwgY2FwKV1cclxuXHRcdCkpXHJcblxyXG5cclxuXHJcblx0XHRpZiAoZGlzdGFuY2VUb09yaWdpbkluQ2h1bmtzIDwgNykge1xyXG5cdFx0XHQvLyBJbml0aWFsIGNodW5rcyBjYW4gbm90IHNwYXduIHRoZSBnb29kIHN0dWZmXHJcblx0XHRcdHdlaWdodHMuc3RhclNwYXduID0gMDtcclxuXHRcdFx0d2VpZ2h0cy53aW5kbWlsbFNwYXduID0gMDtcclxuXHRcdH1cclxuXHJcblx0XHRsZXQgcXVhZE5hbWVzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuXHRcdGxldCBuZXh0ID0gdGhpcy5pbnRlcm5hbEdlbmVyYXRlUmFuZG9tU3ViU2hhcGUocm5nLCB3ZWlnaHRzKTtcclxuXHRcdHF1YWROYW1lcy5wdXNoKG5leHQpO1xyXG5cdFx0aWYgKGRpc3RhbmNlVG9PcmlnaW5JbkNodW5rcyA+PSAxMCkge1xyXG5cdFx0XHRsZXQgbmV4dCA9IHRoaXMuaW50ZXJuYWxHZW5lcmF0ZVJhbmRvbVN1YlNoYXBlKHJuZywgd2VpZ2h0cyk7XHJcblx0XHRcdHdoaWxlIChxdWFkTmFtZXMuY29uY2F0KG5leHQpLmZpbHRlcihlID0+IGUgPT0gJ3dpbmRtaWxsU3Bhd24nKS5sZW5ndGggPiAxKVxyXG5cdFx0XHRcdG5leHQgPSB0aGlzLmludGVybmFsR2VuZXJhdGVSYW5kb21TdWJTaGFwZShybmcsIHdlaWdodHMpO1xyXG5cdFx0XHRxdWFkTmFtZXMucHVzaChuZXh0KTtcclxuXHRcdH1cclxuXHRcdGlmIChkaXN0YW5jZVRvT3JpZ2luSW5DaHVua3MgPj0gMTUpIHtcclxuXHRcdFx0bGV0IG5leHQgPSB0aGlzLmludGVybmFsR2VuZXJhdGVSYW5kb21TdWJTaGFwZShybmcsIHdlaWdodHMpO1xyXG5cdFx0XHR3aGlsZSAocXVhZE5hbWVzLmNvbmNhdChuZXh0KS5maWx0ZXIoZSA9PiBlID09ICd3aW5kbWlsbFNwYXduJykubGVuZ3RoID4gMSlcclxuXHRcdFx0XHRuZXh0ID0gdGhpcy5pbnRlcm5hbEdlbmVyYXRlUmFuZG9tU3ViU2hhcGUocm5nLCB3ZWlnaHRzKTtcclxuXHRcdFx0cXVhZE5hbWVzLnB1c2gobmV4dCk7XHJcblx0XHR9XHJcblxyXG5cdFx0bGV0IHF1YWRIYXNoZXMgPSAocXVhZE5hbWVzIGFzIFN6SW5mby5xdWFkLm5hbWVkW10pLm1hcChlID0+IFN6SW5mby5xdWFkLm5hbWVkW2VdKTtcclxuXHJcblx0XHRsZXQgaGFzaCA9ICc2JyArIHF1YWRIYXNoZXMubWFwKChlLCBpLCBhKSA9PiB7XHJcblx0XHRcdGxldCBsID0gMTIgLyBhLmxlbmd0aDtcclxuXHRcdFx0cmV0dXJuIGUuc2xpY2UoMSArIGwgKiBpLCAxICsgbCAqIChpICsgMSkpO1xyXG5cdFx0fSkuam9pbignJyk7XHJcblxyXG5cclxuXHRcdGNvbnN0IGRlZmluaXRpb24gPSBTekRlZmluaXRpb24uZnJvbVNob3J0S2V5KGhhc2gpO1xyXG5cdFx0dGhpcy5pbnRlcm5hbEdlbmVyYXRlUGF0Y2goXHJcblx0XHRcdHJuZyxcclxuXHRcdFx0c2hhcGVQYXRjaFNpemUsXHJcblx0XHRcdHRoaXMucm9vdC5zaGFwZURlZmluaXRpb25NZ3IuZ2V0U2hhcGVJdGVtRnJvbURlZmluaXRpb24oZGVmaW5pdGlvbilcclxuXHRcdCk7XHJcblxyXG5cdH1cclxuXHRnZW5lcmF0ZVByZWRlZmluZWQocm5nOiBSYW5kb21OdW1iZXJHZW5lcmF0b3IpIHtcclxuXHRcdGxldCBkZWYgPSBwcmVkZWZpbmVkUGF0Y2hlcy5maW5kKHAgPT4gcC54ID09IHRoaXMueCAmJiBwLnkgPT0gdGhpcy55KTtcclxuXHRcdGlmICghZGVmKSByZXR1cm4gZmFsc2U7XHJcblxyXG5cdFx0bGV0IGl0ZW0gPSBkZWYuaXRlbSBpbnN0YW5jZW9mIEJhc2VJdGVtID8gZGVmLml0ZW1cclxuXHRcdFx0OiB0aGlzLnJvb3Quc2hhcGVEZWZpbml0aW9uTWdyLmdldFNoYXBlSXRlbUZyb21EZWZpbml0aW9uKFNoYXBlRGVmaW5pdGlvbi5mcm9tU2hvcnRLZXkoZGVmLml0ZW0pKTtcclxuXHJcblx0XHRsZXQgZHggPSBkZWYuZHggPT0gbnVsbCA/IG51bGwgYXMgYW55IDogZGVmLmR4ICsgKGRlZi5keCA+IDAgPyAwIDogZ2xvYmFsQ29uZmlnLm1hcENodW5rU2l6ZSk7XHJcblx0XHRsZXQgZHkgPSBkZWYuZHkgPT0gbnVsbCA/IG51bGwgYXMgYW55IDogZGVmLmR5ICsgKGRlZi5keSA+IDAgPyAwIDogZ2xvYmFsQ29uZmlnLm1hcENodW5rU2l6ZSk7XHJcblxyXG5cdFx0dGhpcy5pbnRlcm5hbEdlbmVyYXRlUGF0Y2gocm5nLCAyLCBpdGVtLCBkeCwgZHkpO1xyXG5cdFx0cmV0dXJuIHRydWU7XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgaW5zdGFsbChtb2Q6IE1vZCkge1xyXG5cclxuXHRcdEV4dGVuZFN1cGVyY2xhc3MobW9kLCBNYXBDaHVuaywgKCkgPT4gU3Bhd25Pd2VycmlkZSk7XHJcblxyXG5cdH1cclxuXHJcbn0iXX0=