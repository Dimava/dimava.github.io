import { makeOffscreenBuffer } from "shapez/core/buffer_utils";
import { globalConfig } from "shapez/core/config";
import { smoothenDpi } from "shapez/core/dpi_manager";
import { COLOR_ITEM_SINGLETONS } from "shapez/game/items/color_item";
import { ShapeDefinition } from "shapez/game/shape_definition";
import { LogicGateSystem } from "shapez/game/systems/logic_gate";
import { THEME } from "shapez/game/theme";
import { BasicSerializableObject, types } from "shapez/savegame/serialization";
import { SzInfo, SzLayer } from "./layer";
import { SzContext2D } from "./SzContext2D";
export class SzDefinition extends BasicSerializableObject {
    static getId() {
        return "sz-definition";
    }
    static createTest() {
        return new SzDefinition({
            layers: [SzLayer.createTest()],
        });
    }
    constructor(data, clone = false) {
        super();
        if (typeof data == 'string')
            return SzDefinition.fromShortKey(data);
        if (data?.layers)
            this.layers = data.layers.map((e, i) => new SzLayer(e, i));
        if (!this.layers.every(e => e.isNormalized())) {
            this.layers = SzDefinition.createTest().layers;
        }
        // console.log(this.getHash())
        if (clone)
            return;
        if (SzDefinition.definitionCache.has(this.getHash())) {
            return SzDefinition.definitionCache.get(this.getHash());
        }
        console.log(this.getHash());
    }
    layers = [];
    cachedHash = '';
    bufferGenerator;
    getClonedLayers() {
        throw new Error("Method not implemented.");
    }
    isEntirelyEmpty() {
        return this.layers.every(e => e.isEmpty());
    }
    getHash() {
        if (this.cachedHash)
            return this.cachedHash;
        if (!this.layers.length)
            debugger;
        return this.cachedHash = this.layers.map(e => e.getHash()).join(':');
    }
    drawFullSizeOnCanvas(context, size) {
        this.internalGenerateShapeBuffer(null, context, size, size, 1);
    }
    generateAsCanvas(size = 120) {
        const [canvas, context] = makeOffscreenBuffer(size, size, {
            smooth: true,
            label: "definition-canvas-cache-" + this.getHash(),
            reusable: false,
        });
        this.internalGenerateShapeBuffer(canvas, context, size, size, 1);
        return canvas;
    }
    cloneFilteredByQuadrants(includeQuadrants) {
        let layers = this.layers.map(e => e.cloneFilteredByQuadrants(includeQuadrants)).filter(e => !e.isEmpty());
        return new SzDefinition({ layers });
    }
    cloneRotateCW() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(6))
        });
    }
    cloneRotate24(n) {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(n))
        });
    }
    cloneRotateCCW() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(24 - 6))
        });
    }
    cloneRotate180() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(12))
        });
    }
    cloneAndStackWith(upper) {
        let bottom = this.clone(e => e.removeCover()).layers;
        let top = upper.clone().layers;
        let dh = 0;
        while (!bottom.every((l, i) => {
            return l.canStackWith(top[i - dh]);
        }))
            dh++;
        let overlap = bottom.length - dh;
        let newLayers = bottom.map((l, i) => {
            return l.stackWith(top[i + dh]);
        }).concat(top.slice(overlap));
        return new SzDefinition({ layers: newLayers.slice(0, 4) });
    }
    cloneAndPaintWith(color) {
        let rawPaints = Array(24).fill(color);
        return this.clone((l, i, a) => {
            let paints = a.slice(i).reduceRight((v, e) => e.filterPaint(v), rawPaints);
            return l.removeCover().paint(paints);
        });
    }
    cloneAndPaintWith4Colors(colors) {
        let rawPaints = Array.from({ length: 24 }, (e, i) => {
            return colors[i % 6];
        });
        return this.clone((l, i, a) => {
            let paints = a.slice(i).reduceRight((v, e) => e.filterPaint(v), rawPaints);
            return l.removeCover().paint(paints);
        });
    }
    cloneAndMakeCover() {
        return new SzDefinition({ layers: this.layers.map(e => e.cloneAsCover()) });
    }
    clone(layerMapper) {
        if (layerMapper) {
            return new SzDefinition({
                layers: this.layers.map(e => e.clone()).flatMap((e, i, a) => {
                    return layerMapper(e, i, a) || [];
                }).filter(e => !e.isEmpty())
            });
        }
        return new SzDefinition(this, true);
    }
    static getSchema() {
        return types.string;
    }
    serialize() {
        return this.getHash();
    }
    deserialize(data, root) {
        console.log('deser', this);
    }
    // inherited
    drawCentered(x, y, parameters, diameter) {
        const dpi = smoothenDpi(globalConfig.shapesSharpness * parameters.zoomLevel);
        if (!this.bufferGenerator) {
            this.bufferGenerator = this.internalGenerateShapeBuffer.bind(this);
        }
        const key = diameter + "/" + dpi + "/" + this.cachedHash;
        const canvas = parameters.root.buffers.getForKey({
            key: "shapedef",
            subKey: key,
            w: diameter,
            h: diameter,
            dpi,
            redrawMethod: this.bufferGenerator,
        });
        parameters.context.drawImage(canvas, x - diameter / 2, y - diameter / 2, diameter, diameter);
    }
    internalGenerateShapeBuffer(canvas, ctx, w, h, dpi) {
        // prepare context
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 0.05;
        ctx.translate((w * dpi) / 2, (h * dpi) / 2);
        ctx.scale((dpi * w) / 2.3, (dpi * h) / 2.3);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = THEME.items.outline;
        ctx.lineWidth = THEME.items.outlineWidth / 10;
        ctx.rotate(-Math.PI / 2);
        ctx.fillStyle = THEME.items.circleBackground;
        ctx.beginPath();
        ctx.arc(0, 0, 1.15, 0, 2 * Math.PI);
        ctx.fill();
        let sCtx = new SzContext2D(ctx);
        this.layers.forEach((l, i) => l.drawCenteredLayerScaled(sCtx, i));
    }
    static rawHashMap = new Map();
    static getHashfromRawHash(hash) {
        if (!this.rawHashMap.has(hash)) {
            this.rawHashMap.set(hash, hash.startsWith('sz!') ? SzDefinition.fromShortKey(hash).getHash() :
                SzDefinition.fromRawShape(hash).getHash());
        }
        return this.rawHashMap.get(hash);
    }
    static fromRawShape(shapeDefinition) {
        if (typeof shapeDefinition != 'string')
            shapeDefinition = shapeDefinition.getHash();
        return new SzDefinition({
            layers: shapeDefinition.split(':').map(e => SzLayer.fromShortKey(e))
        });
    }
    static definitionCache = new Map();
    static fromShortKey(key) {
        if (!this.definitionCache.has(key)) {
            this.definitionCache.set(key, new SzDefinition({
                layers: key.split(':').map(e => SzLayer.fromShortKey(e))
            }));
        }
        return this.definitionCache.get(key);
    }
    compute_ANALYZE(root) {
        let firstQuad = this.layers[0].quads[0];
        if (firstQuad.from != 0)
            return [null, null];
        let definition = new SzDefinition({ layers: [SzInfo.quad.exampleLayer(firstQuad.shape)] });
        // @ts-expect-error
        let color = enumShortcodeToColor[SzInfo.color.byName[firstQuad.color].code];
        return [
            COLOR_ITEM_SINGLETONS[color],
            root.shapeDefinitionMgr.getShapeItemFromDefinition(definition),
        ];
    }
    static install(mod) {
        mod.modInterface.extendObject(ShapeDefinition, ({ $old }) => ({
            fromShortKey: SzDefinition.fromShortKey.bind(SzDefinition)
        }));
        mod.modInterface.extendClass(LogicGateSystem, ({ $old }) => ({
            compute_ANALYZE(parameters) {
                let item = parameters[0];
                if (!item || item.getItemType() !== "shape") {
                    // Not a shape
                    return [null, null];
                }
                let def = item.definition;
                if (def instanceof SzDefinition) {
                    return def.compute_ANALYZE(this.root);
                }
                return $old.compute_ANALYZE.call(this, parameters);
            }
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmaW5pdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zaGFwZXN0L2RlZmluaXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUd0RCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUdyRSxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sOEJBQThCLENBQUM7QUFDM0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUUxQyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsS0FBSyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFFL0UsT0FBTyxFQUFTLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDakQsT0FBTyxFQUFxQixXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHL0QsTUFBTSxPQUFPLFlBQWEsU0FBUSx1QkFBdUI7SUFDeEQsTUFBTSxDQUFDLEtBQUs7UUFDWCxPQUFPLGVBQWUsQ0FBQztJQUN4QixDQUFDO0lBRUQsTUFBTSxDQUFDLFVBQVU7UUFDaEIsT0FBTyxJQUFJLFlBQVksQ0FBQztZQUN2QixNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDOUIsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUlELFlBQVksSUFBb0QsRUFBRSxLQUFLLEdBQUcsS0FBSztRQUM5RSxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksT0FBTyxJQUFJLElBQUksUUFBUTtZQUFFLE9BQU8sWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJ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LE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQ3BELENBQUM7U0FDRCxDQUFDLENBQUMsQ0FBQTtJQUVKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtYWtlT2Zmc2NyZWVuQnVmZmVyIH0gZnJvbSBcInNoYXBlei9jb3JlL2J1ZmZlcl91dGlsc1wiO1xyXG5pbXBvcnQgeyBnbG9iYWxDb25maWcgfSBmcm9tIFwic2hhcGV6L2NvcmUvY29uZmlnXCI7XHJcbmltcG9ydCB7IHNtb290aGVuRHBpIH0gZnJvbSBcInNoYXBlei9jb3JlL2RwaV9tYW5hZ2VyXCI7XHJcbmltcG9ydCB7IERyYXdQYXJhbWV0ZXJzIH0gZnJvbSBcInNoYXBlei9jb3JlL2RyYXdfcGFyYW1ldGVyc1wiO1xyXG5pbXBvcnQgeyBCYXNlSXRlbSB9IGZyb20gXCJzaGFwZXovZ2FtZS9iYXNlX2l0ZW1cIjtcclxuaW1wb3J0IHsgQ09MT1JfSVRFTV9TSU5HTEVUT05TIH0gZnJvbSBcInNoYXBlei9nYW1lL2l0ZW1zL2NvbG9yX2l0ZW1cIjtcclxuaW1wb3J0IHsgU2hhcGVJdGVtIH0gZnJvbSBcInNoYXBlei9nYW1lL2l0ZW1zL3NoYXBlX2l0ZW1cIjtcclxuaW1wb3J0IHsgR2FtZVJvb3QgfSBmcm9tIFwic2hhcGV6L2dhbWUvcm9vdFwiO1xyXG5pbXBvcnQgeyBTaGFwZURlZmluaXRpb24sIFNoYXBlTGF5ZXIgfSBmcm9tIFwic2hhcGV6L2dhbWUvc2hhcGVfZGVmaW5pdGlvblwiO1xyXG5pbXBvcnQgeyBMb2dpY0dhdGVTeXN0ZW0gfSBmcm9tIFwic2hhcGV6L2dhbWUvc3lzdGVtcy9sb2dpY19nYXRlXCI7XHJcbmltcG9ydCB7IFRIRU1FIH0gZnJvbSBcInNoYXBlei9nYW1lL3RoZW1lXCI7XHJcbmltcG9ydCB7IE1vZCB9IGZyb20gXCJzaGFwZXovbW9kcy9tb2RcIjtcclxuaW1wb3J0IHsgQmFzaWNTZXJpYWxpemFibGVPYmplY3QsIHR5cGVzIH0gZnJvbSBcInNoYXBlei9zYXZlZ2FtZS9zZXJpYWxpemF0aW9uXCI7XHJcbmltcG9ydCB7IG92ZXJyaWRlLCBzdHJUb0ggfSBmcm9tIFwiLi4vY29tbW9uXCI7XHJcbmltcG9ydCB7IGNvbG9yLCBTekluZm8sIFN6TGF5ZXIgfSBmcm9tIFwiLi9sYXllclwiO1xyXG5pbXBvcnQgeyBybW9kZSwgcm90YXRpb24yNCwgU3pDb250ZXh0MkQgfSBmcm9tIFwiLi9TekNvbnRleHQyRFwiO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBTekRlZmluaXRpb24gZXh0ZW5kcyBCYXNpY1NlcmlhbGl6YWJsZU9iamVjdCBpbXBsZW1lbnRzIFNoYXBlRGVmaW5pdGlvbiB7XHJcblx0c3RhdGljIGdldElkKCkge1xyXG5cdFx0cmV0dXJuIFwic3otZGVmaW5pdGlvblwiO1xyXG5cdH1cclxuXHJcblx0c3RhdGljIGNyZWF0ZVRlc3QoKSB7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7XHJcblx0XHRcdGxheWVyczogW1N6TGF5ZXIuY3JlYXRlVGVzdCgpXSxcclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblxyXG5cclxuXHRjb25zdHJ1Y3RvcihkYXRhPzogeyBsYXllcnM6IFN6TGF5ZXJbXSB9IHwgU3pEZWZpbml0aW9uIHwgc3RyaW5nLCBjbG9uZSA9IGZhbHNlKSB7XHJcblx0XHRzdXBlcigpO1xyXG5cdFx0aWYgKHR5cGVvZiBkYXRhID09ICdzdHJpbmcnKSByZXR1cm4gU3pEZWZpbml0aW9uLmZyb21TaG9ydEtleShkYXRhKTtcclxuXHRcdGlmIChkYXRhPy5sYXllcnMpIHRoaXMubGF5ZXJzID0gZGF0YS5sYXllcnMubWFwKChlLCBpKSA9PiBuZXcgU3pMYXllcihlLCBpKSk7XHJcblx0XHRpZiAoIXRoaXMubGF5ZXJzLmV2ZXJ5KGUgPT4gZS5pc05vcm1hbGl6ZWQoKSkpIHtcclxuXHRcdFx0dGhpcy5sYXllcnMgPSBTekRlZmluaXRpb24uY3JlYXRlVGVzdCgpLmxheWVycztcclxuXHRcdH1cclxuXHRcdC8vIGNvbnNvbGUubG9nKHRoaXMuZ2V0SGFzaCgpKVxyXG5cdFx0aWYgKGNsb25lKSByZXR1cm47XHJcblx0XHRpZiAoU3pEZWZpbml0aW9uLmRlZmluaXRpb25DYWNoZS5oYXModGhpcy5nZXRIYXNoKCkpKSB7XHJcblx0XHRcdHJldHVybiBTekRlZmluaXRpb24uZGVmaW5pdGlvbkNhY2hlLmdldCh0aGlzLmdldEhhc2goKSkhO1xyXG5cdFx0fVxyXG5cdFx0Y29uc29sZS5sb2codGhpcy5nZXRIYXNoKCkpO1xyXG5cdH1cclxuXHJcblxyXG5cclxuXHRsYXllcnM6IFN6TGF5ZXJbXSA9IFtdO1xyXG5cdGNhY2hlZEhhc2g6IHN0cmluZyA9ICcnO1xyXG5cdGJ1ZmZlckdlbmVyYXRvcjogYW55O1xyXG5cdGdldENsb25lZExheWVycygpOiBTaGFwZUxheWVyW10ge1xyXG5cdFx0dGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XHJcblx0fVxyXG5cdGlzRW50aXJlbHlFbXB0eSgpOiBib29sZWFuIHtcclxuXHRcdHJldHVybiB0aGlzLmxheWVycy5ldmVyeShlID0+IGUuaXNFbXB0eSgpKTtcclxuXHR9XHJcblx0Z2V0SGFzaCgpOiBzdHJpbmcge1xyXG5cdFx0aWYgKHRoaXMuY2FjaGVkSGFzaCkgcmV0dXJuIHRoaXMuY2FjaGVkSGFzaDtcclxuXHRcdGlmICghdGhpcy5sYXllcnMubGVuZ3RoKSBkZWJ1Z2dlcjtcclxuXHRcdHJldHVybiB0aGlzLmNhY2hlZEhhc2ggPSB0aGlzLmxheWVycy5tYXAoZSA9PiBlLmdldEhhc2goKSkuam9pbignOicpO1xyXG5cdH1cclxuXHRkcmF3RnVsbFNpemVPbkNhbnZhcyhjb250ZXh0OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsIHNpemU6IG51bWJlcik6IHZvaWQge1xyXG5cdFx0dGhpcy5pbnRlcm5hbEdlbmVyYXRlU2hhcGVCdWZmZXIobnVsbCBhcyBhbnksIGNvbnRleHQsIHNpemUsIHNpemUsIDEpO1xyXG5cdH1cclxuXHRnZW5lcmF0ZUFzQ2FudmFzKHNpemUgPSAxMjApIHtcclxuXHRcdGNvbnN0IFtjYW52YXMsIGNvbnRleHRdID0gbWFrZU9mZnNjcmVlbkJ1ZmZlcihzaXplLCBzaXplLCB7XHJcblx0XHRcdHNtb290aDogdHJ1ZSxcclxuXHRcdFx0bGFiZWw6IFwiZGVmaW5pdGlvbi1jYW52YXMtY2FjaGUtXCIgKyB0aGlzLmdldEhhc2goKSxcclxuXHRcdFx0cmV1c2FibGU6IGZhbHNlLFxyXG5cdFx0fSk7XHJcblxyXG5cdFx0dGhpcy5pbnRlcm5hbEdlbmVyYXRlU2hhcGVCdWZmZXIoY2FudmFzLCBjb250ZXh0LCBzaXplLCBzaXplLCAxKTtcclxuXHRcdHJldHVybiBjYW52YXM7XHJcblx0fVxyXG5cdGNsb25lRmlsdGVyZWRCeVF1YWRyYW50cyhpbmNsdWRlUXVhZHJhbnRzOiBudW1iZXJbXSk6IFNoYXBlRGVmaW5pdGlvbiB7XHJcblx0XHRsZXQgbGF5ZXJzID0gdGhpcy5sYXllcnMubWFwKGUgPT4gZS5jbG9uZUZpbHRlcmVkQnlRdWFkcmFudHMoaW5jbHVkZVF1YWRyYW50cykpLmZpbHRlcihlID0+ICFlLmlzRW1wdHkoKSk7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7IGxheWVycyB9KTtcclxuXHR9XHJcblx0Y2xvbmVSb3RhdGVDVygpOiBTaGFwZURlZmluaXRpb24ge1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRsYXllcnM6IHRoaXMubGF5ZXJzLm1hcChsID0+IGwuY2xvbmUoKS5yb3RhdGUoNikpXHJcblx0XHR9KTtcclxuXHR9XHJcblx0Y2xvbmVSb3RhdGUyNChuOiByb3RhdGlvbjI0KTogU3pEZWZpbml0aW9uIHtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0bGF5ZXJzOiB0aGlzLmxheWVycy5tYXAobCA9PiBsLmNsb25lKCkucm90YXRlKG4pKVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cdGNsb25lUm90YXRlQ0NXKCk6IFNoYXBlRGVmaW5pdGlvbiB7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7XHJcblx0XHRcdGxheWVyczogdGhpcy5sYXllcnMubWFwKGwgPT4gbC5jbG9uZSgpLnJvdGF0ZSgyNCAtIDYpKVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cdGNsb25lUm90YXRlMTgwKCk6IFNoYXBlRGVmaW5pdGlvbiB7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7XHJcblx0XHRcdGxheWVyczogdGhpcy5sYXllcnMubWFwKGwgPT4gbC5jbG9uZSgpLnJvdGF0ZSgxMikpXHJcblx0XHR9KTtcclxuXHR9XHJcblx0Y2xvbmVBbmRTdGFja1dpdGgodXBwZXI6IFN6RGVmaW5pdGlvbik6IFNoYXBlRGVmaW5pdGlvbiB7XHJcblx0XHRsZXQgYm90dG9tID0gdGhpcy5jbG9uZShlID0+IGUucmVtb3ZlQ292ZXIoKSkubGF5ZXJzO1xyXG5cdFx0bGV0IHRvcCA9IHVwcGVyLmNsb25lKCkubGF5ZXJzO1xyXG5cdFx0bGV0IGRoID0gMDtcclxuXHRcdHdoaWxlICghYm90dG9tLmV2ZXJ5KChsLCBpKSA9PiB7XHJcblx0XHRcdHJldHVybiBsLmNhblN0YWNrV2l0aCh0b3BbaSAtIGRoXSk7XHJcblx0XHR9KSkgZGgrKztcclxuXHRcdGxldCBvdmVybGFwID0gYm90dG9tLmxlbmd0aCAtIGRoO1xyXG5cdFx0bGV0IG5ld0xheWVycyA9IGJvdHRvbS5tYXAoKGwsIGkpID0+IHtcclxuXHRcdFx0cmV0dXJuIGwuc3RhY2tXaXRoKHRvcFtpICsgZGhdKTtcclxuXHRcdH0pLmNvbmNhdCh0b3Auc2xpY2UoXHJcblx0XHRcdG92ZXJsYXBcclxuXHRcdCkpO1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oeyBsYXllcnM6IG5ld0xheWVycy5zbGljZSgwLCA0KSB9KTtcclxuXHR9XHJcblxyXG5cdGNsb25lQW5kUGFpbnRXaXRoKGNvbG9yOiBjb2xvcik6IFN6RGVmaW5pdGlvbiB7XHJcblx0XHRsZXQgcmF3UGFpbnRzID0gQXJyYXk8Y29sb3IgfCBudWxsPigyNCkuZmlsbChjb2xvcik7XHJcblx0XHRyZXR1cm4gdGhpcy5jbG9uZSgobCwgaSwgYSkgPT4ge1xyXG5cdFx0XHRsZXQgcGFpbnRzID0gYS5zbGljZShpKS5yZWR1Y2VSaWdodCgodiwgZSkgPT4gZS5maWx0ZXJQYWludCh2KSwgcmF3UGFpbnRzKTtcclxuXHRcdFx0cmV0dXJuIGwucmVtb3ZlQ292ZXIoKS5wYWludChwYWludHMpO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRjbG9uZUFuZFBhaW50V2l0aDRDb2xvcnMoY29sb3JzOiBbc3RyaW5nLCBzdHJpbmcsIHN0cmluZywgc3RyaW5nXSk6IFNoYXBlRGVmaW5pdGlvbiB7XHJcblx0XHRsZXQgcmF3UGFpbnRzOiAoY29sb3IgfCBudWxsKVtdID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogMjQgfSwgKGUsIGkpID0+IHtcclxuXHRcdFx0cmV0dXJuIGNvbG9yc1tpICUgNl0gYXMgYW55O1xyXG5cdFx0fSlcclxuXHRcdHJldHVybiB0aGlzLmNsb25lKChsLCBpLCBhKSA9PiB7XHJcblx0XHRcdGxldCBwYWludHMgPSBhLnNsaWNlKGkpLnJlZHVjZVJpZ2h0KCh2LCBlKSA9PiBlLmZpbHRlclBhaW50KHYpLCByYXdQYWludHMpO1xyXG5cdFx0XHRyZXR1cm4gbC5yZW1vdmVDb3ZlcigpLnBhaW50KHBhaW50cyk7XHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdGNsb25lQW5kTWFrZUNvdmVyKCkge1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oeyBsYXllcnM6IHRoaXMubGF5ZXJzLm1hcChlID0+IGUuY2xvbmVBc0NvdmVyKCkpIH0pXHJcblx0fVxyXG5cclxuXHJcblx0Y2xvbmUobGF5ZXJNYXBwZXI/OiAobGF5ZXI6IFN6TGF5ZXIsIGk6IG51bWJlciwgYTogU3pMYXllcltdKSA9PiBTekxheWVyIHwgU3pMYXllcltdIHwgbnVsbCkge1xyXG5cdFx0aWYgKGxheWVyTWFwcGVyKSB7XHJcblx0XHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0XHRsYXllcnM6IHRoaXMubGF5ZXJzLm1hcChlID0+IGUuY2xvbmUoKSkuZmxhdE1hcCgoZSwgaSwgYSkgPT4ge1xyXG5cdFx0XHRcdFx0cmV0dXJuIGxheWVyTWFwcGVyKGUsIGksIGEpIHx8IFtdO1xyXG5cdFx0XHRcdH0pLmZpbHRlcihlID0+ICFlLmlzRW1wdHkoKSlcclxuXHRcdFx0fSk7XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih0aGlzLCB0cnVlKTtcclxuXHR9XHJcblxyXG5cdHN0YXRpYyBnZXRTY2hlbWEoKSB7XHJcblx0XHRyZXR1cm4gdHlwZXMuc3RyaW5nO1xyXG5cdH1cclxuXHRzZXJpYWxpemUoKSB7XHJcblx0XHRyZXR1cm4gdGhpcy5nZXRIYXNoKCk7XHJcblx0fVxyXG5cdGRlc2VyaWFsaXplKGRhdGE6IGFueSwgcm9vdD86IEdhbWVSb290KTogc3RyaW5nIHwgdm9pZCB7XHJcblx0XHRjb25zb2xlLmxvZygnZGVzZXInLCB0aGlzKTtcclxuXHR9XHJcblxyXG5cclxuXHJcblxyXG5cdC8vIGluaGVyaXRlZFxyXG5cdGRyYXdDZW50ZXJlZCh4OiBudW1iZXIsIHk6IG51bWJlciwgcGFyYW1ldGVyczogRHJhd1BhcmFtZXRlcnMsIGRpYW1ldGVyOiBudW1iZXIpOiB2b2lkIHtcclxuXHRcdGNvbnN0IGRwaSA9IHNtb290aGVuRHBpKGdsb2JhbENvbmZpZy5zaGFwZXNTaGFycG5lc3MgKiBwYXJhbWV0ZXJzLnpvb21MZXZlbCk7XHJcblx0XHRpZiAoIXRoaXMuYnVmZmVyR2VuZXJhdG9yKSB7XHJcblx0XHRcdHRoaXMuYnVmZmVyR2VuZXJhdG9yID0gdGhpcy5pbnRlcm5hbEdlbmVyYXRlU2hhcGVCdWZmZXIuYmluZCh0aGlzKTtcclxuXHRcdH1cclxuXHRcdGNvbnN0IGtleSA9IGRpYW1ldGVyICsgXCIvXCIgKyBkcGkgKyBcIi9cIiArIHRoaXMuY2FjaGVkSGFzaDtcclxuXHRcdGNvbnN0IGNhbnZhcyA9IHBhcmFtZXRlcnMucm9vdC5idWZmZXJzLmdldEZvcktleSh7XHJcblx0XHRcdGtleTogXCJzaGFwZWRlZlwiLFxyXG5cdFx0XHRzdWJLZXk6IGtleSxcclxuXHRcdFx0dzogZGlhbWV0ZXIsXHJcblx0XHRcdGg6IGRpYW1ldGVyLFxyXG5cdFx0XHRkcGksXHJcblx0XHRcdHJlZHJhd01ldGhvZDogdGhpcy5idWZmZXJHZW5lcmF0b3IsXHJcblx0XHR9KTtcclxuXHRcdHBhcmFtZXRlcnMuY29udGV4dC5kcmF3SW1hZ2UoY2FudmFzLCB4IC0gZGlhbWV0ZXIgLyAyLCB5IC0gZGlhbWV0ZXIgLyAyLCBkaWFtZXRlciwgZGlhbWV0ZXIpO1xyXG5cdH1cclxuXHJcblxyXG5cdGludGVybmFsR2VuZXJhdGVTaGFwZUJ1ZmZlcihjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50LCBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgdzogbnVtYmVyLCBoOiBudW1iZXIsIGRwaTogbnVtYmVyKTogdm9pZCB7XHJcblx0XHQvLyBwcmVwYXJlIGNvbnRleHRcclxuXHRcdGN0eC5saW5lQ2FwID0gJ3JvdW5kJztcclxuXHRcdGN0eC5saW5lSm9pbiA9ICdyb3VuZCc7XHJcblx0XHRjdHgubGluZVdpZHRoID0gMC4wNTtcclxuXHJcblx0XHRjdHgudHJhbnNsYXRlKCh3ICogZHBpKSAvIDIsIChoICogZHBpKSAvIDIpO1xyXG5cdFx0Y3R4LnNjYWxlKChkcGkgKiB3KSAvIDIuMywgKGRwaSAqIGgpIC8gMi4zKTtcclxuXHRcdGN0eC5saW5lQ2FwID0gJ3JvdW5kJztcclxuXHRcdGN0eC5saW5lSm9pbiA9ICdyb3VuZCc7XHJcblx0XHRjdHguc3Ryb2tlU3R5bGUgPSBUSEVNRS5pdGVtcy5vdXRsaW5lO1xyXG5cdFx0Y3R4LmxpbmVXaWR0aCA9IFRIRU1FLml0ZW1zLm91dGxpbmVXaWR0aCAvIDEwO1xyXG5cclxuXHRcdGN0eC5yb3RhdGUoLU1hdGguUEkgLyAyKTtcclxuXHJcblx0XHRjdHguZmlsbFN0eWxlID0gVEhFTUUuaXRlbXMuY2lyY2xlQmFja2dyb3VuZDtcclxuXHRcdGN0eC5iZWdpblBhdGgoKTtcclxuXHRcdGN0eC5hcmMoMCwgMCwgMS4xNSwgMCwgMiAqIE1hdGguUEkpO1xyXG5cdFx0Y3R4LmZpbGwoKTtcclxuXHJcblx0XHRsZXQgc0N0eCA9IG5ldyBTekNvbnRleHQyRChjdHgpO1xyXG5cdFx0dGhpcy5sYXllcnMuZm9yRWFjaCgobCwgaSkgPT4gbC5kcmF3Q2VudGVyZWRMYXllclNjYWxlZChzQ3R4LCBpKSk7XHJcblxyXG5cdH1cclxuXHJcblx0c3RhdGljIHJhd0hhc2hNYXA6IE1hcDxzdHJpbmcsIHN0cmluZz4gPSBuZXcgTWFwKCk7XHJcblx0c3RhdGljIGdldEhhc2hmcm9tUmF3SGFzaChoYXNoOiBzdHJpbmcpIHtcclxuXHRcdGlmICghdGhpcy5yYXdIYXNoTWFwLmhhcyhoYXNoKSkge1xyXG5cdFx0XHR0aGlzLnJhd0hhc2hNYXAuc2V0KGhhc2gsXHJcblx0XHRcdFx0aGFzaC5zdGFydHNXaXRoKCdzeiEnKSA/IFN6RGVmaW5pdGlvbi5mcm9tU2hvcnRLZXkoaGFzaCkuZ2V0SGFzaCgpIDpcclxuXHRcdFx0XHRcdFN6RGVmaW5pdGlvbi5mcm9tUmF3U2hhcGUoaGFzaCkuZ2V0SGFzaCgpXHJcblx0XHRcdClcclxuXHRcdH1cclxuXHRcdHJldHVybiB0aGlzLnJhd0hhc2hNYXAuZ2V0KGhhc2gpITtcclxuXHR9XHJcblxyXG5cdHN0YXRpYyBmcm9tUmF3U2hhcGUoc2hhcGVEZWZpbml0aW9uOiBTaGFwZURlZmluaXRpb24gfCBzdHJpbmcpIHtcclxuXHRcdGlmICh0eXBlb2Ygc2hhcGVEZWZpbml0aW9uICE9ICdzdHJpbmcnKVxyXG5cdFx0XHRzaGFwZURlZmluaXRpb24gPSBzaGFwZURlZmluaXRpb24uZ2V0SGFzaCgpO1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRsYXllcnM6IHNoYXBlRGVmaW5pdGlvbi5zcGxpdCgnOicpLm1hcChlID0+IFN6TGF5ZXIuZnJvbVNob3J0S2V5KGUpKVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgZGVmaW5pdGlvbkNhY2hlOiBNYXA8c3RyaW5nLCBTekRlZmluaXRpb24+ID0gbmV3IE1hcCgpO1xyXG5cdHN0YXRpYyBmcm9tU2hvcnRLZXkoa2V5OiBzdHJpbmcpOiBTekRlZmluaXRpb24ge1xyXG5cdFx0aWYgKCF0aGlzLmRlZmluaXRpb25DYWNoZS5oYXMoa2V5KSkge1xyXG5cdFx0XHR0aGlzLmRlZmluaXRpb25DYWNoZS5zZXQoa2V5LCBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0XHRsYXllcnM6IGtleS5zcGxpdCgnOicpLm1hcChlID0+IFN6TGF5ZXIuZnJvbVNob3J0S2V5KGUpKVxyXG5cdFx0XHR9KSk7XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gdGhpcy5kZWZpbml0aW9uQ2FjaGUuZ2V0KGtleSkhO1xyXG5cdH1cclxuXHJcblx0Y29tcHV0ZV9BTkFMWVpFKHJvb3Q6IEdhbWVSb290KTogW0Jhc2VJdGVtIHwgbnVsbCwgQmFzZUl0ZW0gfCBudWxsXSB7XHJcblx0XHRsZXQgZmlyc3RRdWFkID0gdGhpcy5sYXllcnNbMF0ucXVhZHNbMF07XHJcblx0XHRpZiAoZmlyc3RRdWFkLmZyb20gIT0gMCkgcmV0dXJuIFtudWxsLCBudWxsXTtcclxuXHRcdGxldCBkZWZpbml0aW9uID0gbmV3IFN6RGVmaW5pdGlvbih7IGxheWVyczogW1N6SW5mby5xdWFkLmV4YW1wbGVMYXllcihmaXJzdFF1YWQuc2hhcGUpXSB9KTtcclxuXHRcdC8vIEB0cy1leHBlY3QtZXJyb3JcclxuXHRcdGxldCBjb2xvciA9IGVudW1TaG9ydGNvZGVUb0NvbG9yW1N6SW5mby5jb2xvci5ieU5hbWVbZmlyc3RRdWFkLmNvbG9yXS5jb2RlXTtcclxuXHRcdHJldHVybiBbXHJcblx0XHRcdENPTE9SX0lURU1fU0lOR0xFVE9OU1tjb2xvcl0sXHJcblx0XHRcdHJvb3Quc2hhcGVEZWZpbml0aW9uTWdyLmdldFNoYXBlSXRlbUZyb21EZWZpbml0aW9uKGRlZmluaXRpb24pLFxyXG5cdFx0XTtcclxuXHR9XHJcblxyXG5cclxuXHJcblx0c3RhdGljIGluc3RhbGwobW9kOiBNb2QpIHtcclxuXHRcdG1vZC5tb2RJbnRlcmZhY2UuZXh0ZW5kT2JqZWN0KFNoYXBlRGVmaW5pdGlvbiwgKHsgJG9sZCB9KSA9PiAoe1xyXG5cdFx0XHRmcm9tU2hvcnRLZXk6IFN6RGVmaW5pdGlvbi5mcm9tU2hvcnRLZXkuYmluZChTekRlZmluaXRpb24pXHJcblx0XHR9KSk7XHJcblxyXG5cdFx0bW9kLm1vZEludGVyZmFjZS5leHRlbmRDbGFzcyhMb2dpY0dhdGVTeXN0ZW0sICh7ICRvbGQgfSkgPT4gKHtcclxuXHRcdFx0Y29tcHV0ZV9BTkFMWVpFKHBhcmFtZXRlcnMpIHtcclxuXHRcdFx0XHRsZXQgaXRlbSA9IHBhcmFtZXRlcnNbMF07XHJcblx0XHRcdFx0aWYgKCFpdGVtIHx8IGl0ZW0uZ2V0SXRlbVR5cGUoKSAhPT0gXCJzaGFwZVwiKSB7XHJcblx0XHRcdFx0XHQvLyBOb3QgYSBzaGFwZVxyXG5cdFx0XHRcdFx0cmV0dXJuIFtudWxsIGFzIGFueSBhcyBCYXNlSXRlbSwgbnVsbCBhcyBhbnkgYXMgQmFzZUl0ZW1dO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRsZXQgZGVmID0gKGl0ZW0gYXMgU2hhcGVJdGVtKS5kZWZpbml0aW9uO1xyXG5cdFx0XHRcdGlmIChkZWYgaW5zdGFuY2VvZiBTekRlZmluaXRpb24pIHtcclxuXHRcdFx0XHRcdHJldHVybiBkZWYuY29tcHV0ZV9BTkFMWVpFKHRoaXMucm9vdCEpIGFzIGFueTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0cmV0dXJuICRvbGQuY29tcHV0ZV9BTkFMWVpFLmNhbGwodGhpcywgcGFyYW1ldGVycyk7XHJcblx0XHRcdH1cclxuXHRcdH0pKVxyXG5cclxuXHR9XHJcbn1cclxuXHJcbiJdfQ==