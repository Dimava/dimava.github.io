import { globalConfig } from "shapez/core/config";
import { smoothenDpi } from "shapez/core/dpi_manager";
import { BaseItem } from "shapez/game/base_item";
import { enumColorToShortcode } from "shapez/game/colors";
import { THEME } from "shapez/game/theme";
import { types } from "shapez/savegame/serialization";
import { SzInfo } from "./layer";
import { SzContext2D } from "./SzContext2D";
const colorCharList = ['r', 'g', 'b', '-'];
const colorStringList = colorCharList.flatMap(a => colorCharList.flatMap(b => colorCharList.map(c => `${a}${b}${c}`)));
const colorStringEnum = Object.fromEntries(colorStringList.map(e => [e, e]));
export class SzColorItem extends BaseItem {
    color;
    static getId() {
        return "sz-color";
    }
    static getSchema() {
        return types.enum(colorStringEnum);
    }
    serialize() {
        return this.color;
    }
    deserialize(data) {
        this.color = data;
    }
    getItemType() {
        return "color";
    }
    getAsCopyableKey() {
        return this.color;
    }
    equalsImpl(other) {
        return this.color === other.color;
    }
    constructor(color) {
        super();
        this.color = color;
    }
    cachedSprite;
    getBackgroundColorAsResource() {
        return THEME.map.resources[this.color];
    }
    drawFullSizeOnCanvas(context, size) {
        // if (!this.cachedSprite) {
        // 	this.cachedSprite = Loader.getSprite("sprites/colors/" + this.color + ".png");
        // }
        // this.cachedSprite.drawCentered(context, size / 2, size / 2, size);
    }
    drawItemCenteredImpl(x, y, parameters, diameter) {
        const dpi = smoothenDpi(globalConfig.shapesSharpness * parameters.zoomLevel);
        const key = diameter + "/" + dpi + "/" + this.color;
        const canvas = parameters.root.buffers.getForKey({
            key: "shapedef",
            subKey: key,
            w: diameter,
            h: diameter,
            dpi,
            redrawMethod: this.internalGenerateShapeBuffer.bind(this),
        });
        parameters.context.drawImage(canvas, x - diameter / 2, y - diameter / 2, diameter, diameter);
    }
    internalGenerateShapeBuffer(canvas, ctx, w, h, dpi) {
        // prepare context
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 0.05;
        ctx.translate((w * dpi) / 2, (h * dpi) / 2);
        ctx.scale((dpi * w) / 2.3, (dpi * h) / 2.3);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = THEME.items.outline;
        ctx.lineWidth = THEME.items.outlineWidth / 10;
        ctx.rotate(-Math.PI / 2);
        ctx.fillStyle = THEME.items.circleBackground;
        ctx.beginPath();
        ctx.arc(0, 0, 1.15, 0, 2 * Math.PI);
        ctx.fill();
        new SzContext2D(ctx).saved(ctx => {
            ctx.fillStyle = '#00000022';
            for (let c of this.color) {
                ctx.fillStyle = { r: 'red', g: 'green', b: 'blue', '-': '#eeeeee44' }[c];
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 0.05;
                ctx.beginPath().arc(0, 0.5, 0.3, 0, 24).fill().stroke();
                ctx.rotate(8);
            }
        });
    }
    static fromColor(color) {
        let c = enumColorToShortcode[color];
        return new SzColorItem(c + c + c);
    }
    splitColor() {
        let c = '-';
        let s = this.color.replace(/[^-]/, C => (c = C, '-'));
        const color = { r: 'red', g: 'green', b: 'blue', '-': '-' }[c];
        let item = s == '---' ? null : new SzColorItem(s);
        return [color, item];
    }
    fillFromColor(other) {
        let s1 = this.color, s2 = other.color;
        while (s1.includes('-') && s2 != '---') {
            let l1 = s1.lastIndexOf('-');
            let c = '-';
            s2 = s2.replace(/[^-]/, C => (c = C, '-'));
            s1 = s1.replace(/-(?!.*-)/, c);
        }
        return [new SzColorItem(s1), s2 == '---' ? null : new SzColorItem(s2)];
    }
    splitIntoColors() {
        const toc = (c) => SzInfo.color.byChar[c].name;
        let s = this.color.split('').filter(e => e != '-');
        if (s.length == 0)
            return ['grey', null];
        if (s.length == 1)
            return [toc(s[0]), null];
        if (s.length == 2)
            return [toc(s[0]), toc(s[1])];
        s = s.sort();
        let c = SzInfo.color.byCombo[s.sort().join('')].name;
        return [c, c];
    }
    static install(mod) {
        mod.modInterface.registerItem(SzColorItem, data => new SzColorItem(data));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sb3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2hhcGVzdC9jb2xvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBR3RELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNqRCxPQUFPLEVBQWMsb0JBQW9CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV0RSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFMUMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3RELE9BQU8sRUFBaUMsTUFBTSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFNUMsTUFBTSxhQUFhLEdBQWdCLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDeEQsTUFBTSxlQUFlLEdBQ3BCLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FDekIsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUN6QixhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ3JCLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckMsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRzdFLE1BQU0sT0FBTyxXQUFZLFNBQVEsUUFBUTtJQUN4QyxLQUFLLENBQWU7SUFD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SyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBZ0IsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNwRSxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2YsQ0FBQztJQUVELE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBUTtRQUN0QixHQUFHLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzNFLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdsb2JhbENvbmZpZyB9IGZyb20gXCJzaGFwZXovY29yZS9jb25maWdcIjtcclxuaW1wb3J0IHsgc21vb3RoZW5EcGkgfSBmcm9tIFwic2hhcGV6L2NvcmUvZHBpX21hbmFnZXJcIjtcclxuaW1wb3J0IHsgRHJhd1BhcmFtZXRlcnMgfSBmcm9tIFwic2hhcGV6L2NvcmUvZHJhd19wYXJhbWV0ZXJzXCI7XHJcbmltcG9ydCB7IEF0bGFzU3ByaXRlIH0gZnJvbSBcInNoYXBlei9jb3JlL3Nwcml0ZXNcIjtcclxuaW1wb3J0IHsgQmFzZUl0ZW0gfSBmcm9tIFwic2hhcGV6L2dhbWUvYmFzZV9pdGVtXCI7XHJcbmltcG9ydCB7IGVudW1Db2xvcnMsIGVudW1Db2xvclRvU2hvcnRjb2RlIH0gZnJvbSBcInNoYXBlei9nYW1lL2NvbG9yc1wiO1xyXG5pbXBvcnQgeyBDb2xvckl0ZW0gfSBmcm9tIFwic2hhcGV6L2dhbWUvaXRlbXMvY29sb3JfaXRlbVwiO1xyXG5pbXBvcnQgeyBUSEVNRSB9IGZyb20gXCJzaGFwZXovZ2FtZS90aGVtZVwiO1xyXG5pbXBvcnQgeyBNb2QgfSBmcm9tIFwic2hhcGV6L21vZHMvbW9kXCI7XHJcbmltcG9ydCB7IHR5cGVzIH0gZnJvbSBcInNoYXBlei9zYXZlZ2FtZS9zZXJpYWxpemF0aW9uXCI7XHJcbmltcG9ydCB7IGNvbG9yLCBjb2xvckNoYXIsIGNvbG9yU3RyaW5nLCBTekluZm8gfSBmcm9tIFwiLi9sYXllclwiO1xyXG5pbXBvcnQgeyBTekNvbnRleHQyRCB9IGZyb20gXCIuL1N6Q29udGV4dDJEXCI7XHJcblxyXG5jb25zdCBjb2xvckNoYXJMaXN0OiBjb2xvckNoYXJbXSA9IFsncicsICdnJywgJ2InLCAnLSddO1xyXG5jb25zdCBjb2xvclN0cmluZ0xpc3QgPVxyXG5cdGNvbG9yQ2hhckxpc3QuZmxhdE1hcChhID0+XHJcblx0XHRjb2xvckNoYXJMaXN0LmZsYXRNYXAoYiA9PlxyXG5cdFx0XHRjb2xvckNoYXJMaXN0Lm1hcChjID0+XHJcblx0XHRcdFx0YCR7YX0ke2J9JHtjfWAgYXMgY29sb3JTdHJpbmcpKSk7XHJcbmNvbnN0IGNvbG9yU3RyaW5nRW51bSA9IE9iamVjdC5mcm9tRW50cmllcyhjb2xvclN0cmluZ0xpc3QubWFwKGUgPT4gW2UsIGVdKSk7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFN6Q29sb3JJdGVtIGV4dGVuZHMgQmFzZUl0ZW0gaW1wbGVtZW50cyBDb2xvckl0ZW0ge1xyXG5cdGNvbG9yITogY29sb3JTdHJpbmc7XHJcblx0c3RhdGljIGdldElkKCkge1xyXG5cdFx0cmV0dXJuIFwic3otY29sb3JcIjtcclxuXHR9XHJcblx0c3RhdGljIGdldFNjaGVtYSgpIHtcclxuXHRcdHJldHVybiB0eXBlcy5lbnVtKGNvbG9yU3RyaW5nRW51bSk7XHJcblx0fVxyXG5cdHNlcmlhbGl6ZSgpIHtcclxuXHRcdHJldHVybiB0aGlzLmNvbG9yO1xyXG5cdH1cclxuXHRkZXNlcmlhbGl6ZShkYXRhOiBhbnkpIHtcclxuXHRcdHRoaXMuY29sb3IgPSBkYXRhO1xyXG5cdH1cclxuXHRnZXRJdGVtVHlwZSgpIHtcclxuXHRcdHJldHVybiBcImNvbG9yXCIgYXMgY29uc3Q7XHJcblx0fVxyXG5cdGdldEFzQ29weWFibGVLZXkoKSB7XHJcblx0XHRyZXR1cm4gdGhpcy5jb2xvcjtcclxuXHR9XHJcblx0ZXF1YWxzSW1wbChvdGhlcjogQmFzZUl0ZW0pIHtcclxuXHRcdHJldHVybiB0aGlzLmNvbG9yID09PSAob3RoZXIgYXMgYW55IGFzIFN6Q29sb3JJdGVtKS5jb2xvcjtcclxuXHR9XHJcblx0Y29uc3RydWN0b3IoY29sb3I6IGNvbG9yU3RyaW5nKSB7XHJcblx0XHRzdXBlcigpO1xyXG5cdFx0dGhpcy5jb2xvciA9IGNvbG9yO1xyXG5cdH1cclxuXHRjYWNoZWRTcHJpdGUhOiBBdGxhc1Nwcml0ZTtcclxuXHRnZXRCYWNrZ3JvdW5kQ29sb3JBc1Jlc291cmNlKCkge1xyXG5cdFx0cmV0dXJuIFRIRU1FLm1hcC5yZXNvdXJjZXNbdGhpcy5jb2xvcl07XHJcblx0fVxyXG5cdGRyYXdGdWxsU2l6ZU9uQ2FudmFzKGNvbnRleHQ6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgc2l6ZTogbnVtYmVyKSB7XHJcblx0XHQvLyBpZiAoIXRoaXMuY2FjaGVkU3ByaXRlKSB7XHJcblx0XHQvLyBcdHRoaXMuY2FjaGVkU3ByaXRlID0gTG9hZGVyLmdldFNwcml0ZShcInNwcml0ZXMvY29sb3JzL1wiICsgdGhpcy5jb2xvciArIFwiLnBuZ1wiKTtcclxuXHRcdC8vIH1cclxuXHRcdC8vIHRoaXMuY2FjaGVkU3ByaXRlLmRyYXdDZW50ZXJlZChjb250ZXh0LCBzaXplIC8gMiwgc2l6ZSAvIDIsIHNpemUpO1xyXG5cdH1cclxuXHRkcmF3SXRlbUNlbnRlcmVkSW1wbCh4OiBudW1iZXIsIHk6IG51bWJlciwgcGFyYW1ldGVyczogRHJhd1BhcmFtZXRlcnMsIGRpYW1ldGVyOiBudW1iZXIpOiB2b2lkIHtcclxuXHRcdGNvbnN0IGRwaSA9IHNtb290aGVuRHBpKGdsb2JhbENvbmZpZy5zaGFwZXNTaGFycG5lc3MgKiBwYXJhbWV0ZXJzLnpvb21MZXZlbCk7XHJcblx0XHRjb25zdCBrZXkgPSBkaWFtZXRlciArIFwiL1wiICsgZHBpICsgXCIvXCIgKyB0aGlzLmNvbG9yO1xyXG5cdFx0Y29uc3QgY2FudmFzID0gcGFyYW1ldGVycy5yb290LmJ1ZmZlcnMuZ2V0Rm9yS2V5KHtcclxuXHRcdFx0a2V5OiBcInNoYXBlZGVmXCIsXHJcblx0XHRcdHN1YktleToga2V5LFxyXG5cdFx0XHR3OiBkaWFtZXRlcixcclxuXHRcdFx0aDogZGlhbWV0ZXIsXHJcblx0XHRcdGRwaSxcclxuXHRcdFx0cmVkcmF3TWV0aG9kOiB0aGlzLmludGVybmFsR2VuZXJhdGVTaGFwZUJ1ZmZlci5iaW5kKHRoaXMpLFxyXG5cdFx0fSk7XHJcblx0XHRwYXJhbWV0ZXJzLmNvbnRleHQuZHJhd0ltYWdlKGNhbnZhcywgeCAtIGRpYW1ldGVyIC8gMiwgeSAtIGRpYW1ldGVyIC8gMiwgZGlhbWV0ZXIsIGRpYW1ldGVyKTtcclxuXHJcblx0fVxyXG5cclxuXHJcblx0aW50ZXJuYWxHZW5lcmF0ZVNoYXBlQnVmZmVyKGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQsIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCB3OiBudW1iZXIsIGg6IG51bWJlciwgZHBpOiBudW1iZXIpOiB2b2lkIHtcclxuXHRcdC8vIHByZXBhcmUgY29udGV4dFxyXG5cdFx0Y3R4LmxpbmVDYXAgPSAncm91bmQnO1xyXG5cdFx0Y3R4LmxpbmVKb2luID0gJ3JvdW5kJztcclxuXHRcdGN0eC5saW5lV2lkdGggPSAwLjA1O1xyXG5cclxuXHRcdGN0eC50cmFuc2xhdGUoKHcgKiBkcGkpIC8gMiwgKGggKiBkcGkpIC8gMik7XHJcblx0XHRjdHguc2NhbGUoKGRwaSAqIHcpIC8gMi4zLCAoZHBpICogaCkgLyAyLjMpO1xyXG5cdFx0Y3R4LmxpbmVDYXAgPSAncm91bmQnO1xyXG5cdFx0Y3R4LmxpbmVKb2luID0gJ3JvdW5kJztcclxuXHRcdGN0eC5zdHJva2VTdHlsZSA9IFRIRU1FLml0ZW1zLm91dGxpbmU7XHJcblx0XHRjdHgubGluZVdpZHRoID0gVEhFTUUuaXRlbXMub3V0bGluZVdpZHRoIC8gMTA7XHJcblxyXG5cdFx0Y3R4LnJvdGF0ZSgtTWF0aC5QSSAvIDIpO1xyXG5cclxuXHRcdGN0eC5maWxsU3R5bGUgPSBUSEVNRS5pdGVtcy5jaXJjbGVCYWNrZ3JvdW5kO1xyXG5cdFx0Y3R4LmJlZ2luUGF0aCgpO1xyXG5cdFx0Y3R4LmFyYygwLCAwLCAxLjE1LCAwLCAyICogTWF0aC5QSSk7XHJcblx0XHRjdHguZmlsbCgpO1xyXG5cclxuXHRcdG5ldyBTekNvbnRleHQyRChjdHgpLnNhdmVkKGN0eCA9PiB7XHJcblx0XHRcdGN0eC5maWxsU3R5bGUgPSAnIzAwMDAwMDIyJztcclxuXHRcdFx0Zm9yIChsZXQgYyBvZiB0aGlzLmNvbG9yKSB7XHJcblx0XHRcdFx0Y3R4LmZpbGxTdHlsZSA9IHsgcjogJ3JlZCcsIGc6ICdncmVlbicsIGI6ICdibHVlJywgJy0nOiAnI2VlZWVlZTQ0JyB9W2NdITtcclxuXHRcdFx0XHRjdHguc3Ryb2tlU3R5bGUgPSAnYmxhY2snO1xyXG5cdFx0XHRcdGN0eC5saW5lV2lkdGggPSAwLjA1O1xyXG5cdFx0XHRcdGN0eC5iZWdpblBhdGgoKS5hcmMoMCwgMC41LCAwLjMsIDAsIDI0KS5maWxsKCkuc3Ryb2tlKCk7XHJcblx0XHRcdFx0Y3R4LnJvdGF0ZSg4KTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgZnJvbUNvbG9yKGNvbG9yOiBlbnVtQ29sb3JzKSB7XHJcblx0XHRsZXQgYyA9IGVudW1Db2xvclRvU2hvcnRjb2RlW2NvbG9yXTtcclxuXHRcdHJldHVybiBuZXcgU3pDb2xvckl0ZW0oYyArIGMgKyBjIGFzIGFueSk7XHJcblx0fVxyXG5cclxuXHRzcGxpdENvbG9yKCk6IFtlbnVtQ29sb3JzLCBTekNvbG9ySXRlbSB8IG51bGxdIHtcclxuXHRcdGxldCBjID0gJy0nO1xyXG5cdFx0bGV0IHMgPSB0aGlzLmNvbG9yLnJlcGxhY2UoL1teLV0vLCBDID0+IChjID0gQywgJy0nKSk7XHJcblx0XHRjb25zdCBjb2xvciA9IHsgcjogJ3JlZCcsIGc6ICdncmVlbicsIGI6ICdibHVlJywgJy0nOiAnLScgfVtjXSE7XHJcblx0XHRsZXQgaXRlbSA9IHMgPT0gJy0tLScgPyBudWxsIDogbmV3IFN6Q29sb3JJdGVtKHMgYXMgYW55KTtcclxuXHRcdHJldHVybiBbY29sb3IsIGl0ZW1dO1xyXG5cdH1cclxuXHJcblx0ZmlsbEZyb21Db2xvcihvdGhlcjogU3pDb2xvckl0ZW0pOiBbU3pDb2xvckl0ZW0sIFN6Q29sb3JJdGVtIHwgbnVsbF0ge1xyXG5cdFx0bGV0IHMxOiBzdHJpbmcgPSB0aGlzLmNvbG9yLCBzMjogc3RyaW5nID0gb3RoZXIuY29sb3I7XHJcblx0XHR3aGlsZSAoczEuaW5jbHVkZXMoJy0nKSAmJiBzMiAhPSAnLS0tJykge1xyXG5cdFx0XHRsZXQgbDEgPSBzMS5sYXN0SW5kZXhPZignLScpO1xyXG5cdFx0XHRsZXQgYyA9ICctJztcclxuXHRcdFx0czIgPSBzMi5yZXBsYWNlKC9bXi1dLywgQyA9PiAoYyA9IEMsICctJykpO1xyXG5cdFx0XHRzMSA9IHMxLnJlcGxhY2UoLy0oPyEuKi0pLywgYyk7XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gW25ldyBTekNvbG9ySXRlbShzMSBhcyBhbnkpLCBzMiA9PSAnLS0tJyA/IG51bGwgOiBuZXcgU3pDb2xvckl0ZW0oczIgYXMgYW55KV07XHJcblx0fVxyXG5cclxuXHRzcGxpdEludG9Db2xvcnMoKTogW2NvbG9yLCBjb2xvciB8IG51bGxdIHtcclxuXHRcdGNvbnN0IHRvYyA9IChjOiBzdHJpbmcpID0+IFN6SW5mby5jb2xvci5ieUNoYXJbY10ubmFtZVxyXG5cdFx0bGV0IHMgPSB0aGlzLmNvbG9yLnNwbGl0KCcnKS5maWx0ZXIoZSA9PiBlICE9ICctJyk7XHJcblx0XHRpZiAocy5sZW5ndGggPT0gMCkgcmV0dXJuIFsnZ3JleScsIG51bGxdO1xyXG5cdFx0aWYgKHMubGVuZ3RoID09IDEpIHJldHVybiBbdG9jKHNbMF0pLCBudWxsXTtcclxuXHRcdGlmIChzLmxlbmd0aCA9PSAyKSByZXR1cm4gW3RvYyhzWzBdKSwgdG9jKHNbMV0pXTtcclxuXHRcdHMgPSBzLnNvcnQoKTtcclxuXHRcdGxldCBjID0gU3pJbmZvLmNvbG9yLmJ5Q29tYm9bcy5zb3J0KCkuam9pbignJykgYXMgY29sb3JTdHJpbmddLm5hbWU7XHJcblx0XHRyZXR1cm4gW2MsIGNdO1xyXG5cdH1cclxuXHJcblx0c3RhdGljIGluc3RhbGwobW9kOiBNb2QpIHtcclxuXHRcdG1vZC5tb2RJbnRlcmZhY2UucmVnaXN0ZXJJdGVtKFN6Q29sb3JJdGVtLCBkYXRhID0+IG5ldyBTekNvbG9ySXRlbShkYXRhKSk7XHJcblx0fVxyXG59Il19