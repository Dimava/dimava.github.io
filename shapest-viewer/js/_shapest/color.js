import { globalConfig } from "shapez/core/config";
import { smoothenDpi } from "shapez/core/dpi_manager";
import { BaseItem } from "shapez/game/base_item";
import { enumColorToShortcode } from "shapez/game/colors";
import { THEME } from "shapez/game/theme";
import { types } from "shapez/savegame/serialization";
import { SzInfo } from "./layer";
import { SzContext2D } from "./SzContext2D";
const colorCharList = ['r', 'g', 'b', '-'];
const colorStringList = colorCharList.flatMap(a => colorCharList.flatMap(b => colorCharList.map(c => `${a}${b}${c}`)));
const colorStringEnum = Object.fromEntries(colorStringList.map(e => [e, e]));
export class SzColorItem extends BaseItem {
    color;
    static getId() {
        return "sz-color";
    }
    static getSchema() {
        return types.enum(colorStringEnum);
    }
    serialize() {
        return this.color;
    }
    deserialize(data) {
        this.color = data;
    }
    getItemType() {
        return "color";
    }
    getAsCopyableKey() {
        return this.color;
    }
    equalsImpl(other) {
        return this.color === other.color;
    }
    constructor(color) {
        super();
        this.color = color;
    }
    cachedSprite;
    getBackgroundColorAsResource() {
        return THEME.map.resources[SzInfo.color.byChar[this.color[0]].name];
    }
    drawFullSizeOnCanvas(context, size) {
        // if (!this.cachedSprite) {
        // 	this.cachedSprite = Loader.getSprite("sprites/colors/" + this.color + ".png");
        // }
        // this.cachedSprite.drawCentered(context, size / 2, size / 2, size);
    }
    drawItemCenteredImpl(x, y, parameters, diameter) {
        const dpi = smoothenDpi(globalConfig.shapesSharpness * parameters.zoomLevel);
        const key = diameter + "/" + dpi + "/" + this.color;
        const canvas = parameters.root.buffers.getForKey({
            key: "shapedef",
            subKey: key,
            w: diameter,
            h: diameter,
            dpi,
            redrawMethod: this.internalGenerateShapeBuffer.bind(this),
        });
        parameters.context.drawImage(canvas, x - diameter / 2, y - diameter / 2, diameter, diameter);
    }
    internalGenerateShapeBuffer(canvas, ctx, w, h, dpi) {
        // prepare context
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 0.05;
        ctx.translate((w * dpi) / 2, (h * dpi) / 2);
        ctx.scale((dpi * w) / 2.3, (dpi * h) / 2.3);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = THEME.items.outline;
        ctx.lineWidth = THEME.items.outlineWidth / 10;
        ctx.rotate(-Math.PI / 2);
        ctx.fillStyle = THEME.items.circleBackground;
        ctx.beginPath();
        ctx.arc(0, 0, 1.15, 0, 2 * Math.PI);
        ctx.fill();
        new SzContext2D(ctx).saved(ctx => {
            ctx.fillStyle = '#00000022';
            for (let c of this.color) {
                ctx.fillStyle = { r: 'red', g: 'green', b: 'blue', '-': '#eeeeee44' }[c];
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 0.05;
                ctx.beginPath().arc(0, 0.5, 0.3, 0, 24).fill().stroke();
                ctx.rotate(8);
            }
        });
    }
    static fromColor(color) {
        let c = enumColorToShortcode[color];
        return new SzColorItem(c + c + c);
    }
    splitColor() {
        let c = '-';
        let s = this.color.replace(/[^-]/, C => (c = C, '-'));
        const color = { r: 'red', g: 'green', b: 'blue', '-': '-' }[c];
        let item = s == '---' ? null : new SzColorItem(s);
        return [color, item];
    }
    fillFromColor(other) {
        let s1 = this.color, s2 = other.color;
        while (s1.includes('-') && s2 != '---') {
            let l1 = s1.lastIndexOf('-');
            let c = '-';
            s2 = s2.replace(/[^-]/, C => (c = C, '-'));
            s1 = s1.replace(/-(?!.*-)/, c);
        }
        return [new SzColorItem(s1), s2 == '---' ? null : new SzColorItem(s2)];
    }
    splitIntoColors() {
        const toc = (c) => SzInfo.color.byChar[c].name;
        let s = this.color.split('').filter(e => e != '-');
        if (s.length == 0)
            return ['grey', null];
        if (s.length == 1)
            return [toc(s[0]), null];
        if (s.length == 2)
            return [toc(s[0]), toc(s[1])];
        s = s.sort();
        let c = SzInfo.color.byCombo[s.sort().join('')].name;
        return [c, c];
    }
    static install(mod) {
        mod.modInterface.registerItem(SzColorItem, data => new SzColorItem(data));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sb3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvX3NoYXBlc3QvY29sb3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUd0RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDakQsT0FBTyxFQUFjLG9CQUFvQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFdEUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRTFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN0RCxPQUFPLEVBQWlDLE1BQU0sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTVDLE1BQU0sYUFBYSxHQUFnQixDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ3hELE1BQU0sZUFBZSxHQUNwQixhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ3pCLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FDekIsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUNyQixHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3JDLE1BQU0sZUFBZSxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUc3RSxNQUFNLE9BQU8sV0FBWSxTQUFRLFFBQVE7SUFDeEMsS0FBSyxDQUFlO0lB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QUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFnQixDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ3BFLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDZixDQUFDO0lBRUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFRO1FBQ3RCLEdBQUcsQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDM0UsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2xvYmFsQ29uZmlnIH0gZnJvbSBcInNoYXBlei9jb3JlL2NvbmZpZ1wiO1xyXG5pbXBvcnQgeyBzbW9vdGhlbkRwaSB9IGZyb20gXCJzaGFwZXovY29yZS9kcGlfbWFuYWdlclwiO1xyXG5pbXBvcnQgeyBEcmF3UGFyYW1ldGVycyB9IGZyb20gXCJzaGFwZXovY29yZS9kcmF3X3BhcmFtZXRlcnNcIjtcclxuaW1wb3J0IHsgQXRsYXNTcHJpdGUgfSBmcm9tIFwic2hhcGV6L2NvcmUvc3ByaXRlc1wiO1xyXG5pbXBvcnQgeyBCYXNlSXRlbSB9IGZyb20gXCJzaGFwZXovZ2FtZS9iYXNlX2l0ZW1cIjtcclxuaW1wb3J0IHsgZW51bUNvbG9ycywgZW51bUNvbG9yVG9TaG9ydGNvZGUgfSBmcm9tIFwic2hhcGV6L2dhbWUvY29sb3JzXCI7XHJcbmltcG9ydCB7IENvbG9ySXRlbSB9IGZyb20gXCJzaGFwZXovZ2FtZS9pdGVtcy9jb2xvcl9pdGVtXCI7XHJcbmltcG9ydCB7IFRIRU1FIH0gZnJvbSBcInNoYXBlei9nYW1lL3RoZW1lXCI7XHJcbmltcG9ydCB7IE1vZCB9IGZyb20gXCJzaGFwZXovbW9kcy9tb2RcIjtcclxuaW1wb3J0IHsgdHlwZXMgfSBmcm9tIFwic2hhcGV6L3NhdmVnYW1lL3NlcmlhbGl6YXRpb25cIjtcclxuaW1wb3J0IHsgY29sb3IsIGNvbG9yQ2hhciwgY29sb3JTdHJpbmcsIFN6SW5mbyB9IGZyb20gXCIuL2xheWVyXCI7XHJcbmltcG9ydCB7IFN6Q29udGV4dDJEIH0gZnJvbSBcIi4vU3pDb250ZXh0MkRcIjtcclxuXHJcbmNvbnN0IGNvbG9yQ2hhckxpc3Q6IGNvbG9yQ2hhcltdID0gWydyJywgJ2cnLCAnYicsICctJ107XHJcbmNvbnN0IGNvbG9yU3RyaW5nTGlzdCA9XHJcblx0Y29sb3JDaGFyTGlzdC5mbGF0TWFwKGEgPT5cclxuXHRcdGNvbG9yQ2hhckxpc3QuZmxhdE1hcChiID0+XHJcblx0XHRcdGNvbG9yQ2hhckxpc3QubWFwKGMgPT5cclxuXHRcdFx0XHRgJHthfSR7Yn0ke2N9YCBhcyBjb2xvclN0cmluZykpKTtcclxuY29uc3QgY29sb3JTdHJpbmdFbnVtID0gT2JqZWN0LmZyb21FbnRyaWVzKGNvbG9yU3RyaW5nTGlzdC5tYXAoZSA9PiBbZSwgZV0pKTtcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgU3pDb2xvckl0ZW0gZXh0ZW5kcyBCYXNlSXRlbSBpbXBsZW1lbnRzIENvbG9ySXRlbSB7XHJcblx0Y29sb3IhOiBjb2xvclN0cmluZztcclxuXHRzdGF0aWMgZ2V0SWQoKSB7XHJcblx0XHRyZXR1cm4gXCJzei1jb2xvclwiO1xyXG5cdH1cclxuXHRzdGF0aWMgZ2V0U2NoZW1hKCkge1xyXG5cdFx0cmV0dXJuIHR5cGVzLmVudW0oY29sb3JTdHJpbmdFbnVtKTtcclxuXHR9XHJcblx0c2VyaWFsaXplKCkge1xyXG5cdFx0cmV0dXJuIHRoaXMuY29sb3I7XHJcblx0fVxyXG5cdGRlc2VyaWFsaXplKGRhdGE6IGFueSkge1xyXG5cdFx0dGhpcy5jb2xvciA9IGRhdGE7XHJcblx0fVxyXG5cdGdldEl0ZW1UeXBlKCkge1xyXG5cdFx0cmV0dXJuIFwiY29sb3JcIiBhcyBjb25zdDtcclxuXHR9XHJcblx0Z2V0QXNDb3B5YWJsZUtleSgpIHtcclxuXHRcdHJldHVybiB0aGlzLmNvbG9yO1xyXG5cdH1cclxuXHRlcXVhbHNJbXBsKG90aGVyOiBCYXNlSXRlbSkge1xyXG5cdFx0cmV0dXJuIHRoaXMuY29sb3IgPT09IChvdGhlciBhcyBhbnkgYXMgU3pDb2xvckl0ZW0pLmNvbG9yO1xyXG5cdH1cclxuXHRjb25zdHJ1Y3Rvcihjb2xvcjogY29sb3JTdHJpbmcpIHtcclxuXHRcdHN1cGVyKCk7XHJcblx0XHR0aGlzLmNvbG9yID0gY29sb3I7XHJcblx0fVxyXG5cdGNhY2hlZFNwcml0ZSE6IEF0bGFzU3ByaXRlO1xyXG5cdGdldEJhY2tncm91bmRDb2xvckFzUmVzb3VyY2UoKSB7XHJcblx0XHRyZXR1cm4gVEhFTUUubWFwLnJlc291cmNlc1tcclxuXHRcdFx0U3pJbmZvLmNvbG9yLmJ5Q2hhclt0aGlzLmNvbG9yWzBdXS5uYW1lXHJcblx0XHRdO1xyXG5cdH1cclxuXHRkcmF3RnVsbFNpemVPbkNhbnZhcyhjb250ZXh0OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsIHNpemU6IG51bWJlcikge1xyXG5cdFx0Ly8gaWYgKCF0aGlzLmNhY2hlZFNwcml0ZSkge1xyXG5cdFx0Ly8gXHR0aGlzLmNhY2hlZFNwcml0ZSA9IExvYWRlci5nZXRTcHJpdGUoXCJzcHJpdGVzL2NvbG9ycy9cIiArIHRoaXMuY29sb3IgKyBcIi5wbmdcIik7XHJcblx0XHQvLyB9XHJcblx0XHQvLyB0aGlzLmNhY2hlZFNwcml0ZS5kcmF3Q2VudGVyZWQoY29udGV4dCwgc2l6ZSAvIDIsIHNpemUgLyAyLCBzaXplKTtcclxuXHR9XHJcblx0ZHJhd0l0ZW1DZW50ZXJlZEltcGwoeDogbnVtYmVyLCB5OiBudW1iZXIsIHBhcmFtZXRlcnM6IERyYXdQYXJhbWV0ZXJzLCBkaWFtZXRlcjogbnVtYmVyKTogdm9pZCB7XHJcblx0XHRjb25zdCBkcGkgPSBzbW9vdGhlbkRwaShnbG9iYWxDb25maWcuc2hhcGVzU2hhcnBuZXNzICogcGFyYW1ldGVycy56b29tTGV2ZWwpO1xyXG5cdFx0Y29uc3Qga2V5ID0gZGlhbWV0ZXIgKyBcIi9cIiArIGRwaSArIFwiL1wiICsgdGhpcy5jb2xvcjtcclxuXHRcdGNvbnN0IGNhbnZhcyA9IHBhcmFtZXRlcnMucm9vdC5idWZmZXJzLmdldEZvcktleSh7XHJcblx0XHRcdGtleTogXCJzaGFwZWRlZlwiLFxyXG5cdFx0XHRzdWJLZXk6IGtleSxcclxuXHRcdFx0dzogZGlhbWV0ZXIsXHJcblx0XHRcdGg6IGRpYW1ldGVyLFxyXG5cdFx0XHRkcGksXHJcblx0XHRcdHJlZHJhd01ldGhvZDogdGhpcy5pbnRlcm5hbEdlbmVyYXRlU2hhcGVCdWZmZXIuYmluZCh0aGlzKSxcclxuXHRcdH0pO1xyXG5cdFx0cGFyYW1ldGVycy5jb250ZXh0LmRyYXdJbWFnZShjYW52YXMsIHggLSBkaWFtZXRlciAvIDIsIHkgLSBkaWFtZXRlciAvIDIsIGRpYW1ldGVyLCBkaWFtZXRlcik7XHJcblxyXG5cdH1cclxuXHJcblxyXG5cdGludGVybmFsR2VuZXJhdGVTaGFwZUJ1ZmZlcihjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50LCBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgdzogbnVtYmVyLCBoOiBudW1iZXIsIGRwaTogbnVtYmVyKTogdm9pZCB7XHJcblx0XHQvLyBwcmVwYXJlIGNvbnRleHRcclxuXHRcdGN0eC5saW5lQ2FwID0gJ3JvdW5kJztcclxuXHRcdGN0eC5saW5lSm9pbiA9ICdyb3VuZCc7XHJcblx0XHRjdHgubGluZVdpZHRoID0gMC4wNTtcclxuXHJcblx0XHRjdHgudHJhbnNsYXRlKCh3ICogZHBpKSAvIDIsIChoICogZHBpKSAvIDIpO1xyXG5cdFx0Y3R4LnNjYWxlKChkcGkgKiB3KSAvIDIuMywgKGRwaSAqIGgpIC8gMi4zKTtcclxuXHRcdGN0eC5saW5lQ2FwID0gJ3JvdW5kJztcclxuXHRcdGN0eC5saW5lSm9pbiA9ICdyb3VuZCc7XHJcblx0XHRjdHguc3Ryb2tlU3R5bGUgPSBUSEVNRS5pdGVtcy5vdXRsaW5lO1xyXG5cdFx0Y3R4LmxpbmVXaWR0aCA9IFRIRU1FLml0ZW1zLm91dGxpbmVXaWR0aCAvIDEwO1xyXG5cclxuXHRcdGN0eC5yb3RhdGUoLU1hdGguUEkgLyAyKTtcclxuXHJcblx0XHRjdHguZmlsbFN0eWxlID0gVEhFTUUuaXRlbXMuY2lyY2xlQmFja2dyb3VuZDtcclxuXHRcdGN0eC5iZWdpblBhdGgoKTtcclxuXHRcdGN0eC5hcmMoMCwgMCwgMS4xNSwgMCwgMiAqIE1hdGguUEkpO1xyXG5cdFx0Y3R4LmZpbGwoKTtcclxuXHJcblx0XHRuZXcgU3pDb250ZXh0MkQoY3R4KS5zYXZlZChjdHggPT4ge1xyXG5cdFx0XHRjdHguZmlsbFN0eWxlID0gJyMwMDAwMDAyMic7XHJcblx0XHRcdGZvciAobGV0IGMgb2YgdGhpcy5jb2xvcikge1xyXG5cdFx0XHRcdGN0eC5maWxsU3R5bGUgPSB7IHI6ICdyZWQnLCBnOiAnZ3JlZW4nLCBiOiAnYmx1ZScsICctJzogJyNlZWVlZWU0NCcgfVtjXSE7XHJcblx0XHRcdFx0Y3R4LnN0cm9rZVN0eWxlID0gJ2JsYWNrJztcclxuXHRcdFx0XHRjdHgubGluZVdpZHRoID0gMC4wNTtcclxuXHRcdFx0XHRjdHguYmVnaW5QYXRoKCkuYXJjKDAsIDAuNSwgMC4zLCAwLCAyNCkuZmlsbCgpLnN0cm9rZSgpO1xyXG5cdFx0XHRcdGN0eC5yb3RhdGUoOCk7XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblx0c3RhdGljIGZyb21Db2xvcihjb2xvcjogZW51bUNvbG9ycykge1xyXG5cdFx0bGV0IGMgPSBlbnVtQ29sb3JUb1Nob3J0Y29kZVtjb2xvcl07XHJcblx0XHRyZXR1cm4gbmV3IFN6Q29sb3JJdGVtKGMgKyBjICsgYyBhcyBhbnkpO1xyXG5cdH1cclxuXHJcblx0c3BsaXRDb2xvcigpOiBbZW51bUNvbG9ycywgU3pDb2xvckl0ZW0gfCBudWxsXSB7XHJcblx0XHRsZXQgYyA9ICctJztcclxuXHRcdGxldCBzID0gdGhpcy5jb2xvci5yZXBsYWNlKC9bXi1dLywgQyA9PiAoYyA9IEMsICctJykpO1xyXG5cdFx0Y29uc3QgY29sb3IgPSB7IHI6ICdyZWQnLCBnOiAnZ3JlZW4nLCBiOiAnYmx1ZScsICctJzogJy0nIH1bY10hO1xyXG5cdFx0bGV0IGl0ZW0gPSBzID09ICctLS0nID8gbnVsbCA6IG5ldyBTekNvbG9ySXRlbShzIGFzIGFueSk7XHJcblx0XHRyZXR1cm4gW2NvbG9yLCBpdGVtXTtcclxuXHR9XHJcblxyXG5cdGZpbGxGcm9tQ29sb3Iob3RoZXI6IFN6Q29sb3JJdGVtKTogW1N6Q29sb3JJdGVtLCBTekNvbG9ySXRlbSB8IG51bGxdIHtcclxuXHRcdGxldCBzMTogc3RyaW5nID0gdGhpcy5jb2xvciwgczI6IHN0cmluZyA9IG90aGVyLmNvbG9yO1xyXG5cdFx0d2hpbGUgKHMxLmluY2x1ZGVzKCctJykgJiYgczIgIT0gJy0tLScpIHtcclxuXHRcdFx0bGV0IGwxID0gczEubGFzdEluZGV4T2YoJy0nKTtcclxuXHRcdFx0bGV0IGMgPSAnLSc7XHJcblx0XHRcdHMyID0gczIucmVwbGFjZSgvW14tXS8sIEMgPT4gKGMgPSBDLCAnLScpKTtcclxuXHRcdFx0czEgPSBzMS5yZXBsYWNlKC8tKD8hLiotKS8sIGMpO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIFtuZXcgU3pDb2xvckl0ZW0oczEgYXMgYW55KSwgczIgPT0gJy0tLScgPyBudWxsIDogbmV3IFN6Q29sb3JJdGVtKHMyIGFzIGFueSldO1xyXG5cdH1cclxuXHJcblx0c3BsaXRJbnRvQ29sb3JzKCk6IFtjb2xvciwgY29sb3IgfCBudWxsXSB7XHJcblx0XHRjb25zdCB0b2MgPSAoYzogc3RyaW5nKSA9PiBTekluZm8uY29sb3IuYnlDaGFyW2NdLm5hbWVcclxuXHRcdGxldCBzID0gdGhpcy5jb2xvci5zcGxpdCgnJykuZmlsdGVyKGUgPT4gZSAhPSAnLScpO1xyXG5cdFx0aWYgKHMubGVuZ3RoID09IDApIHJldHVybiBbJ2dyZXknLCBudWxsXTtcclxuXHRcdGlmIChzLmxlbmd0aCA9PSAxKSByZXR1cm4gW3RvYyhzWzBdKSwgbnVsbF07XHJcblx0XHRpZiAocy5sZW5ndGggPT0gMikgcmV0dXJuIFt0b2Moc1swXSksIHRvYyhzWzFdKV07XHJcblx0XHRzID0gcy5zb3J0KCk7XHJcblx0XHRsZXQgYyA9IFN6SW5mby5jb2xvci5ieUNvbWJvW3Muc29ydCgpLmpvaW4oJycpIGFzIGNvbG9yU3RyaW5nXS5uYW1lO1xyXG5cdFx0cmV0dXJuIFtjLCBjXTtcclxuXHR9XHJcblxyXG5cdHN0YXRpYyBpbnN0YWxsKG1vZDogTW9kKSB7XHJcblx0XHRtb2QubW9kSW50ZXJmYWNlLnJlZ2lzdGVySXRlbShTekNvbG9ySXRlbSwgZGF0YSA9PiBuZXcgU3pDb2xvckl0ZW0oZGF0YSkpO1xyXG5cdH1cclxufSJdfQ==