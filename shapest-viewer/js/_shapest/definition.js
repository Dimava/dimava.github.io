import { makeOffscreenBuffer } from "shapez/core/buffer_utils";
import { globalConfig } from "shapez/core/config";
import { smoothenDpi } from "shapez/core/dpi_manager";
import { ShapeDefinition } from "shapez/game/shape_definition";
import { THEME } from "shapez/game/theme";
import { BasicSerializableObject } from "shapez/savegame/serialization";
import { SzLayer } from "./layer";
import { SzContext2D } from "./SzContext2D";
export class SzDefinition extends BasicSerializableObject {
    static getId() {
        return "sz-definition";
    }
    get isSz() { return true; }
    static createTest() {
        return new SzDefinition({
            layers: [SzLayer.createTest()],
        });
    }
    constructor(data) {
        super();
        if (data?.layers)
            this.layers = data.layers.map((e, i) => new SzLayer(e, i));
        if (!this.layers.every(e => e.isNormalized())) {
            this.layers = SzDefinition.createTest().layers;
        }
        // console.log(this.getHash())
        if (SzDefinition.definitionCache.has(this.getHash())) {
            return SzDefinition.definitionCache.get(this.getHash());
        }
        console.log(this.getHash());
    }
    layers = [];
    cachedHash = '';
    bufferGenerator;
    getClonedLayers() {
        throw new Error("Method not implemented.");
    }
    isEntirelyEmpty() {
        return this.layers.every(e => e.isEmpty());
    }
    getHash() {
        if (this.cachedHash)
            return this.cachedHash;
        return this.cachedHash = 'sz!' + this.layers.map(e => e.getHash()).join(':');
        // return this.cachedHash = 'sz!' + strToH(JSON.stringify(this.layers));
    }
    drawFullSizeOnCanvas(context, size) {
        throw new Error("Method not implemented.");
    }
    generateAsCanvas(size = 120) {
        const [canvas, context] = makeOffscreenBuffer(size, size, {
            smooth: true,
            label: "definition-canvas-cache-" + this.getHash(),
            reusable: false,
        });
        this.internalGenerateShapeBuffer(canvas, context, size, size, 1);
        return canvas;
    }
    cloneFilteredByQuadrants(includeQuadrants) {
        let layers = this.layers.map(e => e.cloneFilteredByQuadrants(includeQuadrants)).filter(e => !e.isEmpty());
        return new SzDefinition({ layers });
    }
    cloneRotateCW() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(6))
        });
    }
    cloneRotate24(n) {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(n))
        });
    }
    cloneRotateCCW() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(24 - 8))
        });
    }
    cloneRotate180() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(12))
        });
    }
    cloneAndStackWith(upper) {
        let bottom = this.clone(e => e.removeCover()).layers;
        let top = upper.clone().layers;
        let dh = 0;
        while (!bottom.every((l, i) => {
            return l.canStackWith(top[i - dh]);
        }))
            dh++;
        let overlap = bottom.length - dh;
        let newLayers = bottom.map((l, i) => {
            return l.stackWith(top[i + dh]);
        }).concat(top.slice(overlap));
        return new SzDefinition({ layers: newLayers.slice(0, 4) });
    }
    cloneAndPaintWith(color) {
        let rawPaints = Array(24).fill(color);
        return this.clone((l, i, a) => {
            let paints = a.slice(i).reduceRight((v, e) => e.filterPaint(v), rawPaints);
            return l.removeCover().paint(paints);
        });
    }
    cloneAndPaintWith4Colors(colors) {
        throw new Error("Method not implemented.");
    }
    cloneAndMakeCover() {
        return new SzDefinition({ layers: this.layers.map(e => e.cloneAsCover()) });
    }
    clone(layerMapper) {
        if (layerMapper) {
            return new SzDefinition({
                layers: this.layers.map(e => e.clone()).flatMap((e, i, a) => {
                    return layerMapper(e, i, a) || [];
                }).filter(e => !e.isEmpty())
            });
        }
        return new SzDefinition(this);
    }
    // serialize(): string | number | object {
    // 	return JSON.stringify(this.layers);
    // 	throw new Error("Method not implemented.");
    // }
    // deserialize(data: any, root?: GameRoot): string | void {
    // 	debugger;
    // 	throw new Error("Method not implemented.");
    // }
    // inherited
    drawCentered(x, y, parameters, diameter) {
        const dpi = smoothenDpi(globalConfig.shapesSharpness * parameters.zoomLevel);
        if (!this.bufferGenerator) {
            this.bufferGenerator = this.internalGenerateShapeBuffer.bind(this);
        }
        const key = diameter + "/" + dpi + "/" + this.cachedHash;
        const canvas = parameters.root.buffers.getForKey({
            key: "shapedef",
            subKey: key,
            w: diameter,
            h: diameter,
            dpi,
            redrawMethod: this.bufferGenerator,
        });
        parameters.context.drawImage(canvas, x - diameter / 2, y - diameter / 2, diameter, diameter);
    }
    internalGenerateShapeBuffer(canvas, ctx, w, h, dpi) {
        // prepare context
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 0.05;
        ctx.translate((w * dpi) / 2, (h * dpi) / 2);
        ctx.scale((dpi * w) / 2.3, (dpi * h) / 2.3);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = THEME.items.outline;
        ctx.lineWidth = THEME.items.outlineWidth / 10;
        ctx.rotate(-Math.PI / 2);
        ctx.fillStyle = THEME.items.circleBackground;
        ctx.beginPath();
        ctx.arc(0, 0, 1.15, 0, 2 * Math.PI);
        ctx.fill();
        let sCtx = new SzContext2D(ctx);
        this.layers.forEach((l, i) => l.drawCenteredLayerScaled(sCtx, i));
    }
    static rawHashMap = new Map();
    static getHashfromRawHash(hash) {
        if (!this.rawHashMap.has(hash)) {
            this.rawHashMap.set(hash, SzDefinition.fromRawShape(hash).getHash());
        }
        return this.rawHashMap.get(hash);
    }
    static fromRawShape(shapeDefinition) {
        if (typeof shapeDefinition != 'string')
            shapeDefinition = shapeDefinition.getHash();
        return new SzDefinition({
            layers: shapeDefinition.split(':').map(e => SzLayer.fromShapezHash(e))
        });
    }
    static definitionCache = new Map();
    static fromShortKey(key) {
        if (!key.startsWith('sz!'))
            throw 0;
        if (!this.definitionCache.has(key)) {
            this.definitionCache.set(key, new SzDefinition({
                layers: key.slice('sz!'.length).split(':').map(e => SzLayer.fromShortKey(e))
            }));
        }
        return this.definitionCache.get(key);
    }
    install(mod) {
        mod.modInterface.extendObject(ShapeDefinition, ({ $old }) => ({
            fromShortKey(key) {
                if (key.startsWith('sz!')) {
                    return SzDefinition.fromShortKey(key);
                }
                return $old.fromShortKey.call(this, key);
            }
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmaW5pdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9fc2hhcGVzdC9kZWZpbml0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFHdEQsT0FBTyxFQUFFLGVBQWUsRUFBYyxNQUFNLDhCQUE4QixDQUFDO0FBQzNFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUUxQyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUV4RSxPQUFPLEVBQWlCLE9BQU8sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNqRCxPQUFPLEVBQXFCLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUcvRCxNQUFNLE9BQU8sWUFBYSxTQUFRLHVCQUF1QjtJQUN4RCxNQUFNLENBQUMsS0FBSztRQUNYLE9BQU8sZUFBZSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxJQUFJLElBQUksS0FBSyxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDM0IsTUFBTSxDQUFDLFVBQVU7UUFDaEIsT0FBTyxJQUFJLFlBQVksQ0FBQztZQUN2QixNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDOUIsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUlELFlBQVksSUFBNEI7UUFDdkMsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLElBQUksRUFBRSxNQUFNO1lBQUUsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFD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QUFDLEtBQUssQ0FBQyxFQUFFO29CQUMxQixPQUFPLFlBQVksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ3RDO2dCQUNELE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQzFDLENBQUM7U0FDRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtYWtlT2Zmc2NyZWVuQnVmZmVyIH0gZnJvbSBcInNoYXBlei9jb3JlL2J1ZmZlcl91dGlsc1wiO1xyXG5pbXBvcnQgeyBnbG9iYWxDb25maWcgfSBmcm9tIFwic2hhcGV6L2NvcmUvY29uZmlnXCI7XHJcbmltcG9ydCB7IHNtb290aGVuRHBpIH0gZnJvbSBcInNoYXBlei9jb3JlL2RwaV9tYW5hZ2VyXCI7XHJcbmltcG9ydCB7IERyYXdQYXJhbWV0ZXJzIH0gZnJvbSBcInNoYXBlei9jb3JlL2RyYXdfcGFyYW1ldGVyc1wiO1xyXG5pbXBvcnQgeyBHYW1lUm9vdCB9IGZyb20gXCJzaGFwZXovZ2FtZS9yb290XCI7XHJcbmltcG9ydCB7IFNoYXBlRGVmaW5pdGlvbiwgU2hhcGVMYXllciB9IGZyb20gXCJzaGFwZXovZ2FtZS9zaGFwZV9kZWZpbml0aW9uXCI7XHJcbmltcG9ydCB7IFRIRU1FIH0gZnJvbSBcInNoYXBlei9nYW1lL3RoZW1lXCI7XHJcbmltcG9ydCB7IE1vZCB9IGZyb20gXCJzaGFwZXovbW9kcy9tb2RcIjtcclxuaW1wb3J0IHsgQmFzaWNTZXJpYWxpemFibGVPYmplY3QgfSBmcm9tIFwic2hhcGV6L3NhdmVnYW1lL3NlcmlhbGl6YXRpb25cIjtcclxuaW1wb3J0IHsgb3ZlcnJpZGUsIHN0clRvSCB9IGZyb20gXCIuLi9jb21tb25cIjtcclxuaW1wb3J0IHsgY29sb3IsIFN6SW5mbywgU3pMYXllciB9IGZyb20gXCIuL2xheWVyXCI7XHJcbmltcG9ydCB7IHJtb2RlLCByb3RhdGlvbjI0LCBTekNvbnRleHQyRCB9IGZyb20gXCIuL1N6Q29udGV4dDJEXCI7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFN6RGVmaW5pdGlvbiBleHRlbmRzIEJhc2ljU2VyaWFsaXphYmxlT2JqZWN0IGltcGxlbWVudHMgU2hhcGVEZWZpbml0aW9uIHtcclxuXHRzdGF0aWMgZ2V0SWQoKSB7XHJcblx0XHRyZXR1cm4gXCJzei1kZWZpbml0aW9uXCI7XHJcblx0fVxyXG5cclxuXHRnZXQgaXNTeigpIHsgcmV0dXJuIHRydWU7IH1cclxuXHRzdGF0aWMgY3JlYXRlVGVzdCgpIHtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0bGF5ZXJzOiBbU3pMYXllci5jcmVhdGVUZXN0KCldLFxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHJcblxyXG5cdGNvbnN0cnVjdG9yKGRhdGE/OiB7IGxheWVyczogU3pMYXllcltdIH0pIHtcclxuXHRcdHN1cGVyKCk7XHJcblx0XHRpZiAoZGF0YT8ubGF5ZXJzKSB0aGlzLmxheWVycyA9IGRhdGEubGF5ZXJzLm1hcCgoZSwgaSkgPT4gbmV3IFN6TGF5ZXIoZSwgaSkpO1xyXG5cdFx0aWYgKCF0aGlzLmxheWVycy5ldmVyeShlID0+IGUuaXNOb3JtYWxpemVkKCkpKSB7XHJcblx0XHRcdHRoaXMubGF5ZXJzID0gU3pEZWZpbml0aW9uLmNyZWF0ZVRlc3QoKS5sYXllcnM7XHJcblx0XHR9XHJcblx0XHQvLyBjb25zb2xlLmxvZyh0aGlzLmdldEhhc2goKSlcclxuXHRcdGlmIChTekRlZmluaXRpb24uZGVmaW5pdGlvbkNhY2hlLmhhcyh0aGlzLmdldEhhc2goKSkpIHtcclxuXHRcdFx0cmV0dXJuIFN6RGVmaW5pdGlvbi5kZWZpbml0aW9uQ2FjaGUuZ2V0KHRoaXMuZ2V0SGFzaCgpKSE7XHJcblx0XHR9XHJcblx0XHRjb25zb2xlLmxvZyh0aGlzLmdldEhhc2goKSk7XHJcblx0fVxyXG5cdGxheWVyczogU3pMYXllcltdID0gW107XHJcblx0Y2FjaGVkSGFzaDogc3RyaW5nID0gJyc7XHJcblx0YnVmZmVyR2VuZXJhdG9yOiBhbnk7XHJcblx0Z2V0Q2xvbmVkTGF5ZXJzKCk6IFNoYXBlTGF5ZXJbXSB7XHJcblx0XHR0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcclxuXHR9XHJcblx0aXNFbnRpcmVseUVtcHR5KCk6IGJvb2xlYW4ge1xyXG5cdFx0cmV0dXJuIHRoaXMubGF5ZXJzLmV2ZXJ5KGUgPT4gZS5pc0VtcHR5KCkpO1xyXG5cdH1cclxuXHRnZXRIYXNoKCk6IHN0cmluZyB7XHJcblx0XHRpZiAodGhpcy5jYWNoZWRIYXNoKSByZXR1cm4gdGhpcy5jYWNoZWRIYXNoO1xyXG5cdFx0cmV0dXJuIHRoaXMuY2FjaGVkSGFzaCA9ICdzeiEnICsgdGhpcy5sYXllcnMubWFwKGUgPT4gZS5nZXRIYXNoKCkpLmpvaW4oJzonKTtcclxuXHRcdC8vIHJldHVybiB0aGlzLmNhY2hlZEhhc2ggPSAnc3ohJyArIHN0clRvSChKU09OLnN0cmluZ2lmeSh0aGlzLmxheWVycykpO1xyXG5cdH1cclxuXHRkcmF3RnVsbFNpemVPbkNhbnZhcyhjb250ZXh0OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsIHNpemU6IG51bWJlcik6IHZvaWQge1xyXG5cdFx0dGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XHJcblx0fVxyXG5cdGdlbmVyYXRlQXNDYW52YXMoc2l6ZSA9IDEyMCkge1xyXG5cdFx0Y29uc3QgW2NhbnZhcywgY29udGV4dF0gPSBtYWtlT2Zmc2NyZWVuQnVmZmVyKHNpemUsIHNpemUsIHtcclxuXHRcdFx0c21vb3RoOiB0cnVlLFxyXG5cdFx0XHRsYWJlbDogXCJkZWZpbml0aW9uLWNhbnZhcy1jYWNoZS1cIiArIHRoaXMuZ2V0SGFzaCgpLFxyXG5cdFx0XHRyZXVzYWJsZTogZmFsc2UsXHJcblx0XHR9KTtcclxuXHJcblx0XHR0aGlzLmludGVybmFsR2VuZXJhdGVTaGFwZUJ1ZmZlcihjYW52YXMsIGNvbnRleHQsIHNpemUsIHNpemUsIDEpO1xyXG5cdFx0cmV0dXJuIGNhbnZhcztcclxuXHR9XHJcblx0Y2xvbmVGaWx0ZXJlZEJ5UXVhZHJhbnRzKGluY2x1ZGVRdWFkcmFudHM6IG51bWJlcltdKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdGxldCBsYXllcnMgPSB0aGlzLmxheWVycy5tYXAoZSA9PiBlLmNsb25lRmlsdGVyZWRCeVF1YWRyYW50cyhpbmNsdWRlUXVhZHJhbnRzKSkuZmlsdGVyKGUgPT4gIWUuaXNFbXB0eSgpKTtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHsgbGF5ZXJzIH0pO1xyXG5cdH1cclxuXHRjbG9uZVJvdGF0ZUNXKCk6IFNoYXBlRGVmaW5pdGlvbiB7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7XHJcblx0XHRcdGxheWVyczogdGhpcy5sYXllcnMubWFwKGwgPT4gbC5jbG9uZSgpLnJvdGF0ZSg2KSlcclxuXHRcdH0pO1xyXG5cdH1cclxuXHRjbG9uZVJvdGF0ZTI0KG46IHJvdGF0aW9uMjQpOiBTekRlZmluaXRpb24ge1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRsYXllcnM6IHRoaXMubGF5ZXJzLm1hcChsID0+IGwuY2xvbmUoKS5yb3RhdGUobikpXHJcblx0XHR9KTtcclxuXHR9XHJcblx0Y2xvbmVSb3RhdGVDQ1coKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0bGF5ZXJzOiB0aGlzLmxheWVycy5tYXAobCA9PiBsLmNsb25lKCkucm90YXRlKDI0IC0gOCkpXHJcblx0XHR9KTtcclxuXHR9XHJcblx0Y2xvbmVSb3RhdGUxODAoKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0bGF5ZXJzOiB0aGlzLmxheWVycy5tYXAobCA9PiBsLmNsb25lKCkucm90YXRlKDEyKSlcclxuXHRcdH0pO1xyXG5cdH1cclxuXHRjbG9uZUFuZFN0YWNrV2l0aCh1cHBlcjogU3pEZWZpbml0aW9uKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdGxldCBib3R0b20gPSB0aGlzLmNsb25lKGUgPT4gZS5yZW1vdmVDb3ZlcigpKS5sYXllcnM7XHJcblx0XHRsZXQgdG9wID0gdXBwZXIuY2xvbmUoKS5sYXllcnM7XHJcblx0XHRsZXQgZGggPSAwO1xyXG5cdFx0d2hpbGUgKCFib3R0b20uZXZlcnkoKGwsIGkpID0+IHtcclxuXHRcdFx0cmV0dXJuIGwuY2FuU3RhY2tXaXRoKHRvcFtpIC0gZGhdKTtcclxuXHRcdH0pKSBkaCsrO1xyXG5cdFx0bGV0IG92ZXJsYXAgPSBib3R0b20ubGVuZ3RoIC0gZGg7XHJcblx0XHRsZXQgbmV3TGF5ZXJzID0gYm90dG9tLm1hcCgobCwgaSkgPT4ge1xyXG5cdFx0XHRyZXR1cm4gbC5zdGFja1dpdGgodG9wW2kgKyBkaF0pO1xyXG5cdFx0fSkuY29uY2F0KHRvcC5zbGljZShcclxuXHRcdFx0b3ZlcmxhcFxyXG5cdFx0KSk7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7IGxheWVyczogbmV3TGF5ZXJzLnNsaWNlKDAsIDQpIH0pO1xyXG5cdH1cclxuXHJcblx0Y2xvbmVBbmRQYWludFdpdGgoY29sb3I6IGNvbG9yKTogU3pEZWZpbml0aW9uIHtcclxuXHRcdGxldCByYXdQYWludHMgPSBBcnJheTxjb2xvciB8IG51bGw+KDI0KS5maWxsKGNvbG9yKTtcclxuXHRcdHJldHVybiB0aGlzLmNsb25lKChsLCBpLCBhKSA9PiB7XHJcblx0XHRcdGxldCBwYWludHMgPSBhLnNsaWNlKGkpLnJlZHVjZVJpZ2h0KCh2LCBlKSA9PiBlLmZpbHRlclBhaW50KHYpLCByYXdQYWludHMpO1xyXG5cdFx0XHRyZXR1cm4gbC5yZW1vdmVDb3ZlcigpLnBhaW50KHBhaW50cyk7XHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdGNsb25lQW5kUGFpbnRXaXRoNENvbG9ycyhjb2xvcnM6IFtzdHJpbmcsIHN0cmluZywgc3RyaW5nLCBzdHJpbmddKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xyXG5cdH1cclxuXHJcblx0Y2xvbmVBbmRNYWtlQ292ZXIoKSB7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7IGxheWVyczogdGhpcy5sYXllcnMubWFwKGUgPT4gZS5jbG9uZUFzQ292ZXIoKSkgfSlcclxuXHR9XHJcblxyXG5cclxuXHRjbG9uZShsYXllck1hcHBlcj86IChsYXllcjogU3pMYXllciwgaTogbnVtYmVyLCBhOiBTekxheWVyW10pID0+IFN6TGF5ZXIgfCBTekxheWVyW10gfCBudWxsKSB7XHJcblx0XHRpZiAobGF5ZXJNYXBwZXIpIHtcclxuXHRcdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRcdGxheWVyczogdGhpcy5sYXllcnMubWFwKGUgPT4gZS5jbG9uZSgpKS5mbGF0TWFwKChlLCBpLCBhKSA9PiB7XHJcblx0XHRcdFx0XHRyZXR1cm4gbGF5ZXJNYXBwZXIoZSwgaSwgYSkgfHwgW107XHJcblx0XHRcdFx0fSkuZmlsdGVyKGUgPT4gIWUuaXNFbXB0eSgpKVxyXG5cdFx0XHR9KTtcclxuXHRcdH1cclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHRoaXMpO1xyXG5cdH1cclxuXHQvLyBzZXJpYWxpemUoKTogc3RyaW5nIHwgbnVtYmVyIHwgb2JqZWN0IHtcclxuXHQvLyBcdHJldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLmxheWVycyk7XHJcblx0Ly8gXHR0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcclxuXHQvLyB9XHJcblx0Ly8gZGVzZXJpYWxpemUoZGF0YTogYW55LCByb290PzogR2FtZVJvb3QpOiBzdHJpbmcgfCB2b2lkIHtcclxuXHQvLyBcdGRlYnVnZ2VyO1xyXG5cdC8vIFx0dGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XHJcblx0Ly8gfVxyXG5cclxuXHJcblxyXG5cclxuXHQvLyBpbmhlcml0ZWRcclxuXHRkcmF3Q2VudGVyZWQoeDogbnVtYmVyLCB5OiBudW1iZXIsIHBhcmFtZXRlcnM6IERyYXdQYXJhbWV0ZXJzLCBkaWFtZXRlcjogbnVtYmVyKTogdm9pZCB7XHJcblx0XHRjb25zdCBkcGkgPSBzbW9vdGhlbkRwaShnbG9iYWxDb25maWcuc2hhcGVzU2hhcnBuZXNzICogcGFyYW1ldGVycy56b29tTGV2ZWwpO1xyXG5cdFx0aWYgKCF0aGlzLmJ1ZmZlckdlbmVyYXRvcikge1xyXG5cdFx0XHR0aGlzLmJ1ZmZlckdlbmVyYXRvciA9IHRoaXMuaW50ZXJuYWxHZW5lcmF0ZVNoYXBlQnVmZmVyLmJpbmQodGhpcyk7XHJcblx0XHR9XHJcblx0XHRjb25zdCBrZXkgPSBkaWFtZXRlciArIFwiL1wiICsgZHBpICsgXCIvXCIgKyB0aGlzLmNhY2hlZEhhc2g7XHJcblx0XHRjb25zdCBjYW52YXMgPSBwYXJhbWV0ZXJzLnJvb3QuYnVmZmVycy5nZXRGb3JLZXkoe1xyXG5cdFx0XHRrZXk6IFwic2hhcGVkZWZcIixcclxuXHRcdFx0c3ViS2V5OiBrZXksXHJcblx0XHRcdHc6IGRpYW1ldGVyLFxyXG5cdFx0XHRoOiBkaWFtZXRlcixcclxuXHRcdFx0ZHBpLFxyXG5cdFx0XHRyZWRyYXdNZXRob2Q6IHRoaXMuYnVmZmVyR2VuZXJhdG9yLFxyXG5cdFx0fSk7XHJcblx0XHRwYXJhbWV0ZXJzLmNvbnRleHQuZHJhd0ltYWdlKGNhbnZhcywgeCAtIGRpYW1ldGVyIC8gMiwgeSAtIGRpYW1ldGVyIC8gMiwgZGlhbWV0ZXIsIGRpYW1ldGVyKTtcclxuXHR9XHJcblxyXG5cclxuXHRpbnRlcm5hbEdlbmVyYXRlU2hhcGVCdWZmZXIoY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCwgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsIHc6IG51bWJlciwgaDogbnVtYmVyLCBkcGk6IG51bWJlcik6IHZvaWQge1xyXG5cdFx0Ly8gcHJlcGFyZSBjb250ZXh0XHJcblx0XHRjdHgubGluZUNhcCA9ICdyb3VuZCc7XHJcblx0XHRjdHgubGluZUpvaW4gPSAncm91bmQnO1xyXG5cdFx0Y3R4LmxpbmVXaWR0aCA9IDAuMDU7XHJcblxyXG5cdFx0Y3R4LnRyYW5zbGF0ZSgodyAqIGRwaSkgLyAyLCAoaCAqIGRwaSkgLyAyKTtcclxuXHRcdGN0eC5zY2FsZSgoZHBpICogdykgLyAyLjMsIChkcGkgKiBoKSAvIDIuMyk7XHJcblx0XHRjdHgubGluZUNhcCA9ICdyb3VuZCc7XHJcblx0XHRjdHgubGluZUpvaW4gPSAncm91bmQnO1xyXG5cdFx0Y3R4LnN0cm9rZVN0eWxlID0gVEhFTUUuaXRlbXMub3V0bGluZTtcclxuXHRcdGN0eC5saW5lV2lkdGggPSBUSEVNRS5pdGVtcy5vdXRsaW5lV2lkdGggLyAxMDtcclxuXHJcblx0XHRjdHgucm90YXRlKC1NYXRoLlBJIC8gMik7XHJcblxyXG5cdFx0Y3R4LmZpbGxTdHlsZSA9IFRIRU1FLml0ZW1zLmNpcmNsZUJhY2tncm91bmQ7XHJcblx0XHRjdHguYmVnaW5QYXRoKCk7XHJcblx0XHRjdHguYXJjKDAsIDAsIDEuMTUsIDAsIDIgKiBNYXRoLlBJKTtcclxuXHRcdGN0eC5maWxsKCk7XHJcblxyXG5cdFx0bGV0IHNDdHggPSBuZXcgU3pDb250ZXh0MkQoY3R4KTtcclxuXHRcdHRoaXMubGF5ZXJzLmZvckVhY2goKGwsIGkpID0+IGwuZHJhd0NlbnRlcmVkTGF5ZXJTY2FsZWQoc0N0eCwgaSkpO1xyXG5cclxuXHR9XHJcblxyXG5cdHN0YXRpYyByYXdIYXNoTWFwOiBNYXA8c3RyaW5nLCBzdHJpbmc+ID0gbmV3IE1hcCgpO1xyXG5cdHN0YXRpYyBnZXRIYXNoZnJvbVJhd0hhc2goaGFzaDogc3RyaW5nKSB7XHJcblx0XHRpZiAoIXRoaXMucmF3SGFzaE1hcC5oYXMoaGFzaCkpIHtcclxuXHRcdFx0dGhpcy5yYXdIYXNoTWFwLnNldChoYXNoLFxyXG5cdFx0XHRcdFN6RGVmaW5pdGlvbi5mcm9tUmF3U2hhcGUoaGFzaCkuZ2V0SGFzaCgpXHJcblx0XHRcdClcclxuXHRcdH1cclxuXHRcdHJldHVybiB0aGlzLnJhd0hhc2hNYXAuZ2V0KGhhc2gpITtcclxuXHR9XHJcblxyXG5cdHN0YXRpYyBmcm9tUmF3U2hhcGUoc2hhcGVEZWZpbml0aW9uOiBTaGFwZURlZmluaXRpb24gfCBzdHJpbmcpIHtcclxuXHRcdGlmICh0eXBlb2Ygc2hhcGVEZWZpbml0aW9uICE9ICdzdHJpbmcnKVxyXG5cdFx0XHRzaGFwZURlZmluaXRpb24gPSBzaGFwZURlZmluaXRpb24uZ2V0SGFzaCgpO1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRsYXllcnM6IHNoYXBlRGVmaW5pdGlvbi5zcGxpdCgnOicpLm1hcChlID0+IFN6TGF5ZXIuZnJvbVNoYXBlekhhc2goZSkpXHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdHN0YXRpYyBkZWZpbml0aW9uQ2FjaGU6IE1hcDxzdHJpbmcsIFN6RGVmaW5pdGlvbj4gPSBuZXcgTWFwKCk7XHJcblx0c3RhdGljIGZyb21TaG9ydEtleShrZXk6IHN0cmluZyk6IFNoYXBlRGVmaW5pdGlvbiB7XHJcblx0XHRpZiAoIWtleS5zdGFydHNXaXRoKCdzeiEnKSkgdGhyb3cgMDtcclxuXHRcdGlmICghdGhpcy5kZWZpbml0aW9uQ2FjaGUuaGFzKGtleSkpIHtcclxuXHRcdFx0dGhpcy5kZWZpbml0aW9uQ2FjaGUuc2V0KGtleSwgbmV3IFN6RGVmaW5pdGlvbih7XHJcblx0XHRcdFx0bGF5ZXJzOiBrZXkuc2xpY2UoJ3N6IScubGVuZ3RoKS5zcGxpdCgnOicpLm1hcChlID0+IFN6TGF5ZXIuZnJvbVNob3J0S2V5KGUpKVxyXG5cdFx0XHR9KSk7XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gdGhpcy5kZWZpbml0aW9uQ2FjaGUuZ2V0KGtleSkhO1xyXG5cdH1cclxuXHJcblx0aW5zdGFsbChtb2Q6IE1vZCkge1xyXG5cdFx0bW9kLm1vZEludGVyZmFjZS5leHRlbmRPYmplY3QoU2hhcGVEZWZpbml0aW9uLCAoeyAkb2xkIH0pID0+ICh7XHJcblx0XHRcdGZyb21TaG9ydEtleShrZXk6IHN0cmluZykge1xyXG5cdFx0XHRcdGlmIChrZXkuc3RhcnRzV2l0aCgnc3ohJykpIHtcclxuXHRcdFx0XHRcdHJldHVybiBTekRlZmluaXRpb24uZnJvbVNob3J0S2V5KGtleSk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdHJldHVybiAkb2xkLmZyb21TaG9ydEtleS5jYWxsKHRoaXMsIGtleSk7XHJcblx0XHRcdH1cclxuXHRcdH0pKTtcclxuXHR9XHJcbn1cclxuXHJcbiJdfQ==