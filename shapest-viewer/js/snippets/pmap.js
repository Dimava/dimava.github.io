"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PMap = void 0;
function empty() {
    let resolve;
    let reject;
    let p = new Promise((r, j) => {
        resolve = r;
        reject = j;
    });
    return Object.assign(p, { resolve, reject, r: resolve, j: reject });
}
class PMap {
    /** Original array */
    source = [];
    /** Async element converter function */
    mapper = (e) => e;
    /** Max number of requests at once.
     *  *May* be changed in runtime */
    threads = 5;
    /** Max distance between the olders incomplete and newest active elements.
     *  *May* be changed in runtime */
    window = Infinity;
    /** Unfinished result array */
    results = [];
    /** Promises for every element */
    requests = [];
    beforeStart = () => { };
    afterComplete = () => { };
    /** Length of the array */
    length = -1;
    /** The number of elements finished converting */
    completed = -1;
    /** Threads currently working
     *  in the mapper function: including the current one */
    activeThreads = -1;
    lastStarted = -1;
    allTasksDone;
    anyTaskResolved;
    constructor(source) {
        this.allTasksDone = Object.assign(this.emptyResult(), { pmap: this });
        this.anyTaskResolved = this.emptyResult();
        for (let k of Object.keys(this)) {
            if (typeof source[k] == typeof this[k]) {
                this[k] = source[k];
            }
            else if (source[k]) {
                throw new Error(`PMap: invalid constructor parameter: property ${k}: expected ${typeof this[k]}, but got ${typeof source[k]}`);
            }
        }
    }
    async startTask(arrayIndex) {
        this.activeThreads++;
        this.beforeStart(this.source[arrayIndex], arrayIndex, this.source, this);
        this.lastStarted = arrayIndex;
        let v = await this.mapper(this.source[arrayIndex], arrayIndex, this.source, this).catch(e => e);
        this.results[arrayIndex] = v;
        this.requests[arrayIndex].resolve(v);
        this.completed++;
        this.afterComplete(this.source[arrayIndex], arrayIndex, this.source, this);
        this.activeThreads--;
        this.anyTaskResolved.resolve();
    }
    async run_internal() {
        for (let arrayIndex = 0; arrayIndex < this.length; arrayIndex++) {
            while (this.activeThreads >= this.threads)
                await this.anyTaskResolved;
            this.anyTaskResolved = this.emptyResult();
            await this.requests[arrayIndex - this.window];
            this.startTask(arrayIndex);
        }
        this.allTasksDone.resolve(this.results);
        return this.allTasksDone;
    }
    run() {
        this.prepare();
        this.run_internal();
        return this.allTasksDone;
    }
    prepare() {
        if (this.length == -1)
            this.length = this.source.length;
        if (this.results.length == 0) {
            this.results = Array(this.length);
        }
        if (this.requests.length == 0) {
            this.requests = this.source.map(e => this.emptyResult());
        }
        if (this.completed < 0)
            this.completed = 0;
        if (this.activeThreads < 0)
            this.activeThreads = 0;
        if (this.lastStarted < -1)
            this.lastStarted = -1;
        this.anyTaskResolved = this.emptyResult();
        Object.assign(this.allTasksDone, { pmap: this });
        return this;
    }
    emptyResult() {
        let resolve;
        let reject;
        let p = new Promise((r, j) => {
            resolve = r;
            reject = j;
        });
        return Object.assign(p, { resolve, reject, r: resolve, j: reject });
    }
    static this_pmap(array, mapper, options = {}) {
        let pmap = new PMap({ source: array, mapper, ...options });
        return pmap.run();
    }
    static pmap(array, mapper, options = {}) {
        let pmap = new PMap({ source: array, mapper, ...options });
        return pmap.run();
    }
}
exports.PMap = PMap;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG1hcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NuaXBwZXRzL3BtYXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBY0EsU0FBUyxLQUFLO0lBQ2IsSUFBSSxPQUE0QixDQUFDO0lBQ2pDLElBQUksTUFBK0IsQ0FBQztJQUNwQyxJQUFJLENBQUMsR0FBRyxJQUFJLE9BQU8sQ0FBSSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMvQixPQUFPLEdBQUcsQ0FBQyxDQUFDO1FBQ1osTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNaLENBQUMsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUNyRSxDQUFDO0FBU0QsTUFBYSxJQUFJO0lBQ2hCLHFCQUFxQjtJQUNyQixNQUFNLEdBQVEsRUFBRSxDQUFDO0lBQ2pCLHVDQUF1QztJQUN2QyxNQUFNLEdBQXFFLENBQUMsQ0FBSSxFQUFFLEVBQUUsQ0FBQyxDQUFzQixDQUFDO0lBQzVHO3NDQUNrQztJQUNsQyxPQUFPLEdBQVcsQ0FBQyxDQUFDO0lBQ3BCO3NDQUNrQztJQUNsQyxNQUFNLEdBQVcsUUFBUSxDQUFDO0lBRTFCLDhCQUE4QjtJQUM5QixPQUFPLEdBQTBCLEVBQUUsQ0FBQztJQUNwQyxpQ0FBaUM7SUFDakMsUUFBUSxHQUE4QixFQUFFLENBQUM7SUFFekMsV0FBVyxHQUEyRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDaEcsYUFBYSxHQUEyRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFFbEcsMEJBQTBCO0lBQzFCLE1BQU0sR0FBVyxDQUFDLENBQUMsQ0FBQztJQUNwQixpREFBaUQ7SUFDakQsU0FBUyxHQUFXLENBQUMsQ0FBQyxDQUFDO0lBQ3ZCOzREQUN3RDtJQUN4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QUM7UUFDakMsSUFBSSxNQUErQixDQUFDO1FBQ3BDLElBQUksQ0FBQyxHQUFHLElBQUksT0FBTyxDQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQy9CLE9BQU8sR0FBRyxDQUFDLENBQUM7WUFDWixNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQ1osQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFFRCxNQUFNLENBQUMsU0FBUyxDQUFrQixLQUFVLEVBQUUsTUFBK0IsRUFBRSxVQUFrQyxFQUFFO1FBQ2xILElBQUksSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsR0FBRyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzNELE9BQU8sSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFDRCxNQUFNLENBQUMsSUFBSSxDQUFrQixLQUFVLEVBQUUsTUFBK0IsRUFBRSxVQUFrQyxFQUFFO1FBQzdHLElBQUksSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsR0FBRyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzNELE9BQU8sSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ25CLENBQUM7Q0FDRDtBQTVHRCxvQkE0R0MiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcbnR5cGUgUmVzb2x2ZWFibGVQcm9taXNlPFQ+ID0gUHJvbWlzZUxpa2U8VD4gJiB7XHJcblx0cmVzb2x2ZSh2YWx1ZTogVCk6IHZvaWQ7XHJcbn1cclxuZnVuY3Rpb24gZW1wdHk8VD4oKTogVW53cmFwcGVkUHJvbWlzZTxUPiB7XHJcblx0bGV0IHJlc29sdmUhOiAodmFsdWU6IFQpID0+IHZvaWQ7XHJcblx0bGV0IHJlamVjdCE6IChyZWFzb24/OiBhbnkpID0+IHZvaWQ7XHJcblx0bGV0IHAgPSBuZXcgUHJvbWlzZTxUPigociwgaikgPT4ge1xyXG5cdFx0cmVzb2x2ZSA9IHI7XHJcblx0XHRyZWplY3QgPSBqO1xyXG5cdH0pO1xyXG5cdHJldHVybiBPYmplY3QuYXNzaWduKHAsIHsgcmVzb2x2ZSwgcmVqZWN0LCByOiByZXNvbHZlLCBqOiByZWplY3QgfSk7XHJcbn1cclxudHlwZSBVbndyYXBwZWRQcm9taXNlPFQ+ID0gUHJvbWlzZTxUPiAmIHtcclxuXHRyZXNvbHZlOiAodmFsdWU6IFQpID0+IHZvaWQ7XHJcblx0cmVqZWN0OiAocmVhc29uPzogYW55KSA9PiB2b2lkO1xyXG5cdHI6ICh2YWx1ZTogVCkgPT4gdm9pZDtcclxuXHRqOiAocmVhc29uPzogYW55KSA9PiB2b2lkO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFBNYXA8VCwgViwgRSA9IG5ldmVyPiB7XHJcblx0LyoqIE9yaWdpbmFsIGFycmF5ICovXHJcblx0c291cmNlOiBUW10gPSBbXTtcclxuXHQvKiogQXN5bmMgZWxlbWVudCBjb252ZXJ0ZXIgZnVuY3Rpb24gKi9cclxuXHRtYXBwZXI6IChlOiBULCBpOiBudW1iZXIsIGE6IFRbXSwgcG1hcDogUE1hcDxULCBWLCBFPikgPT4gUHJvbWlzZTxWIHwgRT4gPSAoZTogVCkgPT4gZSBhcyBhbnkgYXMgUHJvbWlzZTxWPjtcclxuXHQvKiogTWF4IG51bWJlciBvZiByZXF1ZXN0cyBhdCBvbmNlLiAgIFxyXG5cdCAqICAqTWF5KiBiZSBjaGFuZ2VkIGluIHJ1bnRpbWUgKi9cclxuXHR0aHJlYWRzOiBudW1iZXIgPSA1O1xyXG5cdC8qKiBNYXggZGlzdGFuY2UgYmV0d2VlbiB0aGUgb2xkZXJzIGluY29tcGxldGUgYW5kIG5ld2VzdCBhY3RpdmUgZWxlbWVudHMuICAgXHJcblx0ICogICpNYXkqIGJlIGNoYW5nZWQgaW4gcnVudGltZSAqL1xyXG5cdHdpbmRvdzogbnVtYmVyID0gSW5maW5pdHk7XHJcblxyXG5cdC8qKiBVbmZpbmlzaGVkIHJlc3VsdCBhcnJheSAqL1xyXG5cdHJlc3VsdHM6IChWIHwgRSB8IHVuZGVmaW5lZClbXSA9IFtdO1xyXG5cdC8qKiBQcm9taXNlcyBmb3IgZXZlcnkgZWxlbWVudCAqL1xyXG5cdHJlcXVlc3RzOiBVbndyYXBwZWRQcm9taXNlPFYgfCBFPltdID0gW107XHJcblxyXG5cdGJlZm9yZVN0YXJ0OiAoZTogVCwgaTogbnVtYmVyLCBhOiBUW10sIHBtYXA6IFBNYXA8VCwgViwgRT4pID0+IFByb21pc2U8dm9pZD4gfCB2b2lkID0gKCkgPT4geyB9O1xyXG5cdGFmdGVyQ29tcGxldGU6IChlOiBULCBpOiBudW1iZXIsIGE6IFRbXSwgcG1hcDogUE1hcDxULCBWLCBFPikgPT4gUHJvbWlzZTx2b2lkPiB8IHZvaWQgPSAoKSA9PiB7IH07XHJcblxyXG5cdC8qKiBMZW5ndGggb2YgdGhlIGFycmF5ICovXHJcblx0bGVuZ3RoOiBudW1iZXIgPSAtMTtcclxuXHQvKiogVGhlIG51bWJlciBvZiBlbGVtZW50cyBmaW5pc2hlZCBjb252ZXJ0aW5nICovXHJcblx0Y29tcGxldGVkOiBudW1iZXIgPSAtMTtcclxuXHQvKiogVGhyZWFkcyBjdXJyZW50bHkgd29ya2luZyAgIFxyXG5cdCAqICBpbiB0aGUgbWFwcGVyIGZ1bmN0aW9uOiBpbmNsdWRpbmcgdGhlIGN1cnJlbnQgb25lICovXHJcblx0YWN0aXZlVGhyZWFkczogbnVtYmVyID0gLTE7XHJcblx0bGFzdFN0YXJ0ZWQ6IG51bWJlciA9IC0xO1xyXG5cclxuXHRhbGxUYXNrc0RvbmU6IFVud3JhcHBlZFByb21pc2U8KFYgfCBFKVtdPiAmIHsgcG1hcDogUE1hcDxULCBWLCBFPiB9O1xyXG5cdGFueVRhc2tSZXNvbHZlZDogVW53cmFwcGVkUHJvbWlzZTx2b2lkPjtcclxuXHJcblx0Y29uc3RydWN0b3Ioc291cmNlOiBQYXJ0aWFsPFBNYXA8VCwgViwgRT4+KSB7XHJcblx0XHR0aGlzLmFsbFRhc2tzRG9uZSA9IE9iamVjdC5hc3NpZ24odGhpcy5lbXB0eVJlc3VsdDwoViB8IEUpW10+KCksIHsgcG1hcDogdGhpcyB9KTtcclxuXHRcdHRoaXMuYW55VGFza1Jlc29sdmVkID0gdGhpcy5lbXB0eVJlc3VsdCgpO1xyXG5cdFx0Zm9yIChsZXQgayBvZiBPYmplY3Qua2V5cyh0aGlzKSBhcyAoa2V5b2YgUE1hcDxULCBWLCBFPilbXSkge1xyXG5cdFx0XHRpZiAodHlwZW9mIHNvdXJjZVtrXSA9PSB0eXBlb2YgdGhpc1trXSkge1xyXG5cdFx0XHRcdHRoaXNba10gPSBzb3VyY2Vba10gYXMgYW55O1xyXG5cdFx0XHR9IGVsc2UgaWYgKHNvdXJjZVtrXSkge1xyXG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihgUE1hcDogaW52YWxpZCBjb25zdHJ1Y3RvciBwYXJhbWV0ZXI6IHByb3BlcnR5ICR7a306IGV4cGVjdGVkICR7dHlwZW9mIHRoaXNba119LCBidXQgZ290ICR7dHlwZW9mIHNvdXJjZVtrXX1gKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdH1cclxuXHJcblxyXG5cdGFzeW5jIHN0YXJ0VGFzayhhcnJheUluZGV4OiBudW1iZXIpIHtcclxuXHRcdHRoaXMuYWN0aXZlVGhyZWFkcysrO1xyXG5cdFx0dGhpcy5iZWZvcmVTdGFydCh0aGlzLnNvdXJjZVthcnJheUluZGV4XSwgYXJyYXlJbmRleCwgdGhpcy5zb3VyY2UsIHRoaXMpO1xyXG5cdFx0dGhpcy5sYXN0U3RhcnRlZCA9IGFycmF5SW5kZXg7XHJcblx0XHRsZXQgdiA9IGF3YWl0IHRoaXMubWFwcGVyKHRoaXMuc291cmNlW2FycmF5SW5kZXhdLCBhcnJheUluZGV4LCB0aGlzLnNvdXJjZSwgdGhpcykuY2F0Y2g8RT4oZSA9PiBlKTtcclxuXHRcdHRoaXMucmVzdWx0c1thcnJheUluZGV4XSA9IHY7XHJcblx0XHR0aGlzLnJlcXVlc3RzW2FycmF5SW5kZXhdLnJlc29sdmUodik7XHJcblx0XHR0aGlzLmNvbXBsZXRlZCsrO1xyXG5cdFx0dGhpcy5hZnRlckNvbXBsZXRlKHRoaXMuc291cmNlW2FycmF5SW5kZXhdLCBhcnJheUluZGV4LCB0aGlzLnNvdXJjZSwgdGhpcyk7XHJcblx0XHR0aGlzLmFjdGl2ZVRocmVhZHMtLTtcclxuXHRcdHRoaXMuYW55VGFza1Jlc29sdmVkLnJlc29sdmUoKTtcclxuXHR9XHJcblx0YXN5bmMgcnVuX2ludGVybmFsKCkge1xyXG5cdFx0Zm9yIChsZXQgYXJyYXlJbmRleCA9IDA7IGFycmF5SW5kZXggPCB0aGlzLmxlbmd0aDsgYXJyYXlJbmRleCsrKSB7XHJcblx0XHRcdHdoaWxlICh0aGlzLmFjdGl2ZVRocmVhZHMgPj0gdGhpcy50aHJlYWRzKSBhd2FpdCB0aGlzLmFueVRhc2tSZXNvbHZlZDtcclxuXHRcdFx0dGhpcy5hbnlUYXNrUmVzb2x2ZWQgPSB0aGlzLmVtcHR5UmVzdWx0KCk7XHJcblx0XHRcdFxyXG5cdFx0XHRhd2FpdCB0aGlzLnJlcXVlc3RzW2FycmF5SW5kZXggLSB0aGlzLndpbmRvd107XHJcblx0XHRcdHRoaXMuc3RhcnRUYXNrKGFycmF5SW5kZXgpO1xyXG5cdFx0fVxyXG5cdFx0dGhpcy5hbGxUYXNrc0RvbmUucmVzb2x2ZSh0aGlzLnJlc3VsdHMgYXMgKFYgfCBFKVtdKTtcclxuXHRcdHJldHVybiB0aGlzLmFsbFRhc2tzRG9uZTtcclxuXHR9XHJcblx0cnVuKCkge1xyXG5cdFx0dGhpcy5wcmVwYXJlKCk7XHJcblx0XHR0aGlzLnJ1bl9pbnRlcm5hbCgpO1xyXG5cdFx0cmV0dXJuIHRoaXMuYWxsVGFza3NEb25lO1xyXG5cdH1cclxuXHJcblx0cHJlcGFyZSgpIHtcclxuXHRcdGlmICh0aGlzLmxlbmd0aCA9PSAtMSkgdGhpcy5sZW5ndGggPSB0aGlzLnNvdXJjZS5sZW5ndGg7XHJcblx0XHRpZiAodGhpcy5yZXN1bHRzLmxlbmd0aCA9PSAwKSB7XHJcblx0XHRcdHRoaXMucmVzdWx0cyA9IEFycmF5KHRoaXMubGVuZ3RoKTtcclxuXHRcdH1cclxuXHRcdGlmICh0aGlzLnJlcXVlc3RzLmxlbmd0aCA9PSAwKSB7XHJcblx0XHRcdHRoaXMucmVxdWVzdHMgPSB0aGlzLnNvdXJjZS5tYXAoZSA9PiB0aGlzLmVtcHR5UmVzdWx0KCkpO1xyXG5cdFx0fVxyXG5cdFx0aWYgKHRoaXMuY29tcGxldGVkIDwgMCkgdGhpcy5jb21wbGV0ZWQgPSAwO1xyXG5cdFx0aWYgKHRoaXMuYWN0aXZlVGhyZWFkcyA8IDApIHRoaXMuYWN0aXZlVGhyZWFkcyA9IDA7XHJcblx0XHRpZiAodGhpcy5sYXN0U3RhcnRlZCA8IC0xKSB0aGlzLmxhc3RTdGFydGVkID0gLTE7XHJcblx0XHR0aGlzLmFueVRhc2tSZXNvbHZlZCA9IHRoaXMuZW1wdHlSZXN1bHQoKTtcclxuXHRcdE9iamVjdC5hc3NpZ24odGhpcy5hbGxUYXNrc0RvbmUsIHsgcG1hcDogdGhpcyB9KTtcclxuXHRcdHJldHVybiB0aGlzO1xyXG5cdH1cclxuXHJcblx0ZW1wdHlSZXN1bHQ8VCA9IFYgfCBFPigpOiBVbndyYXBwZWRQcm9taXNlPFQ+IHtcclxuXHRcdGxldCByZXNvbHZlITogKHZhbHVlOiBUKSA9PiB2b2lkO1xyXG5cdFx0bGV0IHJlamVjdCE6IChyZWFzb24/OiBhbnkpID0+IHZvaWQ7XHJcblx0XHRsZXQgcCA9IG5ldyBQcm9taXNlPFQ+KChyLCBqKSA9PiB7XHJcblx0XHRcdHJlc29sdmUgPSByO1xyXG5cdFx0XHRyZWplY3QgPSBqO1xyXG5cdFx0fSk7XHJcblx0XHRyZXR1cm4gT2JqZWN0LmFzc2lnbihwLCB7IHJlc29sdmUsIHJlamVjdCwgcjogcmVzb2x2ZSwgajogcmVqZWN0IH0pO1xyXG5cdH1cclxuXHJcblx0c3RhdGljIHRoaXNfcG1hcDxULCBWLCBFID0gbmV2ZXI+KGFycmF5OiBUW10sIG1hcHBlcjogUE1hcDxULCBWLCBFPlsnbWFwcGVyJ10sIG9wdGlvbnM6IFBhcnRpYWw8UE1hcDxULCBWLCBFPj4gPSB7fSkge1xyXG5cdFx0bGV0IHBtYXAgPSBuZXcgUE1hcCh7IHNvdXJjZTogYXJyYXksIG1hcHBlciwgLi4ub3B0aW9ucyB9KTtcclxuXHRcdHJldHVybiBwbWFwLnJ1bigpO1xyXG5cdH1cclxuXHRzdGF0aWMgcG1hcDxULCBWLCBFID0gbmV2ZXI+KGFycmF5OiBUW10sIG1hcHBlcjogUE1hcDxULCBWLCBFPlsnbWFwcGVyJ10sIG9wdGlvbnM6IFBhcnRpYWw8UE1hcDxULCBWLCBFPj4gPSB7fSkge1xyXG5cdFx0bGV0IHBtYXAgPSBuZXcgUE1hcCh7IHNvdXJjZTogYXJyYXksIG1hcHBlciwgLi4ub3B0aW9ucyB9KTtcclxuXHRcdHJldHVybiBwbWFwLnJ1bigpO1xyXG5cdH1cclxufVxyXG5cclxuIl19