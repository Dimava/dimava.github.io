"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_jetpack_1 = __importDefault(require("fs-jetpack"));
const pmap_1 = require("./pmap");
const DoubleTreeNode_1 = require("./DoubleTreeNode");
// let path = "C:/Users/Dimava/Desktop/projects/@seamless/dist/img-src/dl/1644414666192289895.png";
// let dir = 'C:/Users/Dimava/Desktop/projects/@seamless/dist/img-src/dl';
// let jp = jetpack.cwd(dir);
function deepToList(node, getChildren, list = []) {
    list.push(node);
    for (let c of getChildren(node))
        deepToList(c, getChildren, list);
    return list;
}
async function convertFolder(dir) {
    console.log(`building tree: ${dir}`);
    console.time(`building tree: ${dir}`);
    if (DoubleTreeNode_1.rootSrc.exists(dir) != 'dir') {
        console.log(`does not exist: ${dir}`);
        return;
    }
    let tree = await new DoubleTreeNode_1.DoubleTreeNode(dir);
    let leftTree = fs_jetpack_1.default.inspectTree(tree.leftPath, { symlinks: 'follow' });
    let rightTree = fs_jetpack_1.default.inspectTree(tree.rightPath, { symlinks: 'follow' });
    if (Math.abs(leftTree.size - rightTree.size) < 1e6) {
        console.log(`same size: ${dir}  (${leftTree.size - rightTree.size})`);
        return;
    }
    console.timeEnd(`building tree: ${dir}`);
    let doubleFilesAll = deepToList(tree, e => e.children ?? []).filter(e => e.type == 'file');
    let validFiles = doubleFilesAll.filter(pair => {
        if (!pair.left)
            return false;
        if (pair.extType == 'ignored')
            return false;
        return true;
    });
    // console.log(doubleFiles);
    // console.log(doubleFiles.filter(e => e.left && !e.right))
    // console.log(doubleFiles.filter(e => !e.left && e.right))
    // console.log(doubleFiles.filter(e => !e.left?.width && !videoTypes.includes(e.ext)))
    function isDone(pair) {
        if (pair.isHardLink)
            return true;
        if (!pair.left)
            return true;
        if (pair.right && pair.left && pair.right.size < 1.5 * pair.left.size)
            return true;
        return false;
    }
    let filesToDo = validFiles.filter(pair => {
        return !isDone(pair);
        // if (!pair.left) return false;
        // if (!pair.right?.size) return true;
        // if (pair.right.size > 1.5 * (pair.left?.size ?? 0)) return true;
        // return false;
    });
    let doneFiles = validFiles.filter(e => {
        return isDone(e);
    });
    let total = filesToDo.length;
    let count = 0;
    let s = `files done: ${doneFiles.length}/${validFiles.length} (of ${doubleFilesAll.length}) (todo: ${filesToDo.length})    ${((leftTree?.size ?? 0) / 1e9).toFixed(3)} -> ${((rightTree?.size ?? 0) / 1e9).toFixed(3)} GB    ${DoubleTreeNode_1.rootSrc.exists(`${dir}/.delete`) ? 'DELETE' : ''}`;
    console.log(s, filesToDo);
    if (doneFiles.length == validFiles.length && doubleFilesAll.length) {
        DoubleTreeNode_1.rootSrc.file(`${dir}/.delete`, { content: s });
    }
    else {
        DoubleTreeNode_1.rootSrc.remove(`${dir}/.delete`);
    }
    // conversion:
    // for (let pair of doubleFiles) {
    // 	if (pair.extType == 'image') await copyImage(pair);
    // 	if (pair.extType == 'video') await copyVideo(pair);
    // 	if (pair.extType == 'other') await copyOther(pair);
    // 	if (pair.extType == 'ignored') await copyIgnored(pair);
    // }
    await pmap_1.PMap.pmap(filesToDo, async (pair) => {
        if (pair.extType == 'image')
            return copyImage(pair);
        if (pair.extType == 'video')
            return copyVideo(pair);
        if (pair.extType == 'other')
            return copyOther(pair);
        if (pair.extType == 'ignored')
            return copyIgnored(pair);
        console.log('what:', pair);
    }, { threads: 100, window: 10 });
    function logResult(updPair) {
        let f = (x) => ((x?.size ?? 0) / 1e6).toFixed(2).padStart(6);
        count++;
        let cs = count.toString().padStart(total.toString().length);
        let pc = (updPair.right?.size ?? 0) / (updPair.left?.size ?? 0);
        let sign = pc == 1 ? '==' : pc > 1.5 ? '<<' : pc > 1 ? '<' : '>';
        console.log(`${cs}/${total}       ${f(updPair.left)} ${sign}${f(updPair.right)} MB    ${updPair.path}`);
    }
    async function copyImage(pair) {
        let updPair = await pair.makeSmallerImage();
        logResult(updPair);
        let pc = updPair.right.size / updPair.left.size;
        if (pc < 1.5) {
            console.log(`compress: ${((1 - pc) * 100).toFixed(2)}%   ${updPair.left.height} > ${updPair.right.height} px`);
        }
        else {
            console.log(`bad: x${pc.toFixed(2)}`);
            count--;
            DoubleTreeNode_1.rootSrc.copy(pair.leftPath, pair.rightPath, { overwrite: true });
            let updPair = await pair.makeCopy();
            logResult(updPair);
        }
    }
    async function copyVideo(pair) {
        let updPair = await pair.makeHardlink();
        logResult(updPair);
    }
    async function copyOther(pair) {
        let updPair = await pair.makeHardlink();
        logResult(updPair);
    }
    async function copyIgnored(pair) {
        logResult(pair);
    }
}
void async function () {
    // let folders = ['dl']
    for (let f of DoubleTreeNode_1.folders) {
        await convertFolder(f);
    }
}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydE1rMi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NuaXBwZXRzL2NvbnZlcnRNazIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQSw0REFBaUM7QUFNakMsaUNBQThCO0FBQzlCLHFEQUF1RjtBQUN2RixtR0FBbUc7QUFFbkcsMEVBQTBFO0FBQzFFLDZCQUE2QjtBQUs3QixTQUFTLFVBQVUsQ0FBSSxJQUFPLEVBQUUsV0FBNkIsRUFBRSxPQUFZLEVBQUU7SUFDNUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoQixLQUFLLElBQUksQ0FBQyxJQUFJLFdBQVcsQ0FBQyxJQUFJLENBQUM7UUFBRSxVQUFVLENBQUMsQ0FBQyxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNsRSxPQUFPLElBQUksQ0FBQztBQUNiLENBQUM7QUFFRCxLQUFLLFVBQVUsYUFBYSxDQUFDLEdBQVc7SUFFdkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsR0FBRyxFQUFFLENBQUMsQ0FBQTtJQUNwQyxPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEVBQUUsQ0FBQyxDQUFBO0lBQ3JDLElBQUksd0JBQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxFQUFFO1FBQ2pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDdEMsT0FBTztLQUNQO0lBQ0QsSUFBSSxJQUFJLEdBQUcsTUFBTSxJQUFJLCtCQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekMsSUFBSSxRQUFRLEdBQUcsb0JBQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBRSxDQUFDO0lBQzNFLElBQUksU0FBUyxHQUFHLG9CQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUs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bmltcG9ydCBqZXRwYWNrIGZyb20gJ2ZzLWpldHBhY2snO1xyXG5pbXBvcnQgc2hhcnAgZnJvbSAnc2hhcnAnO1xyXG5pbXBvcnQgaXNpemUgZnJvbSAncHJvYmUtaW1hZ2Utc2l6ZSc7XHJcbmltcG9ydCB7IEZTSmV0cGFjaywgSW5zcGVjdFJlc3VsdCwgSW5zcGVjdFRyZWVSZXN1bHQgfSBmcm9tICdmcy1qZXRwYWNrL3R5cGVzJztcclxuaW1wb3J0IHsgYXJndiB9IGZyb20gJ3Byb2Nlc3MnO1xyXG5cclxuaW1wb3J0IHsgUE1hcCB9IGZyb20gJy4vcG1hcCc7XHJcbmltcG9ydCB7IERvdWJsZVRyZWVOb2RlLCBEb3VibGVUcmVlU3Vibm9kZSwgZm9sZGVycywgcm9vdFNyYyB9IGZyb20gJy4vRG91YmxlVHJlZU5vZGUnO1xyXG4vLyBsZXQgcGF0aCA9IFwiQzovVXNlcnMvRGltYXZhL0Rlc2t0b3AvcHJvamVjdHMvQHNlYW1sZXNzL2Rpc3QvaW1nLXNyYy9kbC8xNjQ0NDE0NjY2MTkyMjg5ODk1LnBuZ1wiO1xyXG5cclxuLy8gbGV0IGRpciA9ICdDOi9Vc2Vycy9EaW1hdmEvRGVza3RvcC9wcm9qZWN0cy9Ac2VhbWxlc3MvZGlzdC9pbWctc3JjL2RsJztcclxuLy8gbGV0IGpwID0gamV0cGFjay5jd2QoZGlyKTtcclxuXHJcblxyXG5cclxuXHJcbmZ1bmN0aW9uIGRlZXBUb0xpc3Q8VD4obm9kZTogVCwgZ2V0Q2hpbGRyZW46ICh0cmVlOiBUKSA9PiBUW10sIGxpc3Q6IFRbXSA9IFtdKTogVFtdIHtcclxuXHRsaXN0LnB1c2gobm9kZSk7XHJcblx0Zm9yIChsZXQgYyBvZiBnZXRDaGlsZHJlbihub2RlKSkgZGVlcFRvTGlzdChjLCBnZXRDaGlsZHJlbiwgbGlzdCk7XHJcblx0cmV0dXJuIGxpc3Q7XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGNvbnZlcnRGb2xkZXIoZGlyOiBzdHJpbmcpIHtcclxuXHJcblx0Y29uc29sZS5sb2coYGJ1aWxkaW5nIHRyZWU6ICR7ZGlyfWApXHJcblx0Y29uc29sZS50aW1lKGBidWlsZGluZyB0cmVlOiAke2Rpcn1gKVxyXG5cdGlmIChyb290U3JjLmV4aXN0cyhkaXIpICE9ICdkaXInKSB7XHJcblx0XHRjb25zb2xlLmxvZyhgZG9lcyBub3QgZXhpc3Q6ICR7ZGlyfWApO1xyXG5cdFx0cmV0dXJuO1xyXG5cdH1cclxuXHRsZXQgdHJlZSA9IGF3YWl0IG5ldyBEb3VibGVUcmVlTm9kZShkaXIpO1xyXG5cdGxldCBsZWZ0VHJlZSA9IGpldHBhY2suaW5zcGVjdFRyZWUodHJlZS5sZWZ0UGF0aCwgeyBzeW1saW5rczogJ2ZvbGxvdycgfSkhO1xyXG5cdGxldCByaWdodFRyZWUgPSBqZXRwYWNrLmluc3BlY3RUcmVlKHRyZWUucmlnaHRQYXRoLCB7IHN5bWxpbmtzOiAnZm9sbG93JyB9KSE7XHJcblx0aWYgKE1hdGguYWJzKGxlZnRUcmVlLnNpemUgLSByaWdodFRyZWUuc2l6ZSkgPCAxZTYpIHtcclxuXHRcdGNvbnNvbGUubG9nKGBzYW1lIHNpemU6ICR7ZGlyfSAgKCR7bGVmdFRyZWUuc2l6ZSAtIHJpZ2h0VHJlZS5zaXplfSlgKTtcclxuXHRcdHJldHVybjtcclxuXHR9XHJcblxyXG5cdGNvbnNvbGUudGltZUVuZChgYnVpbGRpbmcgdHJlZTogJHtkaXJ9YClcclxuXHJcblx0bGV0IGRvdWJsZUZpbGVzQWxsID0gZGVlcFRvTGlzdCh0cmVlLCBlID0+IGUuY2hpbGRyZW4gPz8gW10pLmZpbHRlcihlID0+IGUudHlwZSA9PSAnZmlsZScpO1xyXG5cdGxldCB2YWxpZEZpbGVzID0gZG91YmxlRmlsZXNBbGwuZmlsdGVyKHBhaXIgPT4ge1xyXG5cdFx0aWYgKCFwYWlyLmxlZnQpIHJldHVybiBmYWxzZTtcclxuXHRcdGlmIChwYWlyLmV4dFR5cGUgPT0gJ2lnbm9yZWQnKSByZXR1cm4gZmFsc2U7XHJcblx0XHRyZXR1cm4gdHJ1ZTtcclxuXHR9KTtcclxuXHQvLyBjb25zb2xlLmxvZyhkb3VibGVGaWxlcyk7XHJcblx0Ly8gY29uc29sZS5sb2coZG91YmxlRmlsZXMuZmlsdGVyKGUgPT4gZS5sZWZ0ICYmICFlLnJpZ2h0KSlcclxuXHQvLyBjb25zb2xlLmxvZyhkb3VibGVGaWxlcy5maWx0ZXIoZSA9PiAhZS5sZWZ0ICYmIGUucmlnaHQpKVxyXG5cdC8vIGNvbnNvbGUubG9nKGRvdWJsZUZpbGVzLmZpbHRlcihlID0+ICFlLmxlZnQ/LndpZHRoICYmICF2aWRlb1R5cGVzLmluY2x1ZGVzKGUuZXh0KSkpXHJcblx0ZnVuY3Rpb24gaXNEb25lKHBhaXI6IERvdWJsZVRyZWVOb2RlKSB7XHJcblx0XHRpZiAocGFpci5pc0hhcmRMaW5rKSByZXR1cm4gdHJ1ZTtcclxuXHRcdGlmICghcGFpci5sZWZ0KSByZXR1cm4gdHJ1ZTtcclxuXHRcdGlmIChwYWlyLnJpZ2h0ICYmIHBhaXIubGVmdCAmJiBwYWlyLnJpZ2h0LnNpemUgPCAxLjUgKiBwYWlyLmxlZnQuc2l6ZSkgcmV0dXJuIHRydWU7XHJcblx0XHRyZXR1cm4gZmFsc2U7XHJcblx0fVxyXG5cclxuXHJcblx0bGV0IGZpbGVzVG9EbyA9IHZhbGlkRmlsZXMuZmlsdGVyKHBhaXIgPT4ge1xyXG5cdFx0cmV0dXJuICFpc0RvbmUocGFpcik7XHJcblx0XHQvLyBpZiAoIXBhaXIubGVmdCkgcmV0dXJuIGZhbHNlO1xyXG5cdFx0Ly8gaWYgKCFwYWlyLnJpZ2h0Py5zaXplKSByZXR1cm4gdHJ1ZTtcclxuXHRcdC8vIGlmIChwYWlyLnJpZ2h0LnNpemUgPiAxLjUgKiAocGFpci5sZWZ0Py5zaXplID8/IDApKSByZXR1cm4gdHJ1ZTtcclxuXHRcdC8vIHJldHVybiBmYWxzZTtcclxuXHR9KTtcclxuXHRsZXQgZG9uZUZpbGVzID0gdmFsaWRGaWxlcy5maWx0ZXIoZSA9PiB7XHJcblx0XHRyZXR1cm4gaXNEb25lKGUpO1xyXG5cdH0pXHJcblxyXG5cdGxldCB0b3RhbCA9IGZpbGVzVG9Eby5sZW5ndGg7XHJcblx0bGV0IGNvdW50ID0gMDtcclxuXHJcblx0bGV0IHMgPSBgZmlsZXMgZG9uZTogJHtkb25lRmlsZXMubGVuZ3RofS8ke3ZhbGlkRmlsZXMubGVuZ3RofSAob2YgJHtkb3VibGVGaWxlc0FsbC5sZW5ndGh9KSAodG9kbzogJHtmaWxlc1RvRG8ubGVuZ3RoXHJcblx0XHR9KSAgICAkeygobGVmdFRyZWU/LnNpemUgPz8gMCkgLyAxZTkpLnRvRml4ZWQoMyl9IC0+ICR7KChyaWdodFRyZWU/LnNpemUgPz8gMCkgLyAxZTkpLnRvRml4ZWQoMyl9IEdCICAgICR7cm9vdFNyYy5leGlzdHMoYCR7ZGlyfS8uZGVsZXRlYCkgPyAnREVMRVRFJyA6ICcnfWA7XHJcblx0Y29uc29sZS5sb2cocywgZmlsZXNUb0RvKTtcclxuXHRpZiAoZG9uZUZpbGVzLmxlbmd0aCA9PSB2YWxpZEZpbGVzLmxlbmd0aCAmJiBkb3VibGVGaWxlc0FsbC5sZW5ndGgpIHtcclxuXHRcdHJvb3RTcmMuZmlsZShgJHtkaXJ9Ly5kZWxldGVgLCB7IGNvbnRlbnQ6IHMgfSk7XHJcblx0fSBlbHNlIHtcclxuXHRcdHJvb3RTcmMucmVtb3ZlKGAke2Rpcn0vLmRlbGV0ZWApO1xyXG5cdH1cclxuXHQvLyBjb252ZXJzaW9uOlxyXG5cdC8vIGZvciAobGV0IHBhaXIgb2YgZG91YmxlRmlsZXMpIHtcclxuXHQvLyBcdGlmIChwYWlyLmV4dFR5cGUgPT0gJ2ltYWdlJykgYXdhaXQgY29weUltYWdlKHBhaXIpO1xyXG5cdC8vIFx0aWYgKHBhaXIuZXh0VHlwZSA9PSAndmlkZW8nKSBhd2FpdCBjb3B5VmlkZW8ocGFpcik7XHJcblx0Ly8gXHRpZiAocGFpci5leHRUeXBlID09ICdvdGhlcicpIGF3YWl0IGNvcHlPdGhlcihwYWlyKTtcclxuXHQvLyBcdGlmIChwYWlyLmV4dFR5cGUgPT0gJ2lnbm9yZWQnKSBhd2FpdCBjb3B5SWdub3JlZChwYWlyKTtcclxuXHQvLyB9XHJcblx0YXdhaXQgUE1hcC5wbWFwKGZpbGVzVG9EbywgYXN5bmMgcGFpciA9PiB7XHJcblx0XHRpZiAocGFpci5leHRUeXBlID09ICdpbWFnZScpIHJldHVybiBjb3B5SW1hZ2UocGFpcik7XHJcblx0XHRpZiAocGFpci5leHRUeXBlID09ICd2aWRlbycpIHJldHVybiBjb3B5VmlkZW8ocGFpcik7XHJcblx0XHRpZiAocGFpci5leHRUeXBlID09ICdvdGhlcicpIHJldHVybiBjb3B5T3RoZXIocGFpcik7XHJcblx0XHRpZiAocGFpci5leHRUeXBlID09ICdpZ25vcmVkJykgcmV0dXJuIGNvcHlJZ25vcmVkKHBhaXIpO1xyXG5cdFx0Y29uc29sZS5sb2coJ3doYXQ6JywgcGFpcik7XHJcblx0fSwgeyB0aHJlYWRzOiAxMDAsIHdpbmRvdzogMTAgfSk7XHJcblxyXG5cclxuXHRmdW5jdGlvbiBsb2dSZXN1bHQodXBkUGFpcjogRG91YmxlVHJlZU5vZGUpIHtcclxuXHRcdGxldCBmID0gKHg/OiBEb3VibGVUcmVlU3Vibm9kZSkgPT4gKCh4Py5zaXplID8/IDApIC8gMWU2KS50b0ZpeGVkKDIpLnBhZFN0YXJ0KDYpO1xyXG5cdFx0Y291bnQrKztcclxuXHRcdGxldCBjcyA9IGNvdW50LnRvU3RyaW5nKCkucGFkU3RhcnQodG90YWwudG9TdHJpbmcoKS5sZW5ndGgpO1xyXG5cdFx0bGV0IHBjID0gKHVwZFBhaXIucmlnaHQ/LnNpemUgPz8gMCkgLyAodXBkUGFpci5sZWZ0Py5zaXplID8/IDApO1xyXG5cdFx0bGV0IHNpZ24gPSBwYyA9PSAxID8gJz09JyA6IHBjID4gMS41ID8gJzw8JyA6IHBjID4gMSA/ICc8JyA6ICc+JztcclxuXHRcdGNvbnNvbGUubG9nKGAke2NzfS8ke3RvdGFsfSAgICAgICAke2YodXBkUGFpci5sZWZ0KX0gJHtzaWdufSR7Zih1cGRQYWlyLnJpZ2h0KX0gTUIgICAgJHt1cGRQYWlyLnBhdGh9YCk7XHJcblx0fVxyXG5cclxuXHRhc3luYyBmdW5jdGlvbiBjb3B5SW1hZ2UocGFpcjogRG91YmxlVHJlZU5vZGUpIHtcclxuXHRcdGxldCB1cGRQYWlyID0gYXdhaXQgcGFpci5tYWtlU21hbGxlckltYWdlKCk7XHJcblx0XHRsb2dSZXN1bHQodXBkUGFpcik7XHJcblx0XHRsZXQgcGMgPSB1cGRQYWlyLnJpZ2h0IS5zaXplIC8gdXBkUGFpci5sZWZ0IS5zaXplO1xyXG5cdFx0aWYgKHBjIDwgMS41KSB7XHJcblx0XHRcdGNvbnNvbGUubG9nKGBjb21wcmVzczogJHsoKDEgLSBwYykgKiAxMDApLnRvRml4ZWQoMil9JSAgICR7dXBkUGFpci5sZWZ0IS5oZWlnaHR9ID4gJHt1cGRQYWlyLnJpZ2h0IS5oZWlnaHR9IHB4YCk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRjb25zb2xlLmxvZyhgYmFkOiB4JHtwYy50b0ZpeGVkKDIpfWApO1xyXG5cdFx0XHRjb3VudC0tO1xyXG5cdFx0XHRyb290U3JjLmNvcHkocGFpci5sZWZ0UGF0aCwgcGFpci5yaWdodFBhdGgsIHsgb3ZlcndyaXRlOiB0cnVlIH0pO1xyXG5cdFx0XHRsZXQgdXBkUGFpciA9IGF3YWl0IHBhaXIubWFrZUNvcHkoKTtcclxuXHRcdFx0bG9nUmVzdWx0KHVwZFBhaXIpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHRhc3luYyBmdW5jdGlvbiBjb3B5VmlkZW8ocGFpcjogRG91YmxlVHJlZU5vZGUpIHtcclxuXHRcdGxldCB1cGRQYWlyID0gYXdhaXQgcGFpci5tYWtlSGFyZGxpbmsoKTtcclxuXHRcdGxvZ1Jlc3VsdCh1cGRQYWlyKTtcclxuXHR9XHJcblx0YXN5bmMgZnVuY3Rpb24gY29weU90aGVyKHBhaXI6IERvdWJsZVRyZWVOb2RlKSB7XHJcblx0XHRsZXQgdXBkUGFpciA9IGF3YWl0IHBhaXIubWFrZUhhcmRsaW5rKCk7XHJcblx0XHRsb2dSZXN1bHQodXBkUGFpcik7XHJcblx0fVxyXG5cdGFzeW5jIGZ1bmN0aW9uIGNvcHlJZ25vcmVkKHBhaXI6IERvdWJsZVRyZWVOb2RlKSB7XHJcblx0XHRsb2dSZXN1bHQocGFpcik7XHJcblx0fVxyXG5cclxufVxyXG52b2lkIGFzeW5jIGZ1bmN0aW9uICgpIHtcclxuXHQvLyBsZXQgZm9sZGVycyA9IFsnZGwnXVxyXG5cdGZvciAobGV0IGYgb2YgZm9sZGVycykge1xyXG5cdFx0YXdhaXQgY29udmVydEZvbGRlcihmKTtcclxuXHR9XHJcbn0oKTtcclxuIl19